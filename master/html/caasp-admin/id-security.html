<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang=""><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>Security | Administration Guide | SUSE CaaS Platform 4.5.2</title><meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" /><link rel="stylesheet" type="text/css" href="static/css/style.css" /><link rel="stylesheet" type="text/css" href="static/css/highlight.css" /><meta name="generator" content="DAPS 3.2.0 (https://opensuse.github.io/daps) using SUSE XSL Stylesheets 2.81.0 (based on DocBook XSL Stylesheets 1.79.2) - chunked" /><meta name="product-name" content="SUSE CaaS Platform" /><meta name="product-number" content="4.5.2" /><meta name="book-title" content="Administration Guide" /><meta name="chapter-title" content="Chapter 6. Security" /><meta name="description" content="It is good security practice not to expose the kubernetes API server on the public internet. Use network firewalls that only allow access from trusted subnets." /><meta name="tracker-url" content="https://github.com/SUSE/doc-caasp/issues/new" /><meta name="tracker-type" content="gh" /><meta name="tracker-gh-labels" content="AdminGuide" /><link rel="home" href="index.html" title="Administration Guide" /><link rel="up" href="index.html" title="Administration Guide" /><link rel="prev" href="id-upgrading-suse-caas-platform.html" title="Chapter 5. Upgrading SUSE CaaS Platform" /><link rel="next" href="id-logging.html" title="Chapter 7. Logging" />
<script type="text/javascript">

if ( window.location.protocol.toLowerCase() != 'file:' ) {
  document.write('<link rel="stylesheet" type="text/css" href="https://static.opensuse.org/fonts/fonts.css"></link>');
}
else {
  document.write('<link rel="stylesheet" type="text/css" href="static/css/fonts-onlylocal.css"></link>');
}

</script><noscript><link rel="stylesheet" type="text/css" href="https://static.opensuse.org/fonts/fonts.css" /></noscript><script src="static/js/jquery-1.10.2.min.js" type="text/javascript"></script><script src="static/js/script.js" type="text/javascript"></script><script src="static/js/highlight.min.js" type="text/javascript"></script><script>

$(document).ready(function() {
  $('.verbatim-wrap.highlight').each(function(i, block) {
    hljs.highlightBlock(block);
  });
});
hljs.configure({
  useBR: false
});

</script></head><body class="draft offline js-off" onload="$('#betawarn-button-wrap').toggle();if (document.cookie.length > 0) {if (document.cookie.indexOf('betawarn=closed') != -1){$('#betawarn').toggle()}};"><div id="betawarn" style="position:fixed;bottom:0;z-index:9025;background-color:#FDE8E8;padding:1em;margin-left:10%;margin-right:10%;display:block;border-top:.75em solid #E11;width:80%"><p style="color:#333;margin:1em 0;padding:0;">This is a draft document that was built and uploaded automatically. It may document beta software and be incomplete or even incorrect. <strong>Use this document at your own risk.</strong></p> <div id="betawarn-button-wrap" style="display:none;margin:0;padding:0;"><a href="#" onclick="$('#betawarn').toggle();var d=new Date();d.setTime(d.getTime()+(0.5*24*60*60*1000));document.cookie='betawarn=closed; expires='+d.toUTCString()+'; path=/'; return false;" style="color:#333;text-decoration:underline;float:left;margin-top:.5em;padding:1em;display:block;background-color:#FABEBE;">I understand this is a draft</a></div></div><div class="bypass-block"><a href="#_content">Jump to content</a><a href="#_bottom-navigation">Jump to page navigation: previous page [access key p]/next page [access key n]</a></div><div id="_outer-wrap"><div id="_white-bg" style="background-color: #E11;"><div id="_header"><div id="_logo"><img src="static/images/logo.png" alt="Logo" /></div><div class="crumbs"><a class="book-link" href="index.html" title="Administration Guide"><span class="book-icon">Administration Guide</span></a><span> › </span><a class="crumb" href="id-security.html">Security</a></div><div class="clearme"></div></div></div><div id="_toolbar-wrap"><div id="_toolbar"><div id="_toc-area" class="inactive"><a id="_toc-area-button" class="tool" title="Contents" accesskey="c" href="index.html"><span class="tool-spacer"><span class="toc-icon">Contents</span><span class="clearme"></span></span><span class="tool-label">Contents</span></a><div class="active-contents bubble-corner"></div><div class="active-contents bubble"><div class="bubble-container"><h6>Administration Guide</h6><div id="_bubble-toc"><ol><li class="inactive"><a href="pr01.html"><span class="number"> </span><span class="name"></span></a></li><li class="inactive"><a href="id-about-this-guide.html"><span class="number">1 </span><span class="name">About This Guide</span></a></li><li class="inactive"><a href="id-cluster-management.html"><span class="number">2 </span><span class="name">Cluster Management</span></a></li><li class="inactive"><a href="id-software-management.html"><span class="number">3 </span><span class="name">Software Management</span></a></li><li class="inactive"><a href="id-cluster-updates.html"><span class="number">4 </span><span class="name">Cluster Updates</span></a></li><li class="inactive"><a href="id-upgrading-suse-caas-platform.html"><span class="number">5 </span><span class="name">Upgrading SUSE CaaS Platform</span></a></li><li class="inactive"><a href="id-security.html"><span class="number">6 </span><span class="name">Security</span></a></li><li class="inactive"><a href="id-logging.html"><span class="number">7 </span><span class="name">Logging</span></a></li><li class="inactive"><a href="id-monitoring.html"><span class="number">8 </span><span class="name">Monitoring</span></a></li><li class="inactive"><a href="id-storage.html"><span class="number">9 </span><span class="name">Storage</span></a></li><li class="inactive"><a href="id-integration.html"><span class="number">10 </span><span class="name">Integration</span></a></li><li class="inactive"><a href="id-gpu-dependent-workloads.html"><span class="number">11 </span><span class="name">GPU-Dependent Workloads</span></a></li><li class="inactive"><a href="id-cluster-disaster-recovery.html"><span class="number">12 </span><span class="name">Cluster Disaster Recovery</span></a></li><li class="inactive"><a href="backup-and-restore-with-velero.html"><span class="number">13 </span><span class="name">Backup and Restore with Velero</span></a></li><li class="inactive"><a href="id-miscellaneous.html"><span class="number">14 </span><span class="name">Miscellaneous</span></a></li><li class="inactive"><a href="id-troubleshooting-3.html"><span class="number">15 </span><span class="name">Troubleshooting</span></a></li><li class="inactive"><a href="id-glossary.html"><span class="number">16 </span><span class="name">Glossary</span></a></li><li class="inactive"><a href="id-contributors.html"><span class="number">A </span><span class="name">Contributors</span></a></li><li class="inactive"><a href="id-gnu-licenses.html"><span class="number">B </span><span class="name">GNU Licenses</span></a></li></ol></div><div class="clearme"></div></div></div></div><div id="_nav-area" class="inactive"><div class="tool"><span class="nav-inner"><span class="tool-label">Navigation</span><a accesskey="p" class="tool-spacer" title="Chapter 5. Upgrading SUSE CaaS Platform" href="id-upgrading-suse-caas-platform.html"><span class="prev-icon">←</span></a><a accesskey="n" class="tool-spacer" title="Chapter 7. Logging" href="id-logging.html"><span class="next-icon">→</span></a></span></div></div></div></div><div id="_fixed-header-wrap" style="background-color: #E11;" class="inactive"><div id="_fixed-header"><div class="crumbs"><a class="book-link" href="index.html" title="Administration Guide"><span class="book-icon">Administration Guide</span></a><span> › </span><a class="crumb" href="id-security.html">Security</a></div><div class="buttons"><a class="top-button button" href="#">Top</a><div class="button"><a accesskey="p" class="tool-spacer" title="Chapter 5. Upgrading SUSE CaaS Platform" href="id-upgrading-suse-caas-platform.html"><span class="prev-icon">←</span></a><a accesskey="n" class="tool-spacer" title="Chapter 7. Logging" href="id-logging.html"><span class="next-icon">→</span></a></div><div class="clearme"></div></div><div class="clearme"></div></div></div><div id="_content" class="draft "><div class="documentation"><div class="chapter " id="id-security"><div class="titlepage"><div><div class="version-info">Applies to  <span class="productname ">SUSE CaaS Platform</span> <span class="productnumber ">4.5.2</span></div><div><h1 class="title"><span class="number">6 </span><span xmlns:dm="urn:x-suse:ns:docmanager" class="name">Security</span> <a title="Permalink" class="permalink" href="id-security.html#">#</a></h1></div></div></div><div class="line"><div class="toc"><dl><dt><span class="section"><a href="id-security.html#id-network-access-considerations"><span class="number">6.1 </span><span class="name">Network Access Considerations</span></a></span></dt><dt><span class="section"><a href="id-security.html#id-access-control"><span class="number">6.2 </span><span class="name">Access Control</span></a></span></dt><dt><span class="section"><a href="id-security.html#authentication"><span class="number">6.3 </span><span class="name">Authentication</span></a></span></dt><dt><span class="section"><a href="id-security.html#sec-admin-security-users"><span class="number">6.4 </span><span class="name">Managing LDAP Users and Groups</span></a></span></dt><dt><span class="section"><a href="id-security.html#rbac"><span class="number">6.5 </span><span class="name">Role-Based Access Control (RBAC)</span></a></span></dt><dt><span class="section"><a href="id-security.html#admission"><span class="number">6.6 </span><span class="name">Admission Controllers</span></a></span></dt><dt><span class="section"><a href="id-security.html#id-pod-security-policies"><span class="number">6.7 </span><span class="name">Pod Security Policies</span></a></span></dt><dt><span class="section"><a href="id-security.html#nginx-ingress"><span class="number">6.8 </span><span class="name">NGINX Ingress Controller</span></a></span></dt><dt><span class="section"><a href="id-security.html#id-certificates"><span class="number">6.9 </span><span class="name">Certificates</span></a></span></dt></dl></div></div><div class="sect1" id="id-network-access-considerations"><div class="titlepage"><div><div><h2 class="title"><span class="number">6.1 </span><span xmlns:dm="urn:x-suse:ns:docmanager" class="name">Network Access Considerations</span> <a title="Permalink" class="permalink" href="id-security.html#id-network-access-considerations">#</a></h2></div></div></div><p>It is good security practice not to expose the kubernetes API server on the public internet.
Use network firewalls that only allow access from trusted subnets.</p></div><div class="sect1" id="id-access-control"><div class="titlepage"><div><div><h2 class="title"><span class="number">6.2 </span><span xmlns:dm="urn:x-suse:ns:docmanager" class="name">Access Control</span> <a title="Permalink" class="permalink" href="id-security.html#id-access-control">#</a></h2></div></div></div><p>Users access the API using <code class="literal">kubectl</code>, client libraries, or by making REST requests.
Both human users and Kubernetes service accounts can be authorized for API access.
When a request reaches the API, it goes through several stages, that can be explained with the following three questions:</p><div class="orderedlist "><ol class="orderedlist" type="1"><li class="listitem "><p>Authentication: <span class="strong"><strong>who are you?</strong></span> This is accomplished via <a class="xref" href="id-security.html#authentication" title="6.3. Authentication">Section 6.3, “Authentication”</a> to validate the user’s entity and respond to the corresponding user group after successful login.</p></li><li class="listitem "><p>Authorization: <span class="strong"><strong>what kind of access do you have?</strong></span> This is accomplished via <a class="xref" href="id-security.html#rbac" title="6.5. Role-Based Access Control (RBAC)">Section 6.5, “Role-Based Access Control (RBAC)”</a> API, that is a set of permissions for the previously authenticated user. Permissions are purely additive (there are no "deny" rules). A role can be defined within a namespace with a Role, or cluster-wide with a ClusterRole.</p></li><li class="listitem "><p>Admission Control: <span class="strong"><strong>what are you trying to do?</strong></span> This is accomplished via <a class="xref" href="id-security.html#admission" title="6.6. Admission Controllers">Section 6.6, “Admission Controllers”</a>. They can modify (mutate) or validate (accept or reject) requests.</p></li></ol></div><p>Unlike authentication and authorization, if any admission controller rejects, then the request is immediately rejected.</p><p>Users can access with a Web browser or command line to do the authentication or self-configure <code class="literal">kubectl</code> to access authorized resources.</p><div class="sect2" id="id-authentication-and-authorization-flow"><div class="titlepage"><div><div><h3 class="title"><span class="number">6.2.1 </span><span xmlns:dm="urn:x-suse:ns:docmanager" class="name">Authentication and Authorization Flow</span> <a title="Permalink" class="permalink" href="id-security.html#id-authentication-and-authorization-flow">#</a></h3></div></div></div><p>Authentication is composed of:</p><div class="itemizedlist "><ul class="itemizedlist"><li class="listitem "><p><span class="strong"><strong>Dex</strong></span> (<a class="link" href="https://github.com/dexidp/dex" target="_blank">https://github.com/dexidp/dex</a>) is an identity provider service
(idP) that uses OIDC (Open ID Connect: <a class="link" href="https://openid.net/connect/" target="_blank">https://openid.net/connect/</a>)
to drive authentication for client applications.
It acts as a portal to defer authentication to the provider through connected
identity providers (connectors).</p></li><li class="listitem "><p><span class="strong"><strong>Client</strong></span>:</p><div class="orderedlist "><ol class="orderedlist" type="1"><li class="listitem "><p>Web browser: <span class="strong"><strong>Gangway</strong></span> (<a class="link" href="https://github.com/heptiolabs/gangway" target="_blank">https://github.com/heptiolabs/gangway</a>):
a Web application that enables authentication flow for your SUSE CaaS Platform.
The user can log in, authorize access, download <code class="literal">kubeconfig</code>, or self-configure <code class="literal">kubectl</code>.</p></li><li class="listitem "><p>Command-line: <code class="literal">skuba auth login</code>, a CLI application that enables authentication flow for your SUSE CaaS Platform. The user can log in, authorize access, and get <code class="literal">kubeconfig</code>.</p></li></ol></div></li></ul></div><p>For authorization (Role-Based Access Control, RBAC), administrators can use <code class="literal">kubectl</code> to create corresponding
<code class="literal">RoleBinding</code> or <code class="literal">ClusterRoleBinding</code> for a user or group to limit resource access.</p><div class="sect3" id="id-web-flow"><div class="titlepage"><div><div><h4 class="title"><span class="number">6.2.1.1 </span><span xmlns:dm="urn:x-suse:ns:docmanager" class="name">Web Flow</span> <a title="Permalink" class="permalink" href="id-security.html#id-web-flow">#</a></h4></div></div></div><div class="informalfigure"><div class="mediaobject"><a xmlns="" href="images/oidc_flow_web.png" target="_blank"><img src="images/oidc_flow_web.png" width="" alt="oidc flow web" /></a></div></div><div class="orderedlist "><ol class="orderedlist" type="1"><li class="listitem "><p>The user requests access through Gangway.</p></li><li class="listitem "><p>Gangway redirects to Dex.</p></li><li class="listitem "><p>Dex redirects to a connected identity provider (connector).
User login and a request to approve access are generated.</p></li><li class="listitem "><p>Dex continues with OIDC authentication flow on behalf of the user
and creates/updates data to Kubernetes CRDs.</p></li><li class="listitem "><p>Dex redirects the user to Gangway.
This redirect includes (ID/refresh) tokens.</p></li><li class="listitem "><p>Gangway returns a link to download <code class="literal">kubeconfig</code> or self-configures <code class="literal">kubectl</code>
instructions to the user.</p><div class="informalfigure"><div class="mediaobject"><a xmlns="" href="images/rbac-configure-kubectl.png" target="_blank"><img src="images/rbac-configure-kubectl.png" width="" alt="rbac configure kubectl" /></a></div></div></li><li class="listitem "><p>User downloads <code class="literal">kubeconf</code> or self-configures <code class="literal">kubectl</code>.</p></li><li class="listitem "><p>User uses <code class="literal">kubectl</code> to connect to the Kubernetes API server.</p></li><li class="listitem "><p>Kubernetes CRDs validate the Kubernetes API server request and return a response.</p></li><li class="listitem "><p>The <code class="literal">kubectl</code> connects to the authorized Kubernetes resources through the Kubernetes API server.</p></li></ol></div></div><div class="sect3" id="id-cli-flow"><div class="titlepage"><div><div><h4 class="title"><span class="number">6.2.1.2 </span><span xmlns:dm="urn:x-suse:ns:docmanager" class="name">CLI Flow</span> <a title="Permalink" class="permalink" href="id-security.html#id-cli-flow">#</a></h4></div></div></div><div class="informalfigure"><div class="mediaobject"><a xmlns="" href="images/oidc_flow_cli.png" target="_blank"><img src="images/oidc_flow_cli.png" width="" alt="oidc flow cli" /></a></div></div><div class="orderedlist "><ol class="orderedlist" type="1"><li class="listitem "><p>User requests access through <code class="literal">skuba auth login</code> with the Dex server URL,
username and password.</p></li><li class="listitem "><p>Dex uses received username and password to log in and approve the access
request to the connected identity providers (connectors).</p></li><li class="listitem "><p>Dex continues with the OIDC authentication flow on behalf of the user and
creates/updates data to the Kubernetes CRDs.</p></li><li class="listitem "><p>Dex returns the ID token and refreshes token to <code class="literal">skuba auth login</code>.</p></li><li class="listitem "><p><code class="literal">skuba auth login</code> generates the kubeconfig file <code class="literal">kubeconf.txt</code>.</p></li><li class="listitem "><p>User uses <code class="literal">kubectl</code> to connect the Kubernetes API server.</p></li><li class="listitem "><p>Kubernetes CRDs validate the Kubernetes API server request and return a response.</p></li><li class="listitem "><p>The <code class="literal">kubectl</code> connects to the authorized Kubernetes resources through Kubernetes API server.</p></li></ol></div></div></div></div><div class="sect1" id="authentication"><div class="titlepage"><div><div><h2 class="title"><span class="number">6.3 </span><span xmlns:dm="urn:x-suse:ns:docmanager" class="name">Authentication</span> <a title="Permalink" class="permalink" href="id-security.html#authentication">#</a></h2></div></div></div><p>SUSE CaaS Platform supports user authentication via an external LDAP server like "389 Directory Server" (389-ds)
and "Active Directory" by updating the built-in Dex LDAP connector configuration, the administrators can update
LDAP identity providers before or after platform deployment.</p><div class="sect2" id="id-deploying-an-external-ldap-server"><div class="titlepage"><div><div><h3 class="title"><span class="number">6.3.1 </span><span xmlns:dm="urn:x-suse:ns:docmanager" class="name">Deploying an External LDAP Server</span> <a title="Permalink" class="permalink" href="id-security.html#id-deploying-an-external-ldap-server">#</a></h3></div></div></div><p>If you already have an existed LDAP server, you could skip this part.</p><div class="itemizedlist "><ul class="itemizedlist"><li class="listitem "><p>Deploying an External 389 Directory Server</p><p>The 389 Directory Server image <code class="literal">registry.suse.com/caasp/v4.5/389-ds:1.4.3</code>
will <span class="strong"><strong>automatically generate a self-signed certificate</strong></span> and key.
The following instructions show how to deploy the "389 Directory Server"
with a customized configuration using container commands.</p><div class="orderedlist "><ol class="orderedlist" type="1"><li class="listitem "><p>Prepare the customized 389 Directory configuration and enter it
into the terminal in the following format:</p><div class="verbatim-wrap"><pre class="screen">DS_DM_PASSWORD=                                 # Admin Password
DS_SUFFIX="dc=example,dc=org"                   # Domain Suffix
DATA_DIR=&lt;PWD&gt;/389_ds_data                      # Directory Server Data on Host Machine to Mount</pre></div></li><li class="listitem "><p>Execute the following command to deploy 389-ds in the same terminal.
This will start a non-TLS port (<code class="literal">389</code>) and a TLS port (<code class="literal">636</code>) together with an
automatically self-signed certificate and key.</p><div class="verbatim-wrap"><pre class="screen">docker run -d \
-p 389:3389 \
-p 636:3636 \
-e DS_DM_PASSWORD=&lt;DS_DM_PASSWORD&gt; \
-e DS_SUFFIX=&lt;DS_SUFFIX&gt; \
-v &lt;DATA_DIR&gt;:/data \
--name 389-ds registry.suse.com/caasp/v4.5/389-ds:1.4.3</pre></div></li></ol></div></li><li class="listitem "><p>Deploying an External 389 Directory Server with an External Certificate</p><p>To replace the automatically generated certificate with your own, follow these steps:</p><div class="orderedlist "><ol class="orderedlist" type="1"><li class="listitem "><p>Stop the running container:</p><div class="verbatim-wrap"><pre class="screen">docker stop 389-ds</pre></div></li><li class="listitem "><p>Copy the external certificate <code class="literal">ca.cert</code> and <code class="literal">pwdfile.txt</code> to a mounted data directory <code class="literal">&lt;DATA_DIR&gt;/ssca/</code>.</p><div class="itemizedlist "><ul class="itemizedlist"><li class="listitem "><p><code class="literal">ca.cert</code>: CA Certificate.</p></li><li class="listitem "><p><code class="literal">pwdfile.txt</code>: Password for the CA Certificate.</p></li></ul></div></li><li class="listitem "><p>Copy the external certificate <code class="literal">Server-Cert-Key.pem</code>, <code class="literal">Server-Cert.crt</code>, and <code class="literal">pwdfile-import.txt</code> to a mounted data directory <code class="literal">&lt;DATA_DIR&gt;/config/</code>.</p><div class="itemizedlist "><ul class="itemizedlist"><li class="listitem "><p><code class="literal">Server-Cert-Key.pem</code>: PRIVATE KEY.</p></li><li class="listitem "><p><code class="literal">Server-Cert.crt</code>: CERTIFICATE.</p></li><li class="listitem "><p><code class="literal">pwdfile-import.txt</code>: Password for the PRIVATE KEY.</p></li></ul></div></li><li class="listitem "><p>Execute the following command to run the 389 Directory Server with a mounted data
the directory from the previous step:</p><div class="verbatim-wrap"><pre class="screen">docker start 389-ds</pre></div></li></ol></div></li></ul></div><div id="id-1.8.4.3.4" class="admonition note normal"><img class="symbol" alt="Note" title="Note" src="static/images/icon-note.png" /><h6>Note: Known Issues</h6><p>The error message is a warning for 389-ds version <code class="literal">1.4.3</code> when replacing external certificates.</p><div class="verbatim-wrap"><pre class="screen">ERR - attrcrypt_cipher_init - No symmetric key found for cipher AES in backend exampleDB, attempting to create one...
INFO - attrcrypt_cipher_init - Key for cipher AES successfully generated and stored
ERR - attrcrypt_cipher_init - No symmetric key found for cipher 3DES in backend exampleDB, attempting to create one...
INFO - attrcrypt_cipher_init - Key for cipher 3DES successfully generated and stored</pre></div><p>It is due to the encrypted key being stored in the <code class="literal">dse.ldif</code>.
When replacing the key and certificate in <code class="literal">/data/config</code>, 389ds searches <code class="literal">dse.ldif</code> for symmetric key and create one if it does not exist.
389-ds developers are planning a fix that switches 389-ds to use the <code class="literal">nssdb</code> exclusively.</p></div></div><div class="sect2" id="id-examples-of-usage"><div class="titlepage"><div><div><h3 class="title"><span class="number">6.3.2 </span><span xmlns:dm="urn:x-suse:ns:docmanager" class="name">Examples of Usage</span> <a title="Permalink" class="permalink" href="id-security.html#id-examples-of-usage">#</a></h3></div></div></div><p>In both directories, <code class="literal">user-regular1</code> and <code class="literal">user-regular2</code> are members of the <code class="literal">k8s-users</code> group,
and <code class="literal">user-admin</code> is a member of the <code class="literal">k8s-admins</code> group.</p><p>In Active Directory, <code class="literal">user-bind</code> is a simple user that is a member of the default Domain Users group.
Hence, we can use it to authenticate, because it has read-only access to Active Directory.
The mail attribute is used to create the RBAC rules.</p><div class="sect3" id="id-389-directory-server"><div class="titlepage"><div><div><h4 class="title"><span class="number">6.3.2.1 </span><span xmlns:dm="urn:x-suse:ns:docmanager" class="name">389 Directory Server:</span> <a title="Permalink" class="permalink" href="id-security.html#id-389-directory-server">#</a></h4></div></div></div><div class="itemizedlist "><ul class="itemizedlist"><li class="listitem "><p>Example LDIF configuration to initialize LDAP using an LDAP command:</p><div class="informalexample"><div class="verbatim-wrap"><pre class="screen">dn: dc=example,dc=org
objectClass: top
objectClass: domain
dc: example</pre></div><div class="verbatim-wrap"><pre class="screen">dn: cn=Directory Administrators,dc=example,dc=org
objectClass: top
objectClass: groupofuniquenames
cn: Directory Administrators
uniqueMember: cn=Directory Manager</pre></div><div class="verbatim-wrap"><pre class="screen">dn: ou=Groups,dc=example,dc=org
objectClass: top
objectClass: organizationalunit
ou: Groups</pre></div><div class="verbatim-wrap"><pre class="screen">dn: ou=People,dc=example,dc=org
objectClass: top
objectClass: organizationalunit
ou: People</pre></div><div class="verbatim-wrap"><pre class="screen">dn: ou=Users,dc=example,dc=org
objectclass: top
objectclass: organizationalUnit
ou: Users</pre></div></div></li><li class="listitem "><p>Example LDIF configuration to configure ACL using an LDAP command:</p><div class="informalexample"><div class="verbatim-wrap"><pre class="screen">dn: dc=example,dc=org
changetype: modify
add: aci
aci: (targetattr!="userPassword || aci")(version 3.0; acl "Enable anonymous access"; allow (read, search, compare) userdn="ldap:///anyone";)
aci: (targetattr="carLicense || description || displayName || facsimileTelephoneNumber || homePhone || homePostalAddress || initials || jpegPhoto || labeledURI || mail || mobile || pager || photo || postOfficeBox || postalAddress || postalCode || preferredDeliveryMethod || preferredLanguage || registeredAddress || roomNumber || secretary || seeAlso || st || street || telephoneNumber || telexNumber || title || userCertificate || userPassword || userSMIMECertificate || x500UniqueIdentifier")(version 3.0; acl "Enable self write for common attributes"; allow (write) userdn="ldap:///self";)
aci: (targetattr ="*")(version 3.0;acl "Directory Administrators Group";allow (all) (groupdn = "ldap:///cn=Directory Administrators, dc=example,dc=org");)</pre></div></div></li><li class="listitem "><p>Example LDIF configuration to create user <code class="literal">user-regular1</code> using an LDAP command:</p><div class="informalexample"><div class="verbatim-wrap"><pre class="screen">dn: uid=user-regular1,ou=Users,dc=example,dc=org
changetype: add
uid: user-regular1
userPassword: SSHA_PASSWORD <span id="CO2-1"></span><span class="callout">1</span>
objectClass: posixaccount
objectClass: inetOrgPerson
objectClass: person
objectClass: inetUser
objectClass: organizationalPerson
uidNumber: 1200
gidNumber: 500
givenName: User
mail: user-regular1@example.org
sn: Regular1
homeDirectory: /home/regular1
cn: User Regular1</pre></div></div><div class="calloutlist "><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO2-1"><span class="callout">1</span></a> </p></td><td valign="top" align="left"><p>SSHA_PASSWORD: The user’s new hashed password.</p></td></tr></table></div><p>Use <code class="literal">/usr/sbin/slappasswd</code> to generate the SSHA hash.</p><div class="verbatim-wrap"><pre class="screen">/usr/sbin/slappasswd -h {SSHA} -s &lt;USER_PASSWORD&gt;</pre></div><p>Use <code class="literal">/usr/bin/pwdhash</code> to generate the SSHA hash.</p><div class="verbatim-wrap"><pre class="screen">/usr/bin/pwdhash -s SSHA &lt;USER_PASSWORD&gt;</pre></div></li><li class="listitem "><p>Example LDIF configuration to create user <code class="literal">user-regular2</code> using an LDAP command:</p><div class="informalexample"><div class="verbatim-wrap"><pre class="screen">dn: uid=user-regular2,ou=Users,dc=example,dc=org
changetype: add
uid: user-regular2
userPassword: SSHA_PASSWORD <span id="CO3-1"></span><span class="callout">1</span>
objectClass: posixaccount
objectClass: inetOrgPerson
objectClass: person
objectClass: inetUser
objectClass: organizationalPerson
uidNumber: 1300
gidNumber: 500
givenName: User
mail: user-regular2@example.org
sn: Regular1
homeDirectory: /home/regular2
cn: User Regular2</pre></div></div><div class="calloutlist "><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO3-1"><span class="callout">1</span></a> </p></td><td valign="top" align="left"><p>SSHA_PASSWORD: The user’s new hashed password.</p></td></tr></table></div><p>Use <code class="literal">/usr/sbin/slappasswd</code> to generate the SSHA hash.</p><div class="verbatim-wrap"><pre class="screen">/usr/sbin/slappasswd -h {SSHA} -s &lt;USER_PASSWORD&gt;</pre></div><p>Use <code class="literal">/usr/bin/pwdhash</code> to generate the SSHA hash.</p><div class="verbatim-wrap"><pre class="screen">/usr/bin/pwdhash -s SSHA &lt;USER_PASSWORD&gt;</pre></div></li><li class="listitem "><p>Example LDIF configuration to create user <code class="literal">user-admin</code> using an LDAP command:</p><div class="informalexample"><div class="verbatim-wrap"><pre class="screen">dn: uid=user-admin,ou=Users,dc=example,dc=org
changetype: add
uid: user-admin
userPassword: SSHA_PASSWORD <span id="CO4-1"></span><span class="callout">1</span>
objectClass: posixaccount
objectClass: inetOrgPerson
objectClass: person
objectClass: inetUser
objectClass: organizationalPerson
uidNumber: 1000
gidNumber: 100
givenName: User
mail: user-admin@example.org
sn: Admin
homeDirectory: /home/admin
cn: User Admin</pre></div></div><div class="calloutlist "><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO4-1"><span class="callout">1</span></a> </p></td><td valign="top" align="left"><p>SSHA_PASSWORD: The user’s new hashed password.</p></td></tr></table></div><p>Use <code class="literal">/usr/sbin/slappasswd</code> to generate the SSHA hash.</p><div class="verbatim-wrap"><pre class="screen">/usr/sbin/slappasswd -h {SSHA} -s &lt;USER_PASSWORD&gt;</pre></div><p>Use <code class="literal">/usr/bin/pwdhash</code> to generate the SSHA hash.</p><div class="verbatim-wrap"><pre class="screen">/usr/bin/pwdhash -s SSHA &lt;USER_PASSWORD&gt;</pre></div></li><li class="listitem "><p>Example LDIF configuration to create group <code class="literal">k8s-users</code> using an LDAP command:</p><div class="informalexample"><div class="verbatim-wrap"><pre class="screen">dn: cn=k8s-users,ou=Groups,dc=example,dc=org
changetype: add
gidNumber: 500
objectClass: groupOfNames
objectClass: posixGroup
cn: k8s-users
ou: Groups
memberUid: user-regular1
memberUid: user-regular2</pre></div></div></li><li class="listitem "><p>Example LDIF configuration to create group <code class="literal">k8s-admins</code> using an LDAP command:</p><div class="informalexample"><div class="verbatim-wrap"><pre class="screen">dn: cn=k8s-admins,ou=Groups,dc=example,dc=org
changetype: add
gidNumber: 100
objectClass: groupOfNames
objectClass: posixGroup
cn: k8s-admins
ou: Groups
memberUid: user-admin</pre></div></div></li></ul></div></div><div class="sect3" id="id-active-directory"><div class="titlepage"><div><div><h4 class="title"><span class="number">6.3.2.2 </span><span xmlns:dm="urn:x-suse:ns:docmanager" class="name">Active Directory</span> <a title="Permalink" class="permalink" href="id-security.html#id-active-directory">#</a></h4></div></div></div><div class="itemizedlist "><ul class="itemizedlist"><li class="listitem "><p>Example LDIF configuration to create user <code class="literal">user-regular1</code> using an LDAP command:</p><div class="informalexample"><div class="verbatim-wrap"><pre class="screen">dn: cn=user-regular1,ou=Users,dc=example,dc=org
objectClass: top
objectClass: person
objectClass: organizationalPerson
objectClass: user
cn: user-regular1
sn: Regular1
givenName: User
distinguishedName: cn=user-regular1,ou=Users,dc=example,dc=org
displayName: User Regular1
memberOf: cn=Domain Users,ou=Users,dc=example,dc=org
memberOf: cn=k8s-users,ou=Groups,dc=example,dc=org
name: user-regular1
sAMAccountName: user-regular1
objectCategory: cn=Person,cn=Schema,cn=Configuration,dc=example,dc=org
mail: user-regular1@example.org</pre></div></div></li><li class="listitem "><p>Example LDIF configuration to create user <code class="literal">user-regular2</code> using an LDAP command:</p><div class="informalexample"><div class="verbatim-wrap"><pre class="screen">dn: cn=user-regular2,ou=Users,dc=example,dc=org
objectClass: top
objectClass: person
objectClass: organizationalPerson
objectClass: user
cn: user-regular2
sn: Regular2
givenName: User
distinguishedName: cn=user-regular2,ou=Users,dc=example,dc=org
displayName: User Regular2
memberOf: cn=Domain Users,ou=Users,dc=example,dc=org
memberOf: cn=k8s-users,ou=Groups,dc=example,dc=org
name: user-regular2
sAMAccountName: user-regular2
objectCategory: cn=Person,cn=Schema,cn=Configuration,dc=example,dc=org
mail: user-regular2@example.org</pre></div></div></li><li class="listitem "><p>Example LDIF configuration to create user <code class="literal">user-bind</code> using an LDAP command:</p><div class="informalexample"><div class="verbatim-wrap"><pre class="screen">dn: cn=user-bind,ou=Users,dc=example,dc=org
objectClass: top
objectClass: person
objectClass: organizationalPerson
objectClass: user
cn: user-bind
sn: Bind
givenName: User
distinguishedName: cn=user-bind,ou=Users,dc=example,dc=org
displayName: User Bind
memberOf: cn=Domain Users,ou=Users,dc=example,dc=org
name: user-bind
sAMAccountName: user-bind
objectCategory: cn=Person,cn=Schema,cn=Configuration,dc=example,dc=org
mail: user-bind@example.org</pre></div></div></li><li class="listitem "><p>Example LDIF configuration to create user <code class="literal">user-admin</code> using an LDAP command:</p><div class="informalexample"><div class="verbatim-wrap"><pre class="screen">dn: cn=user-admin,ou=Users,dc=example,dc=org
objectClass: top
objectClass: person
objectClass: organizationalPerson
objectClass: user
cn: user-admin
sn: Admin
givenName: User
distinguishedName: cn=user-admin,ou=Users,dc=example,dc=org
displayName: User Admin
memberOf: cn=Domain Users,ou=Users,dc=example,dc=org
memberOf: cn=k8s-admins,ou=Groups,dc=example,dc=org
name: user-admin
sAMAccountName: user-admin
objectCategory: cn=Person,cn=Schema,cn=Configuration,dc=example,dc=org
mail: user-admin@example.org</pre></div></div></li><li class="listitem "><p>Example LDIF configuration to create group <code class="literal">k8s-users</code> using an LDAP command:</p><div class="informalexample"><div class="verbatim-wrap"><pre class="screen">dn: cn=k8s-users,ou=Groups,dc=example,dc=org
objectClass: top
objectClass: group
cn: k8s-users
member: cn=user-regular1,ou=Users,dc=example,dc=org
member: cn=user-regular2,ou=Users,dc=example,dc=org
distinguishedName: cn=k8s-users,ou=Groups,dc=example,dc=org
name: k8s-users
sAMAccountName: k8s-users
objectCategory: cn=Group,cn=Schema,cn=Configuration,dc=example,dc=org</pre></div></div></li><li class="listitem "><p>Example LDIF configuration to create group <code class="literal">k8s-admins</code> using an LDAP command:</p><div class="informalexample"><div class="verbatim-wrap"><pre class="screen">dn: cn=k8s-admins,ou=Groups,dc=example,dc=org
objectClass: top
objectClass: group
cn: k8s-admins
member: cn=user-admin,ou=Users,dc=example,dc=org
distinguishedName: cn=k8s-admins,ou=Groups,dc=example,dc=org
name: k8s-admins
sAMAccountName: k8s-admins
objectCategory: cn=Group,cn=Schema,cn=Configuration,dc=example,dc=org</pre></div></div></li></ul></div></div></div></div><div class="sect1" id="sec-admin-security-users"><div class="titlepage"><div><div><h2 class="title"><span class="number">6.4 </span><span xmlns:dm="urn:x-suse:ns:docmanager" class="name">Managing LDAP Users and Groups</span> <a title="Permalink" class="permalink" href="id-security.html#sec-admin-security-users">#</a></h2></div></div></div><p>You can use standard LDAP administration tools for managing organizations, groups and users remotely.
To do so, install the <code class="literal">openldap2-client</code> package on a computer in your network
and make sure that the computer can connect to the LDAP server
(389 Directory Server) on port <code class="literal">389</code> or secure port <code class="literal">636</code>.</p><div class="sect2" id="id-adding-a-new-organizational-unit"><div class="titlepage"><div><div><h3 class="title"><span class="number">6.4.1 </span><span xmlns:dm="urn:x-suse:ns:docmanager" class="name">Adding a New Organizational Unit</span> <a title="Permalink" class="permalink" href="id-security.html#id-adding-a-new-organizational-unit">#</a></h3></div></div></div><div class="orderedlist "><ol class="orderedlist" type="1"><li class="listitem "><p>To add a new organizational unit, create an LDIF file (<code class="literal">create_ou_groups.ldif</code>) like this:</p><div class="verbatim-wrap"><pre class="screen">dn: ou=OU_NAME,dc=example,dc=org
changetype: add
objectclass: top
objectclass: organizationalUnit
ou: OU_NAME</pre></div><div class="itemizedlist "><ul class="itemizedlist"><li class="listitem "><p>Substitute OU_NAME with an organizational unit name of your choice.</p></li></ul></div></li><li class="listitem "><p>Run <code class="literal">ldapmodify</code> to add the new organizational unit:</p><div class="verbatim-wrap"><pre class="screen">LDAP_PROTOCOL=ldap                              # ldap, ldaps
LDAP_NODE_FQDN=localhost                        # FQDN of 389 Directory Server
LDAP_NODE_PROTOCOL=:389                         # Non-TLS (:389), TLS (:636)
BIND_DN="cn=Directory Manager"                  # Admin User
LDIF_FILE=./create_ou_groups.ldif               # LDIF Configuration File
DS_DM_PASSWORD=                                 # Admin Password

ldapmodify -v -H &lt;LDAP_PROTOCOL&gt;://&lt;LDAP_NODE_FQDN&gt;&lt;LDAP_NODE_PROTOCOL&gt; -D "&lt;BIND_DN&gt;" -f &lt;LDIF_FILE&gt; -w &lt;DS_DM_PASSWORD&gt;</pre></div></li></ol></div></div><div class="sect2" id="id-removing-an-organizational-unit"><div class="titlepage"><div><div><h3 class="title"><span class="number">6.4.2 </span><span xmlns:dm="urn:x-suse:ns:docmanager" class="name">Removing an Organizational Unit</span> <a title="Permalink" class="permalink" href="id-security.html#id-removing-an-organizational-unit">#</a></h3></div></div></div><div class="orderedlist "><ol class="orderedlist" type="1"><li class="listitem "><p>To remove an organizational unit, create an LDIF file (<code class="literal">delete_ou_groups.ldif</code>) like this:</p><div class="verbatim-wrap"><pre class="screen">dn: ou=OU_NAME,dc=example,dc=org
changetype: delete</pre></div><div class="itemizedlist "><ul class="itemizedlist"><li class="listitem "><p>Substitute OU_NAME with the name of the organizational unit you would like to remove.</p></li></ul></div></li><li class="listitem "><p>Execute <code class="literal">ldapmodify</code> to remove the organizational unit:</p><div class="verbatim-wrap"><pre class="screen">LDAP_PROTOCOL=ldap                              # ldap, ldaps
LDAP_NODE_FQDN=localhost                        # FQDN of 389 Directory Server
LDAP_NODE_PROTOCOL=:389                         # Non-TLS (:389), TLS (:636)
BIND_DN="cn=Directory Manager"                  # Admin User
LDIF_FILE=./delete_ou_groups.ldif               # LDIF Configuration File
DS_DM_PASSWORD=                                 # Admin Password

ldapmodify -v -H &lt;LDAP_PROTOCOL&gt;://&lt;LDAP_NODE_FQDN&gt;&lt;LDAP_NODE_PROTOCOL&gt; -D "&lt;BIND_DN&gt;" -f &lt;LDIF_FILE&gt; -w &lt;DS_DM_PASSWORD&gt;</pre></div></li></ol></div></div><div class="sect2" id="id-adding-a-new-group-to-an-organizational-unit"><div class="titlepage"><div><div><h3 class="title"><span class="number">6.4.3 </span><span xmlns:dm="urn:x-suse:ns:docmanager" class="name">Adding a New Group to an Organizational Unit</span> <a title="Permalink" class="permalink" href="id-security.html#id-adding-a-new-group-to-an-organizational-unit">#</a></h3></div></div></div><div class="orderedlist "><ol class="orderedlist" type="1"><li class="listitem "><p>To add a new group to an organizational unit, create an LDIF file (<code class="literal">create_groups.ldif</code>) like this:</p><div class="verbatim-wrap"><pre class="screen">dn: cn=GROUP,ou=OU_NAME,dc=example,dc=org
changetype: add
objectClass: top
objectClass: groupOfNames
cn: GROUP</pre></div><div class="itemizedlist "><ul class="itemizedlist"><li class="listitem "><p>GROUP: Group name</p></li><li class="listitem "><p>OU_NAME: Organizational unit name</p></li></ul></div></li><li class="listitem "><p>Run <code class="literal">ldapmodify</code> to add the new group to the organizational unit:</p><div class="verbatim-wrap"><pre class="screen">LDAP_PROTOCOL=ldap                              # ldap, ldaps
LDAP_NODE_FQDN=localhost                        # FQDN of 389 Directory Server
LDAP_NODE_PROTOCOL=:389                         # Non-TLS (:389), TLS (:636)
BIND_DN="cn=Directory Manager"                  # Admin User
LDIF_FILE=./create_groups.ldif                  # LDIF Configuration File
DS_DM_PASSWORD=                                 # Admin Password

ldapmodify -v -H &lt;LDAP_PROTOCOL&gt;://&lt;LDAP_NODE_FQDN&gt;&lt;LDAP_NODE_PROTOCOL&gt; -D "&lt;BIND_DN&gt;" -f &lt;LDIF_FILE&gt; -w &lt;DS_DM_PASSWORD&gt;</pre></div></li></ol></div></div><div class="sect2" id="id-removing-a-group-from-an-organizational-unit"><div class="titlepage"><div><div><h3 class="title"><span class="number">6.4.4 </span><span xmlns:dm="urn:x-suse:ns:docmanager" class="name">Removing a Group from an Organizational Unit</span> <a title="Permalink" class="permalink" href="id-security.html#id-removing-a-group-from-an-organizational-unit">#</a></h3></div></div></div><div class="orderedlist "><ol class="orderedlist" type="1"><li class="listitem "><p>To remove a group from an organizational unit, create an LDIF file (<code class="literal">delete_ou_groups.ldif</code>) like this:</p><div class="verbatim-wrap"><pre class="screen">dn: cn=GROUP,ou=OU_NAME,dc=example,dc=org
changetype: delete</pre></div><div class="itemizedlist "><ul class="itemizedlist"><li class="listitem "><p>GROUP: Group name</p></li><li class="listitem "><p>OU_NAME: organizational unit name</p></li></ul></div></li><li class="listitem "><p>Execute <code class="literal">ldapmodify</code> to remove the group from the organizational unit:</p><div class="verbatim-wrap"><pre class="screen">LDAP_PROTOCOL=ldap                              # ldap, ldaps
LDAP_NODE_FQDN=localhost                        # FQDN of 389 Directory Server
LDAP_NODE_PROTOCOL=:389                         # Non-TLS (:389), TLS (:636)
BIND_DN="cn=Directory Manager"                  # Admin User
LDIF_FILE=./delete_ou_groups.ldif               # LDIF Configuration File
DS_DM_PASSWORD=                                 # Admin Password

ldapmodify -v -H &lt;LDAP_PROTOCOL&gt;://&lt;LDAP_NODE_FQDN&gt;&lt;LDAP_NODE_PROTOCOL&gt; -D "&lt;BIND_DN&gt;" -f &lt;LDIF_FILE&gt; -w &lt;DS_DM_PASSWORD&gt;</pre></div></li></ol></div><div class="sect3" id="sec-admin-security-users-add"><div class="titlepage"><div><div><h4 class="title"><span class="number">6.4.4.1 </span><span xmlns:dm="urn:x-suse:ns:docmanager" class="name">Adding a New User</span> <a title="Permalink" class="permalink" href="id-security.html#sec-admin-security-users-add">#</a></h4></div></div></div><div class="orderedlist "><ol class="orderedlist" type="1"><li class="listitem "><p>To add a new user, create an LDIF file (<code class="literal">new_user.ldif</code>) like this:</p><div class="verbatim-wrap"><pre class="screen">dn: uid=USERID,ou=OU_NAME,dc=example,dc=org
objectClass: person
objectClass: inetOrgPerson
objectClass: top
uid: USERID
userPassword: PASSWORD_HASH
givenname: FIRST_NAME
sn: SURNAME
cn: FULL_NAME
mail: E-MAIL_ADDRESS</pre></div><div class="itemizedlist "><ul class="itemizedlist"><li class="listitem "><p>USERID: User ID (UID) of the new user. This value must be a unique number.</p></li><li class="listitem "><p>OU_NAME: organizational unit name</p></li><li class="listitem "><p>PASSWORD_HASH: The user’s hashed password.SSHA_PASSWORD: The user’s new hashed password.</p><p>Use <code class="literal">/usr/sbin/slappasswd</code> to generate the SSHA hash.</p><div class="verbatim-wrap"><pre class="screen">/usr/sbin/slappasswd -h {SSHA} -s &lt;USER_PASSWORD&gt;</pre></div><p>Use <code class="literal">/usr/bin/pwdhash</code> to generate the SSHA hash.</p><div class="verbatim-wrap"><pre class="screen">/usr/bin/pwdhash -s SSHA &lt;USER_PASSWORD&gt;</pre></div></li><li class="listitem "><p>FIRST_NAME: The user’s first name</p></li><li class="listitem "><p>SURNAME: The user’s last name</p></li><li class="listitem "><p>FULL_NAME: The user’s full name</p></li><li class="listitem "><p>E-MAIL_ADDRESS: The user’s e-mail address</p></li></ul></div></li><li class="listitem "><p>Execute <code class="literal">ldapadd</code> to add the new user:</p><div class="verbatim-wrap"><pre class="screen">LDAP_PROTOCOL=ldap                              # ldap, ldaps
LDAP_NODE_FQDN=localhost                        # FQDN of 389 Directory Server
LDAP_NODE_PROTOCOL=:389                         # Non-TLS (:389), TLS (:636)
BIND_DN="cn=Directory Manager"                  # Admin User
LDIF_FILE=./new_user.ldif                       # LDIF Configuration File
DS_DM_PASSWORD=                                 # Admin Password

ldapadd -v -H &lt;LDAP_PROTOCOL&gt;://&lt;LDAP_NODE_FQDN&gt;&lt;LDAP_NODE_PROTOCOL&gt; -D
"&lt;BIND_DN&gt;" -f &lt;LDIF_FILE&gt; -w &lt;DS_DM_PASSWORD&gt;</pre></div></li></ol></div></div><div class="sect3" id="id-showing-user-attributes"><div class="titlepage"><div><div><h4 class="title"><span class="number">6.4.4.2 </span><span xmlns:dm="urn:x-suse:ns:docmanager" class="name">Showing User Attributes</span> <a title="Permalink" class="permalink" href="id-security.html#id-showing-user-attributes">#</a></h4></div></div></div><div class="orderedlist "><ol class="orderedlist" type="1"><li class="listitem "><p>To show the attributes of a user, use the <code class="literal">ldapsearch</code> command:</p><div class="verbatim-wrap"><pre class="screen">LDAP_PROTOCOL=ldap                              # ldap, ldaps
LDAP_NODE_FQDN=localhost                        # FQDN of 389 Directory Server
LDAP_NODE_PROTOCOL=:389                         # Non-TLS (:389), TLS (:636)
USERID=user1
BASE_DN="uid=&lt;USERID&gt;,dc=example,dc=org"
BIND_DN="cn=Directory Manager"                  # Admin User
DS_DM_PASSWORD=                                 # Admin Password

ldapsearch -v -x -H &lt;LDAP_PROTOCOL&gt;://&lt;LDAP_NODE_FQDN&gt;&lt;LDAP_NODE_PROTOCOL&gt; -b
"&lt;BASE_DN&gt;" -D "&lt;BIND_DN&gt;" -w &lt;DS_DM_PASSWORD&gt;</pre></div></li></ol></div></div><div class="sect3" id="id-modifying-a-user"><div class="titlepage"><div><div><h4 class="title"><span class="number">6.4.4.3 </span><span xmlns:dm="urn:x-suse:ns:docmanager" class="name">Modifying a User</span> <a title="Permalink" class="permalink" href="id-security.html#id-modifying-a-user">#</a></h4></div></div></div><p>The following procedure shows how to modify a user in the LDAP server.
See the LDIF files for examples of how to change rootdn password, a user password and add a user to the
<code class="literal">Administrators</code> group.
To modify other fields, you can use the password example, replacing <code class="literal">userPassword</code>
with other field names you want to change.</p><div class="orderedlist "><ol class="orderedlist" type="1"><li class="listitem "><p>Create an LDIF file (<code class="literal">modify_rootdn.ldif</code>), which contains the change to the LDAP server:</p><div class="verbatim-wrap"><pre class="screen">dn: cn=config
changetype: modify
replace: nsslapd-rootpw
nsslapd-rootpw: NEW_PASSWORD</pre></div><div class="itemizedlist "><ul class="itemizedlist"><li class="listitem "><p>NEW_PASSWORD: The user’s new hashed password.</p><p>Use <code class="literal">/usr/sbin/slappasswd</code> to generate the SSHA hash.</p><div class="verbatim-wrap"><pre class="screen">/usr/sbin/slappasswd -h {SSHA} -s &lt;USER_PASSWORD&gt;</pre></div><p>Use <code class="literal">/usr/bin/pwdhash</code> to generate the SSHA hash.</p><div class="verbatim-wrap"><pre class="screen">/usr/bin/pwdhash -s SSHA &lt;USER_PASSWORD&gt;</pre></div></li></ul></div></li><li class="listitem "><p>Create an LDIF file (<code class="literal">modify_user.ldif</code>), which contains the change to the LDAP server:</p><div class="verbatim-wrap"><pre class="screen">dn: uid=USERID,ou=OU_NAME,dc=example,dc=org
changetype: modify
replace: userPassword
userPassword: NEW_PASSWORD</pre></div><div class="itemizedlist "><ul class="itemizedlist"><li class="listitem "><p>USERID: The desired user’s ID</p></li><li class="listitem "><p>OU_NAME: organizational unit name</p></li><li class="listitem "><p>NEW_PASSWORD: The user’s new hashed password.</p><p>Use <code class="literal">/usr/sbin/slappasswd</code> to generate the SSHA hash.</p><div class="verbatim-wrap"><pre class="screen">/usr/sbin/slappasswd -h {SSHA} -s &lt;USER_PASSWORD&gt;</pre></div><p>Use <code class="literal">/usr/bin/pwdhash</code> to generate the SSHA hash.</p><div class="verbatim-wrap"><pre class="screen">/usr/bin/pwdhash -s SSHA &lt;USER_PASSWORD&gt;</pre></div></li></ul></div></li><li class="listitem "><p>Add the user to the <code class="literal">Administrators</code> group:</p><div class="verbatim-wrap"><pre class="screen">dn: cn=Administrators,ou=Groups,dc=example,dc=org
changetype: modify
add: uniqueMember
uniqueMember: uid=USERID,ou=OU_NAME,dc=example,dc=org</pre></div><div class="itemizedlist "><ul class="itemizedlist"><li class="listitem "><p>USERID: Substitute with the user’s ID.</p></li><li class="listitem "><p>OU_NAME: organizational unit name</p></li></ul></div></li><li class="listitem "><p>Execute <code class="literal">ldapmodify</code> to change user attributes:</p><div class="verbatim-wrap"><pre class="screen">LDAP_PROTOCOL=ldap                              # ldap, ldaps
LDAP_NODE_FQDN=localhost                        # FQDN of 389 Directory Server
LDAP_NODE_PROTOCOL=:389                         # Non-TLS (:389), TLS (:636)
BIND_DN="cn=Directory Manager"                  # Admin User
LDIF_FILE=./modify_user.ldif                    # LDIF Configuration File
DS_DM_PASSWORD=                                 # Admin Password

ldapmodify -v -H &lt;LDAP_PROTOCOL&gt;://&lt;LDAP_NODE_FQDN&gt;&lt;LDAP_NODE_PROTOCOL&gt; -D
"&lt;BIND_DN&gt;" -f &lt;LDIF_FILE&gt; -w &lt;DS_DM_PASSWORD&gt;</pre></div></li></ol></div></div><div class="sect3" id="id-deleting-a-user"><div class="titlepage"><div><div><h4 class="title"><span class="number">6.4.4.4 </span><span xmlns:dm="urn:x-suse:ns:docmanager" class="name">Deleting a User</span> <a title="Permalink" class="permalink" href="id-security.html#id-deleting-a-user">#</a></h4></div></div></div><p>To delete a user from the LDAP server, follow these steps:</p><div class="orderedlist "><ol class="orderedlist" type="1"><li class="listitem "><p>Create an LDIF file (<code class="literal">delete_user.ldif</code>) that specifies the name of the entry:</p><div class="verbatim-wrap"><pre class="screen">dn: uid=USER_ID,ou=OU_NAME,dc=example,dc=org
changetype: delete</pre></div><div class="itemizedlist "><ul class="itemizedlist"><li class="listitem "><p>USERID: Substitute this with the user’s ID.</p></li><li class="listitem "><p>OU_NAME: organizational unit name</p></li></ul></div></li><li class="listitem "><p>Run <code class="literal">ldapmodify</code> to delete the user:</p><div class="verbatim-wrap"><pre class="screen">LDAP_PROTOCOL=ldap                              # ldap, ldaps
LDAP_NODE_FQDN=localhost                        # FQDN of 389 Directory Server
LDAP_NODE_PROTOCOL=:389                         # Non-TLS (:389), TLS (:636)
BIND_DN="cn=Directory Manager"                  # Admin User
LDIF_FILE=./delete_user.ldif                    # LDIF Configuration File
DS_DM_PASSWORD=                                 # Admin Password

ldapmodify -v -H &lt;LDAP_PROTOCOL&gt;://&lt;LDAP_NODE_FQDN&gt;&lt;LDAP_NODE_PROTOCOL&gt; -D "&lt;BIND_DN&gt;" -f &lt;LDIF_FILE&gt; -w &lt;DS_DM_PASSWORD&gt;</pre></div></li></ol></div></div><div class="sect3" id="id-changing-your-own-ldap-password-from-cli"><div class="titlepage"><div><div><h4 class="title"><span class="number">6.4.4.5 </span><span xmlns:dm="urn:x-suse:ns:docmanager" class="name">Changing Your own LDAP Password from CLI</span> <a title="Permalink" class="permalink" href="id-security.html#id-changing-your-own-ldap-password-from-cli">#</a></h4></div></div></div><p>To perform a change to your own user password from CLI.</p><div class="verbatim-wrap"><pre class="screen">LDAP_PROTOCOL=ldap                                  # ldap, ldaps
LDAP_NODE_FQDN=localhost                            # FQDN of 389 Directory Server
LDAP_NODE_PROTOCOL=:389                             # Non-TLS (:389), TLS (:636)
BIND_DN=                                            # User's binding dn
DS_DM_PASSWORD=                                     # Old Password
NEW_DS_DM_PASSWORD=                                 # New Password

ldappasswd -v -H &lt;LDAP_PROTOCOL&gt;://&lt;LDAP_NODE_FQDN&gt;&lt;LDAP_NODE_PROTOCOL&gt;  -x -D "&lt;BIND_DN&gt;" -w &lt;DS_DM_PASSWORD&gt; -a &lt;DS_DM_PASSWORD&gt; -s &lt;NEW_DS_DM_PASSWORD&gt;</pre></div></div></div><div class="sect2" id="configure-auth-connector"><div class="titlepage"><div><div><h3 class="title"><span class="number">6.4.5 </span><span xmlns:dm="urn:x-suse:ns:docmanager" class="name">Configuring the Authentication Connector</span> <a title="Permalink" class="permalink" href="id-security.html#configure-auth-connector">#</a></h3></div></div></div><p>Administrators can update the authentication connector settings before or after SUSE CaaS Platform
deployment as follows:</p><div class="orderedlist "><ol class="orderedlist" type="1"><li class="listitem "><p>Based on the manifest in <code class="literal">&lt;CLUSTER_NAME&gt;/addons/dex/base/dex.yaml</code>, provide a kustomize patch to <code class="literal">&lt;CLUSTER_NAME&gt;/addons/dex/patches/custom.yaml</code> of the form of strategic merge patch or a JSON 6902 patch.</p><p>Read <a class="link" href="https://github.com/kubernetes-sigs/kustomize/blob/master/docs/glossary.md#patchstrategicmerge" target="_blank">https://github.com/kubernetes-sigs/kustomize/blob/master/docs/glossary.md#patchstrategicmerge</a> and <a class="link" href="https://github.com/kubernetes-sigs/kustomize/blob/master/docs/glossary.md#patchjson6902" target="_blank">https://github.com/kubernetes-sigs/kustomize/blob/master/docs/glossary.md#patchjson6902</a> to get more information.</p></li><li class="listitem "><p>Adapt ConfigMap by adding LDAP configuration to the connector section.
For detailed configuration of the LDAP connector, refer to the Dex documentation <a class="link" href="https://github.com/dexidp/dex/blob/v2.23.0/Documentation/connectors/ldap.md" target="_blank">https://github.com/dexidp/dex/blob/v2.23.0/Documentation/connectors/ldap.md</a>.</p><div id="id-1.8.5.7.3.2.2" class="admonition note normal"><img class="symbol" alt="Note" title="Note" src="static/images/icon-note.png" /><h6>Note</h6><p>Besides the LDAP connector, you can also set up other connectors.
For additional connectors, refer to the available connector configurations in the Dex repository:
<a class="link" href="https://github.com/dexidp/dex/tree/v2.23.0/Documentation/connectors" target="_blank">https://github.com/dexidp/dex/tree/v2.23.0/Documentation/connectors</a>.</p></div><div id="id-1.8.5.7.3.2.3" class="admonition tip normal"><img class="symbol" alt="Tip" title="Tip" src="static/images/icon-tip.png" /><h6>Tip: Base64 ecoded PEM file</h6><p>A base64 encoded PEM file can be generated by running:</p><div class="verbatim-wrap highlight bash"><pre class="screen">cat &lt;ROOT_CA_PEM_FILE&gt; | base64 | awk '\{print\}' ORS='' &amp;&amp; echo</pre></div></div><p>Examples of Usage (<code class="literal">&lt;CLUSTER_NAME&gt;/addons/dex/patches/custom.yaml</code>):</p><div class="itemizedlist "><ul class="itemizedlist"><li class="listitem "><p>LDAP 389-DS TLS Connector:</p><div class="verbatim-wrap highlight yaml"><pre class="screen">apiVersion: v1
kind: ConfigMap
metadata:
  name: oidc-dex-config
  namespace: kube-system
data:
  config.yaml: |
    connectors:
    - type: ldap
      # Required field for connector id.
      id: 389ds
      # Required field for connector name.
      name: 389ds
      config:
        # Host and optional port of the LDAP server in the form "host:port".
        # If the port is not supplied, it will be guessed based on "insecureNoSSL",
        # and "startTLS" flags. 389 for insecure or StartTLS connections, 636
        # otherwise.
        host: ldap.example.org:636

        # The following field is required if the LDAP host is not using TLS (port 389).
        # Because this option inherently leaks passwords to anyone on the same network
        # as dex, THIS OPTION MAY BE REMOVED WITHOUT WARNING IN A FUTURE RELEASE.
        #
        # insecureNoSSL: true

        # If a custom certificate isn't provided, this option can be used to turn on
        # TLS certificate checks. As noted, it is insecure and shouldn't be used outside
        # of explorative phases.
        #
        insecureSkipVerify: true

        # When connecting to the server, connect using the ldap:// protocol then issue
        # a StartTLS command. If unspecified, connections will use the ldaps:// protocol
        #
        # startTLS: true

        # Path to a trusted root certificate file. Default: use the host's root CA.
        # rootCA: /etc/dex/pki/ca.crt

        # A raw certificate file can also be provided inline.
        rootCAData: &lt;BASE64_ENCODED_PEM_FILE&gt;

        # The DN and password for an application service account. The connector uses
        # these credentials to search for users and groups. Not required if the LDAP
        # server provides access for anonymous auth.
        # Please note that if the bind password contains a `$`, it has to be saved in an
        # environment variable which should be given as the value to `bindPW`.
        bindDN: cn=Directory Manager
        bindPW: &lt;BIND_DN_PASSWORD&gt;

        # The attribute to display in the provided password prompt. If unset, will
        # display "Username"
        usernamePrompt: Email Address

        # User search maps a username and password entered by a user to a LDAP entry.
        userSearch:
          # BaseDN to start the search from. It will translate to the query
          # "(&amp;(objectClass=person)(mail=&lt;USERNAME&gt;))".
          baseDN: ou=Users,dc=example,dc=org
          # Optional filter to apply when searching the directory.
          filter: "(objectClass=person)"

          # username attribute used for comparing user entries. This will be translated
          # and combined with the other filter as "(&lt;attr&gt;=&lt;USERNAME&gt;)".
          username: mail
          # The following three fields are direct mappings of attributes on the user entry.
          # String representation of the user.
          idAttr: DN
          # Required. Attribute to map to Email.
          emailAttr: mail
          # Maps to display the name of users. No default value.
          nameAttr: cn

        # Group search queries for groups given a user entry.
        groupSearch:
          # BaseDN to start the search from. It will translate to the query
          # "(&amp;(objectClass=group)(member=&lt;USER_UID&gt;))".
          baseDN: ou=Groups,dc=example,dc=org
          # Optional filter to apply when searching the directory.
          filter: "(objectClass=groupOfNames)"

          # Following two fields are used to match a user to a group. It adds an additional
          # requirement to the filter that an attribute in the group must match the user's
          # attribute value.
          userAttr: uid
          groupAttr: memberUid

          # Represents group name.
          nameAttr: cn</pre></div></li><li class="listitem "><p>Active Directory TLS Connector using email:</p><div class="verbatim-wrap highlight yaml"><pre class="screen">apiVersion: v1
kind: ConfigMap
metadata:
  name: oidc-dex-config
  namespace: kube-system
data:
  config.yaml: |
    connectors:
    - type: ldap
      # Required field for connector id.
      id: AD
      # Required field for connector name.
      name: AD
      config:
        # Host and optional port of the LDAP server in the form "host:port".
        # If the port is not supplied, it will be guessed based on "insecureNoSSL",
        # and "startTLS" flags. 389 for insecure or StartTLS connections, 636
        # otherwise.
        host: ad.example.org:636

        # Following field is required if the LDAP host is not using TLS (port 389).
        # Because this option inherently leaks passwords to anyone on the same network
        # as dex, THIS OPTION MAY BE REMOVED WITHOUT WARNING IN A FUTURE RELEASE.
        #
        # insecureNoSSL: true

        # If a custom certificate isn't provided, this option can be used to turn on
        # TLS certificate checks. As noted, it is insecure and shouldn't be used outside
        # of explorative phases.
        #
        # insecureSkipVerify: true

        # When connecting to the server, connect using the ldap:// protocol then issue
        # a StartTLS command. If unspecified, connections will use the ldaps:// protocol
        #
        # startTLS: true

        # Path to a trusted root certificate file. Default: use the host's root CA.
        # rootCA: /etc/dex/ldap.ca

        # A raw certificate file can also be provided inline.
        rootCAData: &lt;BASE_64_ENCODED_PEM_FILE&gt;

        # The DN and password for an application service account. The connector uses
        # these credentials to search for users and groups. Not required if the LDAP
        # server provides access for anonymous auth.
        # Please note that if the bind password contains a `$`, it has to be saved in an
        # environment variable which should be given as the value to `bindPW`.
        bindDN: cn=user-admin,ou=Users,dc=example,dc=org
        bindPW: &lt;BIND_DN_PASSWORD&gt;

        # The attribute to display in the provided password prompt. If unset, will
        # display "Username"
        usernamePrompt: Email Address

        # User search maps a username and password entered by a user to a LDAP entry.
        userSearch:
          # BaseDN to start the search from. It will translate to the query
          # "(&amp;(objectClass=person)(mail=&lt;USERNAME&gt;))".
          baseDN: ou=Users,dc=example,dc=org
          # Optional filter to apply when searching the directory.
          filter: "(objectClass=person)"

          # username attribute used for comparing user entries. This will be translated
          # and combined with the other filter as "(&lt;attr&gt;=&lt;USERNAME&gt;)".
          username: mail
          # The following three fields are direct mappings of attributes on the user entry.
          # String representation of the user.
          idAttr: distinguishedName
          # Required. Attribute to map to Email.
          emailAttr: mail
          # Maps to display the name of users. No default value.
          nameAttr: sAMAccountName

        # Group search queries for groups given a user entry.
        groupSearch:
          # BaseDN to start the search from. It will translate to the query
          # "(&amp;(objectClass=group)(member=&lt;USER_UID&gt;))".
          baseDN: ou=Groups,dc=example,dc=org
          # Optional filter to apply when searching the directory.
          filter: "(objectClass=group)"

          # Following two fields are used to match a user to a group. It adds an additional
          # requirement to the filter that an attribute in the group must match the user's
          # attribute value.
          userAttr: distinguishedName
          groupAttr: member

          # Represents group name.
          nameAttr: sAMAccountName</pre></div></li><li class="listitem "><p>Active Directory TLS Connector using sAMAccountName:</p><div class="verbatim-wrap highlight yaml"><pre class="screen">apiVersion: v1
kind: ConfigMap
metadata:
  name: oidc-dex-config
  namespace: kube-system
data:
  config.yaml: |
    connectors:
    - type: ldap
      # Required field for connector id.
      id: AD
      # Required field for connector name.
      name: AD
      config:
        # Host and optional port of the LDAP server in the form "host:port".
        # If the port is not supplied, it will be guessed based on "insecureNoSSL",
        # and "startTLS" flags. 389 for insecure or StartTLS connections, 636
        # otherwise.
        host: ad.example.org:636

        # Following field is required if the LDAP host is not using TLS (port 389).
        # Because this option inherently leaks passwords to anyone on the same network
        # as dex, THIS OPTION MAY BE REMOVED WITHOUT WARNING IN A FUTURE RELEASE.
        #
        # insecureNoSSL: true

        # If a custom certificate isn't provided, this option can be used to turn on
        # TLS certificate checks. As noted, it is insecure and shouldn't be used outside
        # of explorative phases.
        #
        # insecureSkipVerify: true

        # When connecting to the server, connect using the ldap:// protocol then issue
        # a StartTLS command. If unspecified, connections will use the ldaps:// protocol
        #
        # startTLS: true

        # Path to a trusted root certificate file. Default: use the host's root CA.
        # rootCA: /etc/dex/ldap.ca

        # A raw certificate file can also be provided inline.
        rootCAData: &lt;BASE_64_ENCODED_PEM_FILE&gt;

        # The DN and password for an application service account. The connector uses
        # these credentials to search for users and groups. Not required if the LDAP
        # server provides access for anonymous auth.
        # Please note that if the bind password contains a `$`, it has to be saved in an
        # environment variable which should be given as the value to `bindPW`.
        bindDN: cn=user-admin,ou=Users,dc=example,dc=org
        bindPW: &lt;BIND_DN_PASSWORD&gt;

        # The attribute to display in the provided password prompt. If unset, will
        # display "Username"
        usernamePrompt: sAMAccountName

        # User search maps a username and password entered by a user to a LDAP entry.
        userSearch:
          # BaseDN to start the search from. It will translate to the query
          # "(&amp;(objectClass=person)(mail=&lt;USERNAME&gt;))".
          baseDN: ou=Users,dc=example,dc=org
          # Optional filter to apply when searching the directory.
          filter: "(objectClass=person)"

          # username attribute used for comparing user entries. This will be translated
          # and combined with the other filter as "(&lt;attr&gt;=&lt;USERNAME&gt;)".
          username: sAMAccountName
          # The following three fields are direct mappings of attributes on the user entry.
          # String representation of the user.
          idAttr: sAMAccountName
          # Required. Attribute to map to Email.
          emailAttr: mail
          # Maps to display the name of users. No default value.
          nameAttr: sAMAccountName

        # Group search queries for groups given a user entry.
        groupSearch:
          # BaseDN to start the search from. It will translate to the query
          # "(&amp;(objectClass=group)(member=&lt;USER_UID&gt;))".
          baseDN: ou=Groups,dc=example,dc=org
          # Optional filter to apply when searching the directory.
          filter: "(objectClass=group)"

          # Following two fields are used to match a user to a group. It adds an additional
          # requirement to the filter that an attribute in the group must match the user's
          # attribute value.
          userAttr: distinguishedName
          groupAttr: member

          # Represents group name.
          nameAttr: sAMAccountName</pre></div></li></ul></div></li><li class="listitem "><p>Create a <code class="literal">kustomization.yaml</code> file in <code class="literal">&lt;CLUSTER_NAME&gt;/addons/dex/kustomization.yaml</code></p><div class="verbatim-wrap highlight yaml"><pre class="screen">apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
resources:
  - base/dex.yaml
patches:
  - patches/custom.yaml</pre></div></li><li class="listitem "><p>Apply the changes with:</p><div class="verbatim-wrap highlight yaml"><pre class="screen">kubectl apply -k &lt;CLUSTER_NAME&gt;/addons/dex/</pre></div></li><li class="listitem "><p>Then, refer to <a class="xref" href="id-security.html#sec-admin-security-rbac-apply" title="6.5.2. User Access">Section 6.5.2, “User Access”</a> to access through Web or CLI.</p></li></ol></div></div></div><div class="sect1" id="rbac"><div class="titlepage"><div><div><h2 class="title"><span class="number">6.5 </span><span xmlns:dm="urn:x-suse:ns:docmanager" class="name">Role-Based Access Control (RBAC)</span> <a title="Permalink" class="permalink" href="id-security.html#rbac">#</a></h2></div></div></div><p>Kubernetes RBAC uses the <code class="literal">rbac.authorization.k8s.io</code> API group to drive authorization decisions,
allowing administrators to dynamically configure policies through the Kubernetes API.</p><p>The administrators can use Kubernetes RBAC to design user or group authorizations.</p><div class="sect2" id="sec-admin-security-role"><div class="titlepage"><div><div><h3 class="title"><span class="number">6.5.1 </span><span xmlns:dm="urn:x-suse:ns:docmanager" class="name">Role Management</span> <a title="Permalink" class="permalink" href="id-security.html#sec-admin-security-role">#</a></h3></div></div></div><p>Roles define, which <span class="emphasis"><em>subjects</em></span> (users or groups) can use which <span class="emphasis"><em>verbs</em></span> (operations) on which <span class="emphasis"><em>resources</em></span>.
The following sections provide an overview of the verbs, resources, and how to create roles.
Roles can then be assigned to users and groups.</p><div class="sect3" id="sec-admin-security-role-verb"><div class="titlepage"><div><div><h4 class="title"><span class="number">6.5.1.1 </span><span xmlns:dm="urn:x-suse:ns:docmanager" class="name">List of Verbs</span> <a title="Permalink" class="permalink" href="id-security.html#sec-admin-security-role-verb">#</a></h4></div></div></div><p>This section provides an overview of the most common <span class="emphasis"><em>verbs</em></span> (operations) used for defining roles.
Verbs correspond to sub-commands of <code class="literal">kubectl</code>.</p><div class="variablelist "><dl class="variablelist"><dt id="id-1.8.6.4.3.3.1"><span class="term ">create</span></dt><dd><p>Create a resource.</p></dd><dt id="id-1.8.6.4.3.3.2"><span class="term ">delete</span></dt><dd><p>Delete resources.</p></dd><dt id="id-1.8.6.4.3.3.3"><span class="term ">deletecollection</span></dt><dd><p>Delete a collection of a resource (can only be invoked using the Kubernetes API).</p></dd><dt id="id-1.8.6.4.3.3.4"><span class="term ">get</span></dt><dd><p>Display individual resources.</p></dd><dt id="id-1.8.6.4.3.3.5"><span class="term ">list</span></dt><dd><p>Display collections.</p></dd><dt id="id-1.8.6.4.3.3.6"><span class="term ">patch</span></dt><dd><p>Update an API object in place.</p></dd><dt id="id-1.8.6.4.3.3.7"><span class="term ">proxy</span></dt><dd><p>Allows running <code class="literal">kubectl</code> in a mode where it acts as a reverse proxy.</p></dd><dt id="id-1.8.6.4.3.3.8"><span class="term ">update</span></dt><dd><p>Update fields of a resource, for example, annotations or labels.</p></dd><dt id="id-1.8.6.4.3.3.9"><span class="term ">watch</span></dt><dd><p>Watch resource.</p></dd></dl></div></div><div class="sect3" id="sec-admin-security-role-resource"><div class="titlepage"><div><div><h4 class="title"><span class="number">6.5.1.2 </span><span xmlns:dm="urn:x-suse:ns:docmanager" class="name">List of Resources</span> <a title="Permalink" class="permalink" href="id-security.html#sec-admin-security-role-resource">#</a></h4></div></div></div><p>This section provides an overview of the most common <span class="emphasis"><em>resources</em></span> used for defining roles.</p><div class="variablelist "><dl class="variablelist"><dt id="id-1.8.6.4.4.3.1"><span class="term ">Autoscaler</span></dt><dd><p><a class="link" href="https://v1-18.docs.kubernetes.io/docs/tasks/run-application/horizontal-pod-autoscale/" target="_blank">https://v1-18.docs.kubernetes.io/docs/tasks/run-application/horizontal-pod-autoscale/</a></p></dd><dt id="id-1.8.6.4.4.3.2"><span class="term ">ConfigMaps</span></dt><dd><p><a class="link" href="https://v1-18.docs.kubernetes.io/docs/tasks/configure-pod-container/configure-pod-configmap/" target="_blank">https://v1-18.docs.kubernetes.io/docs/tasks/configure-pod-container/configure-pod-configmap/</a></p></dd><dt id="id-1.8.6.4.4.3.3"><span class="term ">Cronjob</span></dt><dd><p><a class="link" href="https://v1-18.docs.kubernetes.io/docs/concepts/workloads/controllers/cron-jobs/" target="_blank">https://v1-18.docs.kubernetes.io/docs/concepts/workloads/controllers/cron-jobs/</a></p></dd><dt id="id-1.8.6.4.4.3.4"><span class="term ">DaemonSet</span></dt><dd><p><a class="link" href="https://v1-18.docs.kubernetes.io/docs/concepts/workloads/controllers/daemonset/" target="_blank">https://v1-18.docs.kubernetes.io/docs/concepts/workloads/controllers/daemonset/</a></p></dd><dt id="id-1.8.6.4.4.3.5"><span class="term ">Deployment</span></dt><dd><p><a class="link" href="https://v1-18.docs.kubernetes.io/docs/concepts/workloads/controllers/deployment/" target="_blank">https://v1-18.docs.kubernetes.io/docs/concepts/workloads/controllers/deployment/</a></p></dd><dt id="id-1.8.6.4.4.3.6"><span class="term ">Ingress</span></dt><dd><p><a class="link" href="https://v1-18.docs.kubernetes.io/docs/concepts/services-networking/ingress/" target="_blank">https://v1-18.docs.kubernetes.io/docs/concepts/services-networking/ingress/</a></p></dd><dt id="id-1.8.6.4.4.3.7"><span class="term ">Job</span></dt><dd><p><a class="link" href="https://v1-18.docs.kubernetes.io/docs/concepts/workloads/controllers/jobs-run-to-completion/" target="_blank">https://v1-18.docs.kubernetes.io/docs/concepts/workloads/controllers/jobs-run-to-completion/</a></p></dd><dt id="id-1.8.6.4.4.3.8"><span class="term ">Namespace</span></dt><dd><p><a class="link" href="https://v1-18.docs.kubernetes.io/docs/concepts/overview/working-with-objects/namespaces/" target="_blank">https://v1-18.docs.kubernetes.io/docs/concepts/overview/working-with-objects/namespaces/</a></p></dd><dt id="id-1.8.6.4.4.3.9"><span class="term ">Node</span></dt><dd><p><a class="link" href="https://v1-18.docs.kubernetes.io/docs/concepts/architecture/nodes/" target="_blank">https://v1-18.docs.kubernetes.io/docs/concepts/architecture/nodes/</a></p></dd><dt id="id-1.8.6.4.4.3.10"><span class="term ">Pod</span></dt><dd><p><a class="link" href="https://v1-18.docs.kubernetes.io/docs/concepts/workloads/pods/pod-overview/" target="_blank">https://v1-18.docs.kubernetes.io/docs/concepts/workloads/pods/pod-overview/</a></p></dd><dt id="id-1.8.6.4.4.3.11"><span class="term ">Persistent Volumes</span></dt><dd><p><a class="link" href="https://v1-18.docs.kubernetes.io/docs/concepts/storage/persistent-volumes/" target="_blank">https://v1-18.docs.kubernetes.io/docs/concepts/storage/persistent-volumes/</a></p></dd><dt id="id-1.8.6.4.4.3.12"><span class="term ">Secrets</span></dt><dd><p><a class="link" href="https://v1-18.docs.kubernetes.io/docs/concepts/configuration/secret/" target="_blank">https://v1-18.docs.kubernetes.io/docs/concepts/configuration/secret/</a></p></dd><dt id="id-1.8.6.4.4.3.13"><span class="term ">Service</span></dt><dd><p><a class="link" href="https://v1-18.docs.kubernetes.io/docs/concepts/services-networking/service/" target="_blank">https://v1-18.docs.kubernetes.io/docs/concepts/services-networking/service/</a></p></dd><dt id="id-1.8.6.4.4.3.14"><span class="term ">ReplicaSets</span></dt><dd><p><a class="link" href="https://v1-18.docs.kubernetes.io/docs/concepts/workloads/controllers/replicaset/" target="_blank">https://v1-18.docs.kubernetes.io/docs/concepts/workloads/controllers/replicaset/</a></p></dd></dl></div></div><div class="sect3" id="sec-admin-security-role-create"><div class="titlepage"><div><div><h4 class="title"><span class="number">6.5.1.3 </span><span xmlns:dm="urn:x-suse:ns:docmanager" class="name">Creating Roles</span> <a title="Permalink" class="permalink" href="id-security.html#sec-admin-security-role-create">#</a></h4></div></div></div><p>Roles are defined in YAML files.
To apply role definitions to Kubernetes, use <code class="literal">kubectl apply -f YAML_FILE</code>.
The following examples provide an overview of different use cases of roles.</p><div class="itemizedlist "><ul class="itemizedlist"><li class="listitem "><p>Simple Role for Core Resource:</p><p>This example allows us to <code class="literal">get</code>, <code class="literal">watch</code>, and <code class="literal">list</code> all <code class="literal">pods</code> in the namespace <code class="literal">default</code>.</p><div class="verbatim-wrap highlight yaml"><pre class="screen">kind: Role
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: view-pods <span id="CO5-1"></span><span class="callout">1</span>
  namespace: default <span id="CO5-2"></span><span class="callout">2</span>
rules:
- apiGroups: [""] <span id="CO5-3"></span><span class="callout">3</span>
  resources: ["pods"] <span id="CO5-4"></span><span class="callout">4</span>
  verbs: ["get", "watch", "list"] <span id="CO5-5"></span><span class="callout">5</span></pre></div><div class="calloutlist "><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO5-1"><span class="callout">1</span></a> </p></td><td valign="top" align="left"><p>Name of the role. This is required to associate the rule with
a group or user. For details, refer to
<a class="xref" href="id-security.html#sec-admin-security-role-create_binding" title="6.5.1.4. Create Role Bindings">Section 6.5.1.4, “Create Role Bindings”</a>.</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO5-2"><span class="callout">2</span></a> </p></td><td valign="top" align="left"><p>Namespace the new group should be allowed to access. Use <code class="literal">default</code>
for Kubernetes' default namespace.</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO5-3"><span class="callout">3</span></a> </p></td><td valign="top" align="left"><p>Kubernetes API groups. Use <code class="literal">""</code> for the core group. Use
<code class="literal">kubectl api-resources</code> to list all API groups.</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO5-4"><span class="callout">4</span></a> </p></td><td valign="top" align="left"><p>Kubernetes resources. For a list of available resources, refer to
<a class="xref" href="id-security.html#sec-admin-security-role-resource" title="6.5.1.2. List of Resources">Section 6.5.1.2, “List of Resources”</a>.</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO5-5"><span class="callout">5</span></a> </p></td><td valign="top" align="left"><p>Kubernetes verbs. For a list of available verbs, refer to
<a class="xref" href="id-security.html#sec-admin-security-role-verb" title="6.5.1.1. List of Verbs">Section 6.5.1.1, “List of Verbs”</a>.</p></td></tr></table></div></li><li class="listitem "><p>Cluster Role for Creation of Pods:</p><p>This example creates a cluster role to allow <code class="literal">create pods</code> cluster-wide.
Note the <code class="literal">ClusterRole</code> value for <code class="literal">kind</code>.</p><div class="verbatim-wrap highlight yaml"><pre class="screen">kind: ClusterRole
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: admin-create-pods <span id="CO6-1"></span><span class="callout">1</span>
rules:
- apiGroups: [""] <span id="CO6-2"></span><span class="callout">2</span>
  resources: ["pods"] <span id="CO6-3"></span><span class="callout">3</span>
  verbs: ["create"] <span id="CO6-4"></span><span class="callout">4</span></pre></div><div class="calloutlist "><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO6-1"><span class="callout">1</span></a> </p></td><td valign="top" align="left"><p>Name of the cluster role. This is required to associate the rule with
a group or user. For details, refer to
<a class="xref" href="id-security.html#sec-admin-security-role-create_binding" title="6.5.1.4. Create Role Bindings">Section 6.5.1.4, “Create Role Bindings”</a>.</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO6-2"><span class="callout">2</span></a> </p></td><td valign="top" align="left"><p>Kubernetes API groups. Use <code class="literal">""</code> for the core group. Use
<code class="literal">kubectl api-resources</code> to list all API groups.</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO6-3"><span class="callout">3</span></a> </p></td><td valign="top" align="left"><p>Kubernetes resources. For a list of available resources, refer to <a class="xref" href="id-security.html#sec-admin-security-role-resource" title="6.5.1.2. List of Resources">Section 6.5.1.2, “List of Resources”</a>.</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO6-4"><span class="callout">4</span></a> </p></td><td valign="top" align="left"><p>Kubernetes verbs. For a list of available verbs, refer to <a class="xref" href="id-security.html#sec-admin-security-role-verb" title="6.5.1.1. List of Verbs">Section 6.5.1.1, “List of Verbs”</a>.</p></td></tr></table></div></li></ul></div></div><div class="sect3" id="sec-admin-security-role-create_binding"><div class="titlepage"><div><div><h4 class="title"><span class="number">6.5.1.4 </span><span xmlns:dm="urn:x-suse:ns:docmanager" class="name">Create Role Bindings</span> <a title="Permalink" class="permalink" href="id-security.html#sec-admin-security-role-create_binding">#</a></h4></div></div></div><p>To bind a group or user to a role or cluster role, create a YAML file that contains the role or cluster role binding description.
Then apply the binding with <code class="literal">kubectl apply -f YAML_FILE</code>.
The following examples provide an overview of different use cases of role bindings.</p><div class="itemizedlist "><ul class="itemizedlist"><li class="listitem "><p>Binding a User to a Role:</p><p>This example shows how to bind a user to a defined role.</p><div class="verbatim-wrap highlight yaml"><pre class="screen">kind: RoleBinding
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: &lt;ROLE_BINDING_NAME&gt; <span id="CO7-1"></span><span class="callout">1</span>
  namespace: &lt;NAMESPACE&gt; <span id="CO7-2"></span><span class="callout">2</span>
subjects:
- kind: User
  name: &lt;LDAP_USER_NAME&gt; <span id="CO7-3"></span><span class="callout">3</span>
  apiGroup: rbac.authorization.k8s.io
roleRef:
  kind: Role
  name: &lt;ROLE_NAME&gt; <span id="CO7-4"></span><span class="callout">4</span>
  apiGroup: rbac.authorization.k8s.io</pre></div><div class="calloutlist "><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO7-1"><span class="callout">1</span></a> </p></td><td valign="top" align="left"><p>Defines a name for this new role binding.</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO7-2"><span class="callout">2</span></a> </p></td><td valign="top" align="left"><p>Name of the namespace to which the binding applies.</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO7-3"><span class="callout">3</span></a> </p></td><td valign="top" align="left"><p>Name of the LDAP user to which this binding applies.</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO7-4"><span class="callout">4</span></a> </p></td><td valign="top" align="left"><p>Name of the role used. For defining rules, refer to
<a class="xref" href="id-security.html#sec-admin-security-role-create" title="6.5.1.3. Creating Roles">Section 6.5.1.3, “Creating Roles”</a>.</p></td></tr></table></div></li><li class="listitem "><p>Binding a User to a Cluster Role:</p><p>This example shows how to bind a user to a defined cluster role.</p><div class="verbatim-wrap highlight yaml"><pre class="screen">kind: ClusterRoleBinding
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: &lt;CLUSTER_ROLE_BINDING_NAME&gt; <span id="CO8-1"></span><span class="callout">1</span>
subjects:
- kind: User
  name: &lt;LDAP_USER_NAME&gt; <span id="CO8-2"></span><span class="callout">2</span>
  apiGroup: rbac.authorization.k8s.io
roleRef:
  kind: ClusterRole
  name: &lt;CLUSER_ROLE_NAME&gt; <span id="CO8-3"></span><span class="callout">3</span>
  apiGroup: rbac.authorization.k8s.io</pre></div><div class="calloutlist "><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO8-1"><span class="callout">1</span></a> </p></td><td valign="top" align="left"><p>Defines a name for this new cluster role binding.</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO8-2"><span class="callout">2</span></a> </p></td><td valign="top" align="left"><p>Name of the LDAP user to which this binding applies.</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO8-3"><span class="callout">3</span></a> </p></td><td valign="top" align="left"><p>Name of the cluster role used. For defining rules, refer to <a class="xref" href="id-security.html#sec-admin-security-role-create" title="6.5.1.3. Creating Roles">Section 6.5.1.3, “Creating Roles”</a>.</p></td></tr></table></div></li><li class="listitem "><p>Binding a Group to a Role:</p><p>This example shows how to bind a group to a defined role.</p><div class="verbatim-wrap highlight yaml"><pre class="screen">kind: RoleBinding
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: &lt;ROLE_BINDING_NAME&gt; <span id="CO9-1"></span><span class="callout">1</span>
  namespace: &lt;NAMESPACE&gt; <span id="CO9-2"></span><span class="callout">2</span>
subjects:
- kind: Group
  name: &lt;LDAP_GROUP_NAME&gt; <span id="CO9-3"></span><span class="callout">3</span>
  apiGroup: rbac.authorization.k8s.io
roleRef:
  kind: Role
  name: &lt;ROLE_NAME&gt; <span id="CO9-4"></span><span class="callout">4</span>
  apiGroup: rbac.authorization.k8s.io</pre></div><div class="calloutlist "><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO9-1"><span class="callout">1</span></a> </p></td><td valign="top" align="left"><p>Defines a name for this new role binding.</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO9-2"><span class="callout">2</span></a> </p></td><td valign="top" align="left"><p>Name of the namespace to which the binding applies.</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO9-3"><span class="callout">3</span></a> </p></td><td valign="top" align="left"><p>Name of the LDAP group to which this binding applies.</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO9-4"><span class="callout">4</span></a> </p></td><td valign="top" align="left"><p>Name of the role used. For defining rules, refer to
<a class="xref" href="id-security.html#sec-admin-security-role-create" title="6.5.1.3. Creating Roles">Section 6.5.1.3, “Creating Roles”</a>.</p></td></tr></table></div></li><li class="listitem "><p>Binding a Group to a Cluster Role:</p><p>This example shows how to bind a group to a defined cluster role.</p><div class="verbatim-wrap highlight yaml"><pre class="screen">kind: ClusterRoleBinding
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: &lt;CLUSTER_ROLE_BINDING_NAME&gt; <span id="CO10-1"></span><span class="callout">1</span>
subjects:
- kind: Group
  name: &lt;LDAP_GROUP_NAME&gt; <span id="CO10-2"></span><span class="callout">2</span>
  apiGroup: rbac.authorization.k8s.io
roleRef:
  kind: ClusterRole
  name: &lt;CLUSER_ROLE_NAME&gt; <span id="CO10-3"></span><span class="callout">3</span>
  apiGroup: rbac.authorization.k8s.io</pre></div><div class="calloutlist "><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO10-1"><span class="callout">1</span></a> </p></td><td valign="top" align="left"><p>Defines a name for this new cluster role binding.</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO10-2"><span class="callout">2</span></a> </p></td><td valign="top" align="left"><p>Name of the LDAP group to which this binding applies.</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO10-3"><span class="callout">3</span></a> </p></td><td valign="top" align="left"><p>Name of the cluster role used. For defining rules, refer to <a class="xref" href="id-security.html#sec-admin-security-role-create" title="6.5.1.3. Creating Roles">Section 6.5.1.3, “Creating Roles”</a>.</p></td></tr></table></div></li></ul></div><div id="id-1.8.6.4.6.4" class="admonition important normal"><img class="symbol" alt="Important" title="Important" src="static/images/icon-important.png" /><h6>Important</h6><p>When creating new Roles, ClusterRoles, RoleBindings, and ClusterRoleBindings, it is important to keep in mind the <code class="literal">Principle of Least Privilege</code>:</p><p><span class="emphasis"><em>"define rules such that the account bound to the Role or ClusterRole has the minimum
amount of permissions needed to fulfill its purpose and no more."</em></span></p><p>For instance, granting the <code class="literal">admin</code> ClusterRole to most accounts is most likely unnecessary,
when a reduced-scope role would be enough to fulfill the account’s purpose.
This helps reduce the attack surface if an account is compromised.</p><p>It is also recommended to periodically review your Roles and ClusterRoles to ensure they are still required and are not overly-permissive.</p></div></div></div><div class="sect2" id="sec-admin-security-rbac-apply"><div class="titlepage"><div><div><h3 class="title"><span class="number">6.5.2 </span><span xmlns:dm="urn:x-suse:ns:docmanager" class="name">User Access</span> <a title="Permalink" class="permalink" href="id-security.html#sec-admin-security-rbac-apply">#</a></h3></div></div></div><div class="itemizedlist "><ul class="itemizedlist"><li class="listitem "><p>Using the web browser:</p><div class="orderedlist "><ol class="orderedlist" type="1"><li class="listitem "><p>Go to the login page at <code class="literal">https://&lt;CONTROL_PLANE_IP/FQDN&gt;:32001</code>.</p></li><li class="listitem "><p>Click "Sign In".</p></li><li class="listitem "><p>Choose a login method.</p></li><li class="listitem "><p>Enter login credentials.</p></li><li class="listitem "><p>Download <code class="literal">kubeconfig</code> or self-configure <code class="literal">kubectl</code> with the provided setup instructions.</p></li></ol></div></li><li class="listitem "><p>Using the CLI:</p><div class="orderedlist "><ol class="orderedlist" type="1"><li class="listitem "><p>Run <code class="literal">skuba auth login</code> with Dex server URL <code class="literal">https://&lt;CONTROL_PLANE_IP/FQDN&gt;:32000</code>,
login username and password.</p></li><li class="listitem "><p>The kubeconfig <code class="literal">kubeconf.txt</code> is generated at your current directory.</p></li></ol></div></li></ul></div></div><div class="sect2" id="id-access-kubernetes-resources"><div class="titlepage"><div><div><h3 class="title"><span class="number">6.5.3 </span><span xmlns:dm="urn:x-suse:ns:docmanager" class="name">Access Kubernetes Resources</span> <a title="Permalink" class="permalink" href="id-security.html#id-access-kubernetes-resources">#</a></h3></div></div></div><p>The user can now access resources in the authorized <code class="literal">&lt;NAMESPACE&gt;</code>.</p><p>If the user has the proper permissions to access the resources, the output should look like this:</p><div class="verbatim-wrap"><pre class="screen"># kubectl -n &lt;NAMESPACE&gt; get pod

NAMESPACE     NAME                                 READY   STATUS    RESTARTS   AGE
kube-system   dex-844dc9b8bb-w2zkm                 1/1     Running   0          19d
kube-system   gangway-944dc9b8cb-w2zkm             1/1     Running   0          19d
kube-system   cilium-76glw                         1/1     Running   0          27d
kube-system   cilium-fvgcv                         1/1     Running   0          27d
kube-system   cilium-j5lpx                         1/1     Running   0          27d
kube-system   cilium-operator-5d9cc4fbb7-g5plc     1/1     Running   0          34d
kube-system   cilium-vjf6p                         1/1     Running   8          27d
kube-system   coredns-559fbd6bb4-2r982             1/1     Running   9          46d
kube-system   coredns-559fbd6bb4-89k2j             1/1     Running   9          46d
kube-system   etcd-my-master                       1/1     Running   5          46d
kube-system   kube-apiserver-&lt;CLUSTER_NAME&gt;            1/1     Running   0          19d
kube-system   kube-controller-manager-my-master    1/1     Running   14         46d
kube-system   kube-proxy-62hls                     1/1     Running   4          46d
kube-system   kube-proxy-fhswj                     1/1     Running   0          46d
kube-system   kube-proxy-r4h42                     1/1     Running   1          39d
kube-system   kube-proxy-xsdf4                     1/1     Running   0          39d
kube-system   kube-scheduler-my-master             1/1     Running   13         46d</pre></div><p>If the user does not have the right permissions to access a resource,
they will receive a <code class="literal">Forbidden</code> message.</p><div class="verbatim-wrap"><pre class="screen">Error from server (Forbidden): pods is forbidden</pre></div></div><div class="sect2" id="id-oidc-tokens"><div class="titlepage"><div><div><h3 class="title"><span class="number">6.5.4 </span><span xmlns:dm="urn:x-suse:ns:docmanager" class="name">OIDC Tokens</span> <a title="Permalink" class="permalink" href="id-security.html#id-oidc-tokens">#</a></h3></div></div></div><p>The kubeconfig file (<code class="literal">kubeconf.txt</code>) contains the OIDC tokens necessary to perform authentication and authorization in the cluster.
OIDC tokens have an <span class="strong"><strong>expiration date</strong></span> which means that they need to be refreshed after some time.</p><div id="id-1.8.6.7.3" class="admonition important normal"><img class="symbol" alt="Important" title="Important" src="static/images/icon-important.png" /><h6>Important</h6><p>If you use the same user in multiple <code class="literal">kubeconfig</code> files distributed among multiple machines,
this can lead to issues. Due to the nature of access and refresh tokens (<a class="link" href="https://tools.ietf.org/html/rfc6749#page-10" target="_blank">https://tools.ietf.org/html/rfc6749#page-10</a>) only one of the machines will be fully able to refresh the token set at any given time.</p><p>The user will be able to download multiple 'kubeconfig' files. However, the file with the same user is likely to be valid only for single access until expiration.</p><p>Dex regards one session per user. The <code class="literal">id-token</code> and <code class="literal">refresh-token</code> are refreshed together.
If a second user is trying to login to get a new <code class="literal">id-token</code>, Dex will invalidate the previous <code class="literal">id-token</code> and <code class="literal">refresh-token</code> for the first user.
The first user is still able to continue using the old <code class="literal">id-token</code> until expiration. After expiration, the first user is not allowed to refresh the <code class="literal">id-token</code> due to the invalid <code class="literal">refresh-token</code>.
Only the second user will have a valid <code class="literal">refresh-token</code> now. The first user will encounter an error like: <code class="literal">"msg="failed to rotate keys: keys already rotated by another server instance"</code>.</p><p>If sharing the same <code class="literal">id-token</code> in many places, all of them can be used until expiration.
The first user to refresh the <code class="literal">id-token</code> and <code class="literal">refresh token</code> will be able to continue accessing the cluster.
All other users will encounter an error <code class="literal">Refresh token is invalid or has already been claimed by another client</code> because the <code class="literal">refresh-token</code> got updated by the first user.</p><p>Please use separate users for each <code class="literal">kubeconfig</code> file to avoid this situation.
Find out how to add more users in <a class="xref" href="id-security.html#sec-admin-security-users-add" title="6.4.4.1. Adding a New User">Section 6.4.4.1, “Adding a New User”</a>.
You can also check information about the user and the respective OIDC tokens in the <code class="literal">kubeconfig</code> file under the <code class="literal">users</code> section:</p><div class="verbatim-wrap"><pre class="screen">users:
- name: myuser
  user:
    auth-provider:
      config:
        client-id: oidc
        client-secret: &lt;SECRET&gt;
        id-token:  &lt;ID_TOKEN&gt;
        idp-issuer-url: https://&lt;IP&gt;:&lt;PORT&gt;
        refresh-token: &lt;REFRESH_TOKEN&gt;
      name: oidc</pre></div></div></div></div><div class="sect1" id="admission"><div class="titlepage"><div><div><h2 class="title"><span class="number">6.6 </span><span xmlns:dm="urn:x-suse:ns:docmanager" class="name">Admission Controllers</span> <a title="Permalink" class="permalink" href="id-security.html#admission">#</a></h2></div></div></div><div class="sect2" id="id-introduction"><div class="titlepage"><div><div><h3 class="title"><span class="number">6.6.1 </span><span xmlns:dm="urn:x-suse:ns:docmanager" class="name">Introduction</span> <a title="Permalink" class="permalink" href="id-security.html#id-introduction">#</a></h3></div></div></div><p>After user authentication and authorization, <span class="strong"><strong>admission</strong></span> takes place to complete the access control for the Kubernetes API.
As the final step in the access control process, admission enhances the security layer by mandating a reasonable security baseline across a specific namespace or the entire cluster.
The built-in PodSecurityPolicy admission controller is perhaps the most prominent example of it.</p><p>Apart from the security aspect, admission controllers can enforce custom policies to adhere to certain best-practices such as having good labels, annotation, resource limits, or other settings.
It is worth noting that instead of only validating the request, admission controllers are also capable of "fixing" a request by mutating it, such as automatically adding resource limits if the user forgets to.</p><p>The admission is controlled by admission controllers which may only be configured by the cluster administrator. The admission control process happens in <span class="strong"><strong>two phases</strong></span>:</p><div class="orderedlist "><ol class="orderedlist" type="1"><li class="listitem "><p>In the first phase, <span class="strong"><strong>mutating</strong></span> admission controllers are run. They are empowered to automatically change the requested object to comply with certain cluster policies by making modifications to it if needed.</p></li><li class="listitem "><p>In the second phase, <span class="strong"><strong>validating</strong></span> admission controllers are run. Based on the results of the previous mutating phase, an admission controller can either allow the request to proceed and reach <code class="literal">etcd</code> or deny it.</p></li></ol></div><div id="id-1.8.7.2.6" class="admonition important normal"><img class="symbol" alt="Important" title="Important" src="static/images/icon-important.png" /><h6>Important</h6><p>If any of the controllers in either phase reject the request, the entire request is rejected immediately and an error is returned to the end-user.</p></div></div><div class="sect2" id="id-configured-admission-controllers"><div class="titlepage"><div><div><h3 class="title"><span class="number">6.6.2 </span><span xmlns:dm="urn:x-suse:ns:docmanager" class="name">Configured admission controllers</span> <a title="Permalink" class="permalink" href="id-security.html#id-configured-admission-controllers">#</a></h3></div></div></div><div id="id-1.8.7.3.2" class="admonition important normal"><img class="symbol" alt="Important" title="Important" src="static/images/icon-important.png" /><h6>Important</h6><p>Any modification of this list prior to the creation of the cluster will be overwritten by these default settings.</p><p>The ability to add or remove individual admission controllers will be provided with one of the upcoming releases of SUSE CaaS Platform.</p></div><p>The complete list of admission controllers can be found at <a class="link" href="https://v1-18.docs.kubernetes.io/docs/reference/access-authn-authz/admission-controllers/#what-does-each-admission-controller-do" target="_blank">https://v1-18.docs.kubernetes.io/docs/reference/access-authn-authz/admission-controllers/#what-does-each-admission-controller-do</a></p><p>The default admission controllers enabled in SUSE CaaS Platform are:</p><div class="orderedlist "><ol class="orderedlist" type="1"><li class="listitem "><p><code class="literal">NodeRestriction</code></p></li><li class="listitem "><p><code class="literal">PodSecurityPolicy</code></p></li></ol></div></div></div><div class="sect1" id="id-pod-security-policies"><div class="titlepage"><div><div><h2 class="title"><span class="number">6.7 </span><span xmlns:dm="urn:x-suse:ns:docmanager" class="name">Pod Security Policies</span> <a title="Permalink" class="permalink" href="id-security.html#id-pod-security-policies">#</a></h2></div></div></div><div id="id-1.8.8.2" class="admonition note normal"><img class="symbol" alt="Note" title="Note" src="static/images/icon-note.png" /><h6>Note</h6><p>Please note that criteria for designing PodSecurityPolicy are not part of this document.</p></div><p>"Pod Security Policy" (stylized as <code class="literal">PodSecurityPolicy</code> and abbreviated "PSP") is a security
measure implemented by Kubernetes to control which specifications a pod must meet
to be allowed to run in the cluster. They control various aspects of execution of
pods and interactions with other parts of the software infrastructure.</p><p>You can find more general information about PodSecurityPolicy in the <a class="link" href="https://v1-18.docs.kubernetes.io/docs/concepts/policy/pod-security-policy/" target="_blank">Kubernetes Docs</a>.</p><p>User access to the cluster is controlled via "Role Based Access Control (RBAC)".
Each PodSecurityPolicy is associated with one or more users or
service accounts so they are allowed to launch pods with the associated
specifications. The policies are associated with users or  service accounts via
role bindings.</p><div id="id-1.8.8.6" class="admonition note normal"><img class="symbol" alt="Note" title="Note" src="static/images/icon-note.png" /><h6>Note</h6><p>The default policies shipped with SUSE CaaS Platform are a good start, but depending
on security requirements, adjustments should be made or additional policies should be created.</p></div><div class="sect2" id="id-default-policies"><div class="titlepage"><div><div><h3 class="title"><span class="number">6.7.1 </span><span xmlns:dm="urn:x-suse:ns:docmanager" class="name">Default Policies</span> <a title="Permalink" class="permalink" href="id-security.html#id-default-policies">#</a></h3></div></div></div><p>SUSE CaaS Platform 4 currently ships with two default policies:</p><div class="itemizedlist "><ul class="itemizedlist"><li class="listitem "><p>Privileged (full access everywhere)</p></li><li class="listitem "><p>Unprivileged (only very basic access)</p></li></ul></div><p>All pods running the containers for the basic SUSE CaaS Platform software are
deployed into the <code class="literal">kube-system</code> namespace and run with the "privileged" policy.</p><p>All authenticated system users (<code class="literal">group system:authenticated</code>) and service accounts in kube-system (<code class="literal">system:serviceaccounts:kube-system</code>)
have a RoleBinding (<code class="literal">suse:caasp:psp:privileged</code>) to run pods using the privileged policy in the kube-system namespace.</p><p>Any other pods launched in any other namespace are, by default, deployed in
unprivileged mode.</p><div id="id-1.8.8.7.7" class="admonition important normal"><img class="symbol" alt="Important" title="Important" src="static/images/icon-important.png" /><h6>Important</h6><p>You must configure RBAC rules and PodSecurityPolicy to provide proper functionality
and security.</p></div></div><div class="sect2" id="id-policy-definition"><div class="titlepage"><div><div><h3 class="title"><span class="number">6.7.2 </span><span xmlns:dm="urn:x-suse:ns:docmanager" class="name">Policy Definition</span> <a title="Permalink" class="permalink" href="id-security.html#id-policy-definition">#</a></h3></div></div></div><p>The policy definitions are embedded in the <a class="link" href="https://github.com/SUSE/skuba/blob/master/pkg/skuba/actions/cluster/init/manifests.go" target="_blank">cluster bootstrap manifest (GitHub)</a>.</p><p>During the bootstrap with <code class="literal">skuba</code>, the policy files will be stored on your
workstation in the cluster definition folder under <code class="literal">addons/psp/base</code>. These policy files
will be installed automatically for all cluster nodes.</p><p>The file names of the files created are:</p><div class="itemizedlist "><ul class="itemizedlist"><li class="listitem "><p><code class="literal">podsecuritypolicy-unprivileged.yaml</code></p><p>and</p></li><li class="listitem "><p><code class="literal">podsecuritypolicy-privileged.yaml</code>.</p></li></ul></div><div class="sect3" id="configure-psp"><div class="titlepage"><div><div><h4 class="title"><span class="number">6.7.2.1 </span><span xmlns:dm="urn:x-suse:ns:docmanager" class="name">Policy File Examples</span> <a title="Permalink" class="permalink" href="id-security.html#configure-psp">#</a></h4></div></div></div><p>This is the unprivileged policy as a configuration file. You can use this
as a basis to develop your own PodSecurityPolicy which should be saved as <code class="literal">custom-psp.yaml</code>
<code class="literal">addons/psp/patches</code> directory.</p><div class="verbatim-wrap"><pre class="screen">apiVersion: policy/v1beta1
kind: PodSecurityPolicy
metadata:
  name: suse.caasp.psp.unprivileged
  annotations:
    apparmor.security.beta.kubernetes.io/allowedProfileNames: runtime/default
    apparmor.security.beta.kubernetes.io/defaultProfileName: runtime/default
    seccomp.security.alpha.kubernetes.io/allowedProfileNames: runtime/default
    seccomp.security.alpha.kubernetes.io/defaultProfileName: runtime/default
spec:
  # Privileged
  privileged: false
  # Volumes and File Systems
  volumes:
    # Kubernetes Pseudo Volume Types
    - configMap
    - secret
    - emptyDir
    - downwardAPI
    - projected
    - persistentVolumeClaim
    # Networked Storage
    - nfs
    - rbd
    - cephFS
    - glusterfs
    - fc
    - iscsi
    # Cloud Volumes
    - cinder
    - gcePersistentDisk
    - awsElasticBlockStore
    - azureDisk
    - azureFile
    - vsphereVolume
  allowedHostPaths:
    # Note: We don't allow hostPath volumes above, but set this to a path we
    # control anyway as a belt+braces protection. /dev/null may be a better
    # option, but the implications of pointing this towards a device are
    # unclear.
    - pathPrefix: /opt/kubernetes-hostpath-volumes
  readOnlyRootFilesystem: false
  # Users and groups
  runAsUser:
    rule: RunAsAny
  supplementalGroups:
    rule: RunAsAny
  fsGroup:
    rule: RunAsAny
  # Privilege Escalation
  allowPrivilegeEscalation: false
  defaultAllowPrivilegeEscalation: false
  # Capabilities
  allowedCapabilities: []
  defaultAddCapabilities: []
  requiredDropCapabilities: []
  # Host namespaces
  hostPID: false
  hostIPC: false
  hostNetwork: false
  hostPorts:
  - min: 0
    max: 65535
  # SELinux
  seLinux:
    # SELinux is unused in CaaSP
    rule: 'RunAsAny'
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: suse:caasp:psp:unprivileged
rules:
  - apiGroups: ['extensions']
    resources: ['podsecuritypolicies']
    verbs: ['use']
    resourceNames: ['suse.caasp.psp.unprivileged']
---
# Allow all users and serviceaccounts to use the unprivileged
# PodSecurityPolicy
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: suse:caasp:psp:default
roleRef:
  kind: ClusterRole
  name: suse:caasp:psp:unprivileged
  apiGroup: rbac.authorization.k8s.io
subjects:
- kind: Group
  apiGroup: rbac.authorization.k8s.io
  name: system:serviceaccounts
- kind: Group
  apiGroup: rbac.authorization.k8s.io
  name: system:authenticated</pre></div></div></div><div class="sect2" id="id-creating-a-podsecuritypolicy"><div class="titlepage"><div><div><h3 class="title"><span class="number">6.7.3 </span><span xmlns:dm="urn:x-suse:ns:docmanager" class="name">Creating a PodSecurityPolicy</span> <a title="Permalink" class="permalink" href="id-security.html#id-creating-a-podsecuritypolicy">#</a></h3></div></div></div><p>In order to properly secure and run your Kubernetes workloads you must configure
RBAC rules for your desired users create a PodSecurityPolicy adequate for your respective
workloads and then link the user accounts to the PodSecurityPolicy using (Cluster)RoleBinding.</p><p><a class="link" href="https://v1-18.docs.kubernetes.io/docs/concepts/policy/pod-security-policy/" target="_blank">https://v1-18.docs.kubernetes.io/docs/concepts/policy/pod-security-policy/</a></p></div></div><div class="sect1" id="nginx-ingress"><div class="titlepage"><div><div><h2 class="title"><span class="number">6.8 </span><span xmlns:dm="urn:x-suse:ns:docmanager" class="name">NGINX Ingress Controller</span> <a title="Permalink" class="permalink" href="id-security.html#nginx-ingress">#</a></h2></div></div></div><p>Kubernetes ingress exposes HTTP and HTTPS routes from the outside of a cluster to services created inside the cluster.
An Ingress controller with an ingress controller service is responsible for supporting the Kubernetes ingress.
In order to use Kubernetes ingress, you need to install the ingress controller with the ingress controller service exposed to the outside of the cluster.
Traffic routing is controlled by rules defined on the Ingress resource from the backend services.</p><div class="sect2" id="id-configure-and-deploy-nginx-ingress-controller"><div class="titlepage"><div><div><h3 class="title"><span class="number">6.8.1 </span><span xmlns:dm="urn:x-suse:ns:docmanager" class="name">Configure and deploy NGINX ingress controller</span> <a title="Permalink" class="permalink" href="id-security.html#id-configure-and-deploy-nginx-ingress-controller">#</a></h3></div></div></div><div class="sect3" id="id-define-networking-configuration"><div class="titlepage"><div><div><h4 class="title"><span class="number">6.8.1.1 </span><span xmlns:dm="urn:x-suse:ns:docmanager" class="name">Define networking configuration</span> <a title="Permalink" class="permalink" href="id-security.html#id-define-networking-configuration">#</a></h4></div></div></div><p>Choose which networking configuration the ingress controller should have.
Create a file <code class="literal">nginx-ingress-config-values.yaml</code> with one of the following examples as content:</p><div class="verbatim-wrap"><pre class="screen"># Enable the creation of pod security policy
podSecurityPolicy:
  enabled: false

# Create a specific service account
serviceAccount:
  create: true
  name: nginx-ingress

controller:
  # Number of controller pods
  replicaCount: 3
  [ADD CONTENT HERE] <span id="CO11-1"></span><span class="callout">1</span></pre></div><div class="calloutlist "><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO11-1"><span class="callout">1</span></a> </p></td><td valign="top" align="left"><p>Add one of the following sections at this point to configure for a specific type of exposing the service.</p><div class="itemizedlist "><ul class="itemizedlist"><li class="listitem "><p><span class="strong"><strong>NodePort</strong></span>: The services will be publicly exposed on each node of the cluster, including master nodes, at port <code class="literal">32443</code> for <code class="literal">HTTPS</code>.</p><div class="verbatim-wrap"><pre class="screen">  # Publish services on port HTTPS/32443
  # These services are exposed on each node
  service:
    enableHttp: false
    type: NodePort
    nodePorts:
      https: 32443</pre></div></li><li class="listitem "><p><span class="strong"><strong>External IPs</strong></span>: The services will be exposed on specific nodes of the cluster, at port <code class="literal">443</code> for <code class="literal">HTTPS</code>.</p><div class="verbatim-wrap"><pre class="screen">  # These services are exposed on the node with IP 10.86.4.158
  service:
    enableHttp: false
    externalIPs:
      - 10.86.4.158</pre></div></li><li class="listitem "><p><span class="strong"><strong>LoadBalancer</strong></span>: The services will be exposed on the loadbalancer that the cloud provider serves.</p><div class="verbatim-wrap"><pre class="screen">  # These services are exposed on IP from a cluster cloud provider
  service:
    enableHttp: false
    type: LoadBalancer</pre></div></li></ul></div></td></tr></table></div></div><div class="sect3" id="id-deploy-ingress-controller-from-helm-chart"><div class="titlepage"><div><div><h4 class="title"><span class="number">6.8.1.2 </span><span xmlns:dm="urn:x-suse:ns:docmanager" class="name">Deploy ingress controller from helm chart</span> <a title="Permalink" class="permalink" href="id-security.html#id-deploy-ingress-controller-from-helm-chart">#</a></h4></div></div></div><div id="id-1.8.9.3.3.2" class="admonition tip normal"><img class="symbol" alt="Tip" title="Tip" src="static/images/icon-tip.png" /><h6>Tip</h6><p>For complete instructions on how to install Helm refer to <a class="xref" href="id-software-management.html#helm-install" title="3.1.2.1. Installing Helm">Section 3.1.2.1, “Installing Helm”</a>.</p></div><p>Add the <a class="link" href="https://kubernetes-charts.suse.com/" target="_blank">SUSE helm charts repository</a> by running:</p><div class="verbatim-wrap"><pre class="screen">helm repo add suse https://kubernetes-charts.suse.com</pre></div><p>Then you can deploy the ingress controller and use the previously created configuration file to configure the networking type.</p><div class="verbatim-wrap highlight bash"><pre class="screen">kubectl create namespace nginx-ingress
helm install nginx-ingress suse/nginx-ingress \
--namespace nginx-ingress \
--values nginx-ingress-config-values.yaml</pre></div><p>The result should be two running pods:</p><div class="verbatim-wrap highlight bash"><pre class="screen">kubectl -n nginx-ingress get pod
NAME                                             READY     STATUS    RESTARTS   AGE
nginx-ingress-controller-74cffccfc-p8xbb         1/1       Running   0          4s
nginx-ingress-default-backend-6b9b546dc8-mfkjk   1/1       Running   0          4s</pre></div><p>Depending on the networking configuration you chose before, the result should be two services:</p><div class="itemizedlist "><ul class="itemizedlist"><li class="listitem "><p><span class="strong"><strong>NodePort</strong></span></p><div class="verbatim-wrap highlight bash"><pre class="screen">kubectl get svc -n nginx-ingress
NAME                            TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)         AGE
nginx-ingress-controller        NodePort    10.100.108.7     &lt;none&gt;        443:32443/TCP   2d1h
nginx-ingress-default-backend   ClusterIP   10.109.118.128   &lt;none&gt;        80/TCP          2d1h</pre></div></li><li class="listitem "><p><span class="strong"><strong>External IPs</strong></span></p><div class="verbatim-wrap highlight bash"><pre class="screen">kubectl get svc -n nginx-ingress
NAME                            TYPE           CLUSTER-IP     EXTERNAL-IP   PORT(S)         AGE
nginx-ingress-controller        LoadBalancer   10.103.103.27  10.86.4.158   443:30275/TCP   12s
nginx-ingress-default-backend   ClusterIP      10.100.48.17   &lt;none&gt;        80/TCP          12s</pre></div></li><li class="listitem "><p><span class="strong"><strong>LoadBalancer</strong></span></p><div class="verbatim-wrap highlight bash"><pre class="screen">kubectl get svc -n nginx-ingress
NAME                            TYPE           CLUSTER-IP       EXTERNAL-IP   PORT(S)         AGE
nginx-ingress-controller        LoadBalancer   10.106.160.255   10.86.5.176   443:31868/TCP   3h58m
nginx-ingress-default-backend   ClusterIP      10.111.140.50    &lt;none&gt;        80/TCP          3h58m</pre></div></li></ul></div></div><div class="sect3" id="id-create-dns-entries"><div class="titlepage"><div><div><h4 class="title"><span class="number">6.8.1.3 </span><span xmlns:dm="urn:x-suse:ns:docmanager" class="name">Create DNS entries</span> <a title="Permalink" class="permalink" href="id-security.html#id-create-dns-entries">#</a></h4></div></div></div><p>You should configure proper DNS names in any production environment. <code class="literal">k8s-dashboard.com</code> will be the domain name we will use in the ingress resource.
These values are only for example purposes.</p><div class="itemizedlist "><ul class="itemizedlist"><li class="listitem "><p><span class="strong"><strong>NodePort</strong></span></p></li></ul></div><p>The services will be publicly exposed on each node of the cluster at port <code class="literal">32443</code> for HTTPS.
In this example, we will use a worker node with IP <code class="literal">10.86.14.58</code>.</p><div class="verbatim-wrap"><pre class="screen">k8s-dashboard.com                      IN  A       10.86.14.58</pre></div><p>Or add this entry to /etc/hosts</p><div class="verbatim-wrap"><pre class="screen">10.86.14.58 k8s-dashboard.com</pre></div><div class="itemizedlist "><ul class="itemizedlist"><li class="listitem "><p><span class="strong"><strong>External IPs</strong></span></p></li></ul></div><p>The services will be exposed on a specific node of the cluster, at the assigned port for HTTPS.
In this example, we used the external IP <code class="literal">10.86.4.158</code>.</p><div class="verbatim-wrap"><pre class="screen">k8s-dashboard.com                      IN  A       10.86.4.158</pre></div><p>Or add this entry to /etc/hosts</p><div class="verbatim-wrap"><pre class="screen">10.86.4.158 k8s-dashboard.com</pre></div><div class="itemizedlist "><ul class="itemizedlist"><li class="listitem "><p><span class="strong"><strong>LoadBalancer</strong></span></p></li></ul></div><p>The services will be exposed on an assigned node of the cluster, at the assigned port for HTTPS.
In this example, LoadBalancer provided the external IP <code class="literal">10.86.5.176</code>.</p><div class="verbatim-wrap"><pre class="screen">k8s-dashboard.com                      IN  A       10.86.5.176</pre></div><p>Or add this entry to /etc/hosts</p><div class="verbatim-wrap"><pre class="screen">10.86.5.176 k8s-dashboard.com</pre></div></div></div><div class="sect2" id="id-deploy-kubernetes-dashboard-as-an-example"><div class="titlepage"><div><div><h3 class="title"><span class="number">6.8.2 </span><span xmlns:dm="urn:x-suse:ns:docmanager" class="name">Deploy Kubernetes Dashboard as an example</span> <a title="Permalink" class="permalink" href="id-security.html#id-deploy-kubernetes-dashboard-as-an-example">#</a></h3></div></div></div><div id="id-1.8.9.4.2" class="admonition important normal"><img class="symbol" alt="Important" title="Important" src="static/images/icon-important.png" /><h6>Important</h6><p>This example uses the upstream chart for the Kubernetes dashboard. There is currently no officially supported
version of the Kubernetes dashboard available from SUSE.</p></div><div class="orderedlist "><ol class="orderedlist" type="1"><li class="listitem "><p>Deploy Kubernetes dashboard.</p><div class="verbatim-wrap highlight bash"><pre class="screen">kubectl apply -f https://raw.githubusercontent.com/kubernetes/dashboard/v2.0.0/aio/deploy/recommended.yaml</pre></div></li><li class="listitem "><p>Create the <code class="literal">cluster-admin</code> account to access the Kubernetes dashboard.</p><p>This will show how to create simple admin user using Service Account, grant it the admin permission then use the token to access the kubernetes dashboard.</p><div class="verbatim-wrap highlight bash"><pre class="screen">kubectl create serviceaccount dashboard-admin -n kube-system

kubectl create clusterrolebinding dashboard-admin \
--clusterrole=cluster-admin \
--serviceaccount=kube-system:dashboard-admin</pre></div></li><li class="listitem "><p>Create the TLS secret.</p><p>Please refer to <a class="xref" href="id-security.html#trusted-server-certificate" title="6.9.9.1.1. Trusted Server Certificate">Section 6.9.9.1.1, “Trusted Server Certificate”</a> on how to sign the trusted certificate. In this example, crt and key are generated by a self-signed certificate.</p><div class="verbatim-wrap highlight bash"><pre class="screen">openssl req -x509 -nodes -days 365 -newkey rsa:2048 \
-keyout /tmp/dashboard-tls.key -out /tmp/dashboard-tls.crt \
-subj "/CN=k8s-dashboard.com/O=k8s-dashboard"

kubectl create secret tls dashboard-tls \
--key /tmp/dashboard-tls.key --cert /tmp/dashboard-tls.crt \
-n kubernetes-dashboard</pre></div></li><li class="listitem "><p>Create the ingress resource.</p><p>We will create an ingress to access the backend service using the ingress controller.
Create <code class="literal">dashboard-ingress.yaml</code> with the appropriate values</p><div class="verbatim-wrap"><pre class="screen">apiVersion: networking.k8s.io/v1beta1
kind: Ingress
metadata:
  name: dashboard-ingress
  namespace: kubernetes-dashboard
  annotations:
    kubernetes.io/ingress.class: nginx
    ingress.kubernetes.io/ssl-passthrough: "true"
    nginx.ingress.kubernetes.io/secure-backends: "true"
    nginx.ingress.kubernetes.io/rewrite-target: /
spec:
  tls:
    - hosts:
      - k8s-dashboard.com
      secretName: dashboard-tls
  rules:
  - host: k8s-dashboard.com
    http:
      paths:
      - path: /
        backend:
          serviceName: kubernetes-dashboard
          servicePort: 443</pre></div></li><li class="listitem "><p>Deploy dashboard ingress.</p><div class="verbatim-wrap highlight bash"><pre class="screen">kubectl apply -f dashboard-ingress.yaml</pre></div><p>The result will look like this:</p><div class="verbatim-wrap highlight bash"><pre class="screen">kubectl get ing -n kubernetes-dashboard
NAMESPACE            NAME                 HOSTS               ADDRESS   PORTS     AGE
kubernetes-dashboard dashboard-ingress    k8s-dashboard.com             80, 443   2d</pre></div></li><li class="listitem "><p>Access Kubernetes Dashboard
Kubernetes dashboard will be accessible through ingress domain name with the configured ingress controller port.</p><div id="id-1.8.9.4.3.6.2" class="admonition note normal"><img class="symbol" alt="Note" title="Note" src="static/images/icon-note.png" /><h6>Note: Access Token</h6><p>Now we’re ready to get the token from dashboard-admin by following command.</p><div class="verbatim-wrap highlight bash"><pre class="screen">kubectl describe secrets -n kube-system \
$(kubectl -n kube-system get secret | awk '/dashboard-admin/{print $1}')</pre></div></div><div class="itemizedlist "><ul class="itemizedlist"><li class="listitem "><p><span class="strong"><strong>NodePort</strong></span>: <code class="literal">https://k8s-dashboard.com:32443</code></p></li><li class="listitem "><p><span class="strong"><strong>External IPs</strong></span>: <code class="literal">https://k8s-dashboard.com</code></p></li><li class="listitem "><p><span class="strong"><strong>LoadBalancer</strong></span>: <code class="literal">https://k8s-dashboard.com</code></p></li></ul></div></li></ol></div></div></div><div class="sect1" id="id-certificates"><div class="titlepage"><div><div><h2 class="title"><span class="number">6.9 </span><span xmlns:dm="urn:x-suse:ns:docmanager" class="name">Certificates</span> <a title="Permalink" class="permalink" href="id-security.html#id-certificates">#</a></h2></div></div></div><p>During the installation of SUSE CaaS Platform, a CA (Certificate Authority) certificate is generated,
which is then used to authenticate and verify all communication. This process also creates
and distributes client and server certificates for the components.</p><div class="sect2" id="id-communication-security"><div class="titlepage"><div><div><h3 class="title"><span class="number">6.9.1 </span><span xmlns:dm="urn:x-suse:ns:docmanager" class="name">Communication Security</span> <a title="Permalink" class="permalink" href="id-security.html#id-communication-security">#</a></h3></div></div></div><p>Communication is secured with TLS v1.2 using the AES 128 CBC cipher.
All certificates are 2048 bit RSA encrypted.</p></div><div class="sect2" id="id-certificate-validity"><div class="titlepage"><div><div><h3 class="title"><span class="number">6.9.2 </span><span xmlns:dm="urn:x-suse:ns:docmanager" class="name">Certificate Validity</span> <a title="Permalink" class="permalink" href="id-security.html#id-certificate-validity">#</a></h3></div></div></div><p>The CA certificate is valid for 3650 days (10 years) by default.
Client and server certificates are valid for 365 days (1 year) by default.</p></div><div class="sect2" id="id-certificate-location"><div class="titlepage"><div><div><h3 class="title"><span class="number">6.9.3 </span><span xmlns:dm="urn:x-suse:ns:docmanager" class="name">Certificate Location</span> <a title="Permalink" class="permalink" href="id-security.html#id-certificate-location">#</a></h3></div></div></div><p>Required CAs for SUSE CaaS Platform are stored on all control plane nodes:</p><div class="informaltable"><table class="informaltable" border="1"><colgroup><col class="col_1" /><col class="col_2" /><col class="col_3" /></colgroup><thead><tr><th align="left" valign="top">Common Name</th><th align="left" valign="top">Path</th><th align="left" valign="top">Description</th></tr></thead><tbody><tr><td align="left" valign="top"><p>kubernetes</p></td><td align="left" valign="top"><p>/etc/kubernetes/pki/ca.crt,key</p></td><td align="left" valign="top"><p>kubernetes general CA</p></td></tr><tr><td align="left" valign="top"><p>etcd-ca</p></td><td align="left" valign="top"><p>/etc/kubernetes/pki/etcd/ca.crt,key</p></td><td align="left" valign="top"><p>Etcd cluster</p></td></tr><tr><td align="left" valign="top"><p>kubelet-ca</p></td><td align="left" valign="top"><p>/var/lib/kubelet/pki/kubelet-ca.crt,key</p></td><td align="left" valign="top"><p>Kubelet components</p></td></tr><tr><td align="left" valign="top"><p>front-proxy-ca</p></td><td align="left" valign="top"><p>/etc/kubernetes/pki/front-proxy-ca.crt,key</p></td><td align="left" valign="top"><p>Front-proxy components</p></td></tr></tbody></table></div><p>The control plane certificates stored in the Kubernetes cluster on control plane nodes:</p><div class="informaltable"><table class="informaltable" border="1"><colgroup><col class="col_1" /><col class="col_2" /><col class="col_3" /><col class="col_4" /></colgroup><thead><tr><th align="left" valign="top">Common Name</th><th align="left" valign="top">Parent CA</th><th align="left" valign="top">Path</th><th align="left" valign="top">Kind</th></tr></thead><tbody><tr><td align="left" valign="top"><p>kubernetes</p></td><td align="left" valign="top"> </td><td align="left" valign="top"><p>/etc/kubernetes/pki/ca.crt,key</p></td><td align="left" valign="top"><p>CA</p></td></tr><tr><td align="left" valign="top"><p>kube-apiserver</p></td><td align="left" valign="top"><p>kubernetes</p></td><td align="left" valign="top"><p>/etc/kubernetes/pki/apiserver.crt,key</p></td><td align="left" valign="top"><p>Server</p></td></tr><tr><td align="left" valign="top"><p>kube-apiserver-etcd-client</p></td><td align="left" valign="top"><p>etcd-ca</p></td><td align="left" valign="top"><p>/etc/kubernetes/pki/apiserver-etcd-client.crt,key</p></td><td align="left" valign="top"><p>Client</p></td></tr><tr><td align="left" valign="top"><p>kube-apiserver-kubelet-client</p></td><td align="left" valign="top"><p>kubernetes</p></td><td align="left" valign="top"><p>/etc/kubernetes/pki/apiserver-kubelet-client.crt,key</p></td><td align="left" valign="top"><p>Client</p></td></tr><tr><td align="left" valign="top"><p>etcd-ca</p></td><td align="left" valign="top"> </td><td align="left" valign="top"><p>/etc/kubernetes/pki/etcd/ca.crt,key</p></td><td align="left" valign="top"><p>CA</p></td></tr><tr><td align="left" valign="top"><p>kube-etcd-healthcheck-client</p></td><td align="left" valign="top"><p>etcd-ca</p></td><td align="left" valign="top"><p>/etc/kubernetes/pki/etcd/healthcheck-client.crt,key</p></td><td align="left" valign="top"><p>Client</p></td></tr><tr><td align="left" valign="top"><p>kube-etcd-peer</p></td><td align="left" valign="top"><p>etcd-ca</p></td><td align="left" valign="top"><p>/etc/kubernetes/pki/etcd/peer.crt,key</p></td><td align="left" valign="top"><p>Server,Client</p></td></tr><tr><td align="left" valign="top"><p>kube-etcd-server</p></td><td align="left" valign="top"><p>etcd-ca</p></td><td align="left" valign="top"><p>/etc/kubernetes/pki/etcd/server.crt,key</p></td><td align="left" valign="top"><p>Server,Client</p></td></tr><tr><td align="left" valign="top"><p>kubelet-ca</p></td><td align="left" valign="top"> </td><td align="left" valign="top"><p>/var/lib/kubeket/pki/kubelet-ca.crt,key</p></td><td align="left" valign="top"><p>CA</p></td></tr><tr><td align="left" valign="top"><p>system:node:&lt;nodeName&gt;</p></td><td align="left" valign="top"><p>kubernetes</p></td><td align="left" valign="top"><p>/var/lib/kubeket/pki/kubelet-client-current.pem</p></td><td align="left" valign="top"><p>Client</p></td></tr><tr><td align="left" valign="top"><p>system:node:&lt;nodeName&gt;</p></td><td align="left" valign="top"><p>kubelet-ca</p></td><td align="left" valign="top"><p>/var/lib/kubelet/pki/kubelet-server-current.pem</p></td><td align="left" valign="top"><p>Server</p></td></tr><tr><td align="left" valign="top"><p>front-proxy-ca</p></td><td align="left" valign="top"> </td><td align="left" valign="top"><p>/etc/kubernetes/pki/front-proxy-ca.crt,key</p></td><td align="left" valign="top"><p>CA</p></td></tr><tr><td align="left" valign="top"><p>front-proxy-client</p></td><td align="left" valign="top"><p>front-proxy-ca</p></td><td align="left" valign="top"><p>/etc/kubernetes/pki/front-proxy-client.crt,key</p></td><td align="left" valign="top"><p>Client</p></td></tr><tr><td align="left" valign="top"><p>kubernetes-admin</p></td><td align="left" valign="top"><p>kubernetes</p></td><td align="left" valign="top"><p>/etc/kubernetes/admin.conf</p></td><td align="left" valign="top"><p>Client</p></td></tr><tr><td align="left" valign="top"><p>system:kube-controller-manager</p></td><td align="left" valign="top"><p>kubernetes</p></td><td align="left" valign="top"><p>/etc/kubernetes/controller-manager.conf</p></td><td align="left" valign="top"><p>Client</p></td></tr><tr><td align="left" valign="top"><p>system:kube-scheduler</p></td><td align="left" valign="top"><p>kubernetes</p></td><td align="left" valign="top"><p>/etc/kubernetes/scheduler.conf</p></td><td align="left" valign="top"><p>Client</p></td></tr><tr><td align="left" valign="top"><p>system:node:&lt;nodeName&gt;</p></td><td align="left" valign="top"><p>kubernetes</p></td><td align="left" valign="top"><p>/etc/kubernetes/kubelet.conf</p></td><td align="left" valign="top"><p>Client</p></td></tr></tbody></table></div><div id="id-1.8.10.5.6" class="admonition warning normal"><img class="symbol" alt="Warning" title="Warning" src="static/images/icon-warning.png" /><h6>Warning</h6><p>If a node was bootstrapped/joined before Kubernetes version 1.17, you have to manually modify the contents of <code class="literal">kubelet.conf</code> to point to the automatically rotated kubelet client certificates by replacing <code class="literal">client-certificate-data</code> and <code class="literal">client-key-data</code> with:</p><div class="verbatim-wrap highlight bash"><pre class="screen">client-certificate: /var/lib/kubelet/pki/kubelet-client-current.pem
client-key: /var/lib/kubelet/pki/kubelet-client-current.pem</pre></div></div><p>The addon certificates stored in the Kubernetes cluster Secret resource:</p><div class="informaltable"><table class="informaltable" border="1"><colgroup><col class="col_1" /><col class="col_2" /><col class="col_3" /><col class="col_4" /></colgroup><thead><tr><th align="left" valign="top">Common Name</th><th align="left" valign="top">Parent CA</th><th align="left" valign="top">Secret Resource Name</th><th align="left" valign="top">Kind</th></tr></thead><tbody><tr><td align="left" valign="top"><p>oidc-dex</p></td><td align="left" valign="top"><p>kubernetes</p></td><td align="left" valign="top"><p>oidc-dex-cert</p></td><td align="left" valign="top"><p>Server</p></td></tr><tr><td align="left" valign="top"><p>oidc-gangway</p></td><td align="left" valign="top"><p>kubernetes</p></td><td align="left" valign="top"><p>oidc-gangway-cert</p></td><td align="left" valign="top"><p>Server</p></td></tr><tr><td align="left" valign="top"><p>metrics-server</p></td><td align="left" valign="top"><p>kubernetes</p></td><td align="left" valign="top"><p>metrics-server-cert</p></td><td align="left" valign="top"><p>Server</p></td></tr><tr><td align="left" valign="top"><p>cilium-etcd-client</p></td><td align="left" valign="top"><p>etcd-ca</p></td><td align="left" valign="top"><p>cilium-secret</p></td><td align="left" valign="top"><p>Client</p></td></tr></tbody></table></div></div><div class="sect2" id="id-monitoring-certificates"><div class="titlepage"><div><div><h3 class="title"><span class="number">6.9.4 </span><span xmlns:dm="urn:x-suse:ns:docmanager" class="name">Monitoring Certificates</span> <a title="Permalink" class="permalink" href="id-security.html#id-monitoring-certificates">#</a></h3></div></div></div><p>We use cert-exporter to monitor nodes' on-host certificates and addons' secret certificates. The cert-exporter collects the metrics of certificates expiration periodically (1 hour by default) and exposes them through the <code class="literal">/metrics</code> endpoint. Then, the Prometheus server can scrape these metrics from the endpoint periodically.</p><div class="verbatim-wrap highlight bash"><pre class="screen">helm repo add suse https://kubernetes-charts.suse.com
helm install &lt;RELEASE_NAME&gt; suse/cert-exporter</pre></div><div class="sect3" id="id-prerequisites-2"><div class="titlepage"><div><div><h4 class="title"><span class="number">6.9.4.1 </span><span xmlns:dm="urn:x-suse:ns:docmanager" class="name">Prerequisites</span> <a title="Permalink" class="permalink" href="id-security.html#id-prerequisites-2">#</a></h4></div></div></div><div class="orderedlist "><ol class="orderedlist" type="1"><li class="listitem "><p>To monitor certificates, we need to set up monitoring stack by following the <a class="xref" href="id-monitoring.html#monitoring-stack" title="8.1. Monitoring Stack">Section 8.1, “Monitoring Stack”</a> on how to deploy it.</p></li><li class="listitem "><p>Label the skuba addon certificates</p><div class="verbatim-wrap highlight bash"><pre class="screen">kubectl label --overwrite secret oidc-dex-cert -n kube-system caasp.suse.com/skuba-addon=true
kubectl label --overwrite secret oidc-gangway-cert -n kube-system caasp.suse.com/skuba-addon=true
kubectl label --overwrite secret metrics-server-cert -n kube-system caasp.suse.com/skuba-addon=true
kubectl label --overwrite secret cilium-secret -n kube-system caasp.suse.com/skuba-addon=true</pre></div><div id="id-1.8.10.6.4.2.2.3" class="admonition note normal"><img class="symbol" alt="Note" title="Note" src="static/images/icon-note.png" /><h6>Note</h6><p>You might see the following console output:</p><div class="verbatim-wrap highlight bash"><pre class="screen">secret/oidc-dex-cert not labeled
secret/oidc-gangway-cert not labeled
secret/metrics-server-cert not labeled
secret/cilium-secret not labeled</pre></div><p>This is because <code class="literal">skuba</code> has already added the labels for you.</p></div></li></ol></div></div><div class="sect3" id="id-prometheus-alerts"><div class="titlepage"><div><div><h4 class="title"><span class="number">6.9.4.2 </span><span xmlns:dm="urn:x-suse:ns:docmanager" class="name">Prometheus Alerts</span> <a title="Permalink" class="permalink" href="id-security.html#id-prometheus-alerts">#</a></h4></div></div></div><p>Use Prometheus alerts to reactively receive the status of the certificates, follow the <a class="xref" href="id-monitoring.html#alertmanager-configuration-example" title="8.1.3.2.3. Alertmanager Configuration Example">Section 8.1.3.2.3, “Alertmanager Configuration Example”</a> on how to configure the Prometheus Alertmanager and Prometheus Server.</p></div><div class="sect3" id="id-grafana-dashboards"><div class="titlepage"><div><div><h4 class="title"><span class="number">6.9.4.3 </span><span xmlns:dm="urn:x-suse:ns:docmanager" class="name">Grafana Dashboards</span> <a title="Permalink" class="permalink" href="id-security.html#id-grafana-dashboards">#</a></h4></div></div></div><p>Use Grafana to proactively monitor the status of the certificates, follow the <a class="xref" href="id-monitoring.html#adding-grafana-dashboards" title="8.1.3.2.6. Adding Grafana Dashboards">Section 8.1.3.2.6, “Adding Grafana Dashboards”</a> to install the Grafana dashboard to monitors certificates.</p></div><div class="sect3" id="id-monitor-custom-secret-certificates"><div class="titlepage"><div><div><h4 class="title"><span class="number">6.9.4.4 </span><span xmlns:dm="urn:x-suse:ns:docmanager" class="name">Monitor Custom Secret Certificates</span> <a title="Permalink" class="permalink" href="id-security.html#id-monitor-custom-secret-certificates">#</a></h4></div></div></div><p>You can monitor custom secret TLS certificates that you created manually or using <a class="link" href="https://cert-manager.io/" target="_blank">cert-manager</a>.</p><p>For example:</p><div class="orderedlist "><ol class="orderedlist" type="1"><li class="listitem "><p>Monitor cert-manager issued certificates in the <code class="literal">cert-managert-test</code> namespace.</p><div class="verbatim-wrap highlight bash"><pre class="screen">helm install &lt;RELEASE_NAME&gt; suse/cert-exporter \
    --set customSecret.enabled=true \
    --set customSecret.certs[0].name=cert-manager \
    --set customSecret.certs[0].namespace=cert-manager-test \
    --set customSecret.certs[0].includeKeys="{*.crt,*.pem}" \
    --set customSecret.certs[0].annotationSelector="{cert-manager.io/certificate-name}"</pre></div></li><li class="listitem "><p>Monitor certificates in all namespaces filtered by label selector.</p><div class="verbatim-wrap highlight bash"><pre class="screen">helm install &lt;RELEASE_NAME&gt; suse/cert-exporter \
    --set customSecret.enabled=true \
    --set customSecret.certs[0].name=self-signed-cert \
    --set customSecret.certs[0].includeKeys="{*.crt,*.pem}" \
    --set customSecret.certs[0].labelSelector="{key=value}"</pre></div></li><li class="listitem "><p>Deploy both 1. and 2. together.</p><div class="verbatim-wrap highlight bash"><pre class="screen">helm install &lt;RELEASE_NAME&gt; suse/cert-exporter \
    --set customSecret.enabled=true \
    --set customSecret.certs[0].name=cert-manager \
    --set customSecret.certs[0].namespace=cert-manager-test \
    --set customSecret.certs[0].includeKeys="{*.crt,*.pem}" \
    --set customSecret.certs[0].annotationSelector="{cert-manager.io/certificate-name}" \
    --set customSecret.certs[1].name=self-signed-cert \
    --set customSecret.certs[1].includeKeys="{*.crt,*.pem}" \
    --set customSecret.certs[1].labelSelector="{key=value}"</pre></div></li><li class="listitem "><p>Monitor custom certificates only, disregarding node and addon certificates.</p><div class="verbatim-wrap highlight bash"><pre class="screen">helm install &lt;RELEASE_NAME&gt; suse/cert-exporter \
    --set node.enabled=false \
    --set addon.enabled=false \
    --set customSecret.enabled=true \
    --set customSecret.certs[0].name=cert-manager \
    --set customSecret.certs[0].namespace=cert-manager-test \
    --set customSecret.certs[0].includeKeys="{*.crt,*.pem}" \
    --set customSecret.certs[0].annotationSelector="{cert-manager.io/certificate-name}" \
    --set customSecret.certs[1].name=self-signed-cert \
    --set customSecret.certs[1].includeKeys="{*.crt,*.pem}" \
    --set customSecret.certs[1].labelSelector="{key=value}"</pre></div></li></ol></div></div></div><div class="sect2" id="id-deployment-with-a-custom-ca-certificate"><div class="titlepage"><div><div><h3 class="title"><span class="number">6.9.5 </span><span xmlns:dm="urn:x-suse:ns:docmanager" class="name">Deployment with a Custom CA Certificate</span> <a title="Permalink" class="permalink" href="id-security.html#id-deployment-with-a-custom-ca-certificate">#</a></h3></div></div></div><div id="id-1.8.10.7.2" class="admonition warning normal"><img class="symbol" alt="Warning" title="Warning" src="static/images/icon-warning.png" /><h6>Warning</h6><p>Please plan carefully when deploying with a custom CA certificate. This certificate
can not be reconfigured once deployed and requires a full re-installation of the
cluster to replace.</p></div><p>Administrators can provide custom CA certificates (root CAs or intermediate CAs)
during cluster deployment and decide which CA components to replace (multiple CA certificates) or if to replace all with a single CA certificate.</p><p>After you have run <code class="literal">skuba cluster init</code>, go to the <code class="literal">&lt;CLUSTER_NAME&gt;</code> folder that has been generated,
Create a <code class="literal">pki</code> folder and put your custom CA certificate into the <code class="literal">pki</code> folder.</p><div id="id-1.8.10.7.5" class="admonition note normal"><img class="symbol" alt="Note" title="Note" src="static/images/icon-note.png" /><h6>Note: Extracting Certificate And Key From Combined PEM File</h6><p>Some PKIs will issue certificates and keys in a combined <code class="literal">.pem</code> file.
In order to use the contained certificate, you must extract them into separate files using <code class="literal">openssl</code>.</p><div class="orderedlist "><ol class="orderedlist" type="1"><li class="listitem "><p>Extract the certificate:</p><div class="verbatim-wrap highlight bash"><pre class="screen">openssl x509 -in /path/to/file.pem -out /path/to/file.crt</pre></div></li><li class="listitem "><p>Extract the key:</p><div class="verbatim-wrap highlight bash"><pre class="screen">openssl rsa -in /path/to/file.pem -out /path/to/file.key</pre></div></li></ol></div></div><div class="itemizedlist "><ul class="itemizedlist"><li class="listitem "><p>Replacing the Kubernetes CA certificate:</p><div class="verbatim-wrap highlight bash"><pre class="screen">mkdir -p &lt;CLUSTER_NAME&gt;/pki
cp &lt;CUSTOM_APISERVER_CA_CERT_PATH&gt; &lt;CLUSTER_NAME&gt;/pki/ca.crt
cp &lt;CUSTOM_APISERVER_CA_KEY_PATH&gt; &lt;CLUSTER_NAME&gt;/pki/ca.key
chmod 644 &lt;CLUSTER_NAME&gt;/pki/ca.crt
chmod 600 &lt;CLUSTER_NAME&gt;/pki/ca.key</pre></div></li><li class="listitem "><p>Replacing the <code class="literal">etcd</code> CA certificate:</p><div class="verbatim-wrap highlight bash"><pre class="screen">mkdir -p &lt;CLUSTER_NAME&gt;/pki/etcd
cp &lt;CUSTOM_ETCD_CA_CERT_PATH&gt; &lt;CLUSTER_NAME&gt;/pki/etcd/ca.crt
cp &lt;CUSTOM_ETCD_CA_KEY_PATH&gt; &lt;CLUSTER_NAME&gt;/pki/etcd/ca.key
chmod 644 &lt;CLUSTER_NAME&gt;/pki/etcd/ca.crt
chmod 600 &lt;CLUSTER_NAME&gt;/pki/etcd/ca.key</pre></div></li><li class="listitem "><p>Replacing the <code class="literal">kubelet</code> CA certificate:</p><div class="verbatim-wrap highlight bash"><pre class="screen">mkdir -p &lt;CLUSTER_NAME&gt;/pki
cp &lt;CUSTOM_KUBELET_CA_CERT_PATH&gt; &lt;CLUSTER_NAME&gt;/pki/kubelet-ca.crt
cp &lt;CUSTOM_KUBELET_CA_KEY_PATH&gt; &lt;CLUSTER_NAME&gt;/pki/kubelet-ca.key
chmod 644 &lt;CLUSTER_NAME&gt;/pki/kubelet-ca.crt
chmod 600 &lt;CLUSTER_NAME&gt;/pki/kubelet-ca.key</pre></div></li><li class="listitem "><p>Replacing the <code class="literal">front-end proxy</code> CA certificate:</p><div class="verbatim-wrap highlight bash"><pre class="screen">mkdir -p &lt;CLUSTER_NAME&gt;/pki
cp &lt;CUSTOM_FRONTPROXY_CA_CERT_PATH&gt; &lt;CLUSTER_NAME&gt;/pki/front-proxy-ca.crt
cp &lt;CUSTOM_FRONTPROXY_CA_KEY_PATH&gt; &lt;CLUSTER_NAME&gt;/pki/front-proxy-ca.key
chmod 644 &lt;CLUSTER_NAME&gt;/pki/front-proxy-ca.crt
chmod 600 &lt;CLUSTER_NAME&gt;/pki/front-proxy-ca.key</pre></div></li></ul></div><p>After this process, bootstrap the cluster with <code class="literal">skuba node bootstrap</code>.</p></div><div class="sect2" id="id-replace-oidc-server-certificate-signed-by-a-trusted-ca-certificate"><div class="titlepage"><div><div><h3 class="title"><span class="number">6.9.6 </span><span xmlns:dm="urn:x-suse:ns:docmanager" class="name">Replace OIDC Server Certificate Signed By A Trusted CA Certificate</span> <a title="Permalink" class="permalink" href="id-security.html#id-replace-oidc-server-certificate-signed-by-a-trusted-ca-certificate">#</a></h3></div></div></div><div class="itemizedlist "><ul class="itemizedlist"><li class="listitem "><p>During Cluster Deployment:</p><div class="itemizedlist "><ul class="itemizedlist"><li class="listitem "><p>With a Trusted CA Key:</p><div class="verbatim-wrap highlight bash"><pre class="screen">mkdir -p &lt;CLUSTER_NAME&gt;/pki
cp &lt;CUSTOM_OIDC_CA_CERT_PATH&gt; &lt;CLUSTER_NAME&gt;/pki/oidc-ca.crt
cp &lt;CUSTOM_OIDC_CA_KEY_PATH&gt; &lt;CLUSTER_NAME&gt;/pki/oidc-ca.key
chmod 644 &lt;CLUSTER_NAME&gt;/pki/oidc-ca.crt
chmod 600 &lt;CLUSTER_NAME&gt;/pki/oidc-ca.key</pre></div><p>After this process, bootstrap the cluster with <code class="literal">skuba node bootstrap</code>.
skuba uploads the local OIDC CA certificate to the remote path specified in the local file <code class="literal">kubeadm-init.conf</code> key <code class="literal">oidc-ca-file</code>. When installing the add-on, skuba generates the OIDC server certificates and keys which are signed by the provided OIDC CA certificate and key pair and then stored to its Secret resource.</p></li><li class="listitem "><p>Without a Trusted CA Key:</p><p>Use command <code class="literal">skuba cert generate-csr</code> to generate the OIDC server CSRs and keys in <code class="literal">&lt;my-cluster&gt;/pki</code> folder.
After the CA signs the CSRs and issued the server certificates, put the OIDC CA certificate and the OIDC server certificates in <code class="literal">&lt;my-cluster&gt;/pki</code> folder.</p><p>After this process, bootstrap the cluster with <code class="literal">skuba node bootstrap</code>.
skuba uploads the local OIDC CA certificate to the remote path specified in the local file <code class="literal">kubeadm-init.conf</code> key <code class="literal">oidc-ca-file</code>. At the time installing the add-on, skuba uploads the OIDC CA certificate and OIDC server certificate and key pair to its Secret resource.</p></li></ul></div></li><li class="listitem "><p>After Cluster Deployment:</p><div class="itemizedlist "><ul class="itemizedlist"><li class="listitem "><p>With a Trusted CA Key:</p><p>Please refer to <a class="xref" href="id-security.html#addon-certificate-rotation" title="6.9.7.3. Addon Certificate Rotation">Section 6.9.7.3, “Addon Certificate Rotation”</a> on how to use cert-manager and reloader to issue <code class="literal">oidc-dex</code> and <code class="literal">oidc-gangway</code> certificates signed by trusted CA certificate/key.</p></li><li class="listitem "><p>Without a Trusted CA Key:</p><div id="id-1.8.10.8.2.2.2.2.2" class="admonition warning normal"><img class="symbol" alt="Warning" title="Warning" src="static/images/icon-warning.png" /><h6>Warning</h6><p>Because the custom trusted CA certificate is not in the Kubernetes cluster, administrators must handle server certificate rotation manually before the certificate expires.</p></div><div id="id-1.8.10.8.2.2.2.2.3" class="admonition warning normal"><img class="symbol" alt="Warning" title="Warning" src="static/images/icon-warning.png" /><h6>Warning</h6><p>The <code class="literal">oidc-dex</code> and <code class="literal">oidc-gangway</code> server certificate and key is replaced when <code class="literal">skuba addon upgrade apply</code> contains a dex or gangway addon upgrade.
Make sure to reapply your changes after running <code class="literal">skuba addon upgrade apply</code>, had you modified the default settings of oidc-dex and oidc-gangway addons.</p></div><div class="itemizedlist "><ul class="itemizedlist"><li class="listitem "><p>Replace the <code class="literal">oidc-dex</code> server certificate:</p><div class="orderedlist "><ol class="orderedlist" type="1"><li class="listitem "><p>Backup the original <code class="literal">oidc-dex</code> server certificate and key from secret resource.</p><div class="verbatim-wrap highlight bash"><pre class="screen">mkdir -p pki.bak
kubectl get secret oidc-dex-cert -n kube-system -o yaml | tee pki.bak/oidc-dex-cert.yaml &gt; /dev/null

cat pki.bak/oidc-dex-cert.yaml | grep tls.crt | awk '{print $2}' | base64 --decode | tee pki.bak/oidc-dex.crt &gt; /dev/null
cat pki.bak/oidc-dex-cert.yaml | grep tls.key | awk '{print $2}' | base64 --decode | tee pki.bak/oidc-dex.key &gt; /dev/null</pre></div></li><li class="listitem "><p>Get the original SAN IP address(es) and DNS(s), run:</p><div class="verbatim-wrap highlight bash"><pre class="screen">openssl x509 -noout -text -in pki.bak/oidc-dex.crt | grep -oP '(?&lt;=IP Address:)[^,]+'
openssl x509 -noout -text -in pki.bak/oidc-dex.crt | grep -oP '(?&lt;=DNS:)[^,]+'</pre></div></li><li class="listitem "><p>Sign the <code class="literal">oidc-dex</code> server certificate with the trusted CA certificate.</p><p>Please refer to <a class="xref" href="id-security.html#trusted-server-certificate" title="6.9.9.1.1. Trusted Server Certificate">Section 6.9.9.1.1, “Trusted Server Certificate”</a> on how to sign the trusted certificate. The <code class="literal">server.conf</code> for IP.1 is the original SAN IP address if present, DNS.1 is the original SAN DNS if present.</p><p>Then, import your trusted certificate into the Kubernetes cluster.
The trusted CA certificates is <code class="literal">&lt;TRUSTED_CA_CERT_PATH&gt;</code>, trusted server certificate and key are <code class="literal">&lt;SIGNED_OIDC_DEX_SERVER_CERT_PATH&gt;</code> and <code class="literal">&lt;SIGNED_OIDC_DEX_SERVER_KEY_PATH&gt;</code>.</p></li><li class="listitem "><p>Create a secret manifest file <code class="literal">oidc-dex-cert.yaml</code> and update the secret data <code class="literal">ca.crt</code>, <code class="literal">tls.crt</code>, and <code class="literal">tls.key</code> with base64; encoded with trusted CA certificate, signed oidc-dex server certificate and key respectively.</p><div class="verbatim-wrap highlight yaml"><pre class="screen">apiVersion: v1
kind: Secret
metadata:
  name: oidc-dex-cert
  namespace: kube-system
  labels:
    caasp.suse.com/skuba-addon: "true"
type: kubernetes.io/tls
data:
  ca.crt: cat &lt;TRUSTED_CA_CERT_PATH&gt; | base64 | awk '\{print\}' ORS='' &amp;&amp; echo
  tls.crt: cat &lt;SIGNED_OIDC_DEX_SERVER_CERT_PATH&gt; | base64 | awk '\{print\}' ORS='' &amp;&amp; echo
  tls.key: cat &lt;SIGNED_OIDC_DEX_SERVER_KEY_PATH&gt; | base64 | awk '\{print\}' ORS='' &amp;&amp; echo</pre></div></li><li class="listitem "><p>Apply the secret manifest file and restart <code class="literal">oidc-dex</code> pods.</p><div class="verbatim-wrap highlight bash"><pre class="screen">kubectl replace -f oidc-dex-cert.yaml
kubectl rollout restart deployment/oidc-dex -n kube-system</pre></div></li></ol></div></li><li class="listitem "><p>Replace the <code class="literal">oidc-gangway</code> server certificate:</p><div class="orderedlist "><ol class="orderedlist" type="1"><li class="listitem "><p>Backup the original <code class="literal">oidc-gangway</code> server certificate and key from secret resource.</p><div class="verbatim-wrap highlight bash"><pre class="screen">mkdir -p pki.bak
kubectl get secret oidc-gangway-cert -n kube-system -o yaml | tee pki.bak/oidc-gangway-cert.yaml &gt; /dev/null

cat pki.bak/oidc-gangway-cert.yaml | grep tls.crt | awk '{print $2}' | base64 --decode | tee pki.bak/oidc-gangway.crt &gt; /dev/null
cat pki.bak/oidc-gangway-cert.yaml | grep tls.key | awk '{print $2}' | base64 --decode | tee pki.bak/oidc-gangway.key &gt; /dev/null</pre></div></li><li class="listitem "><p>Get the original SAN IP address(es) and DNS(s), run:</p><div class="verbatim-wrap highlight bash"><pre class="screen">openssl x509 -noout -text -in pki.bak/oidc-gangway.crt | grep -oP '(?&lt;=IP Address:)[^,]+'
openssl x509 -noout -text -in pki.bak/oidc-gangway.crt | grep -oP '(?&lt;=DNS:)[^,]+'</pre></div></li><li class="listitem "><p>Sign the <code class="literal">oidc-gangway</code> server certificate with the trusted CA certificate.</p><p>Please refer to <a class="xref" href="id-security.html#trusted-server-certificate" title="6.9.9.1.1. Trusted Server Certificate">Section 6.9.9.1.1, “Trusted Server Certificate”</a> on how to sign the trusted certificate. The <code class="literal">server.conf</code> for IP.1 is the original SAN IP address if present, DNS.1 is the original SAN DNS if present.</p><p>Then, import your trusted certificate into the Kubernetes cluster.
The trusted CA certificates is <code class="literal">&lt;TRUSTED_CA_CERT_PATH&gt;</code>, trusted server certificate and key are <code class="literal">&lt;SIGNED_OIDC_GANGWAY_SERVER_CERT_PATH&gt;</code> and <code class="literal">&lt;SIGNED_OIDC_GANGWAY_SERVER_KEY_PATH&gt;</code>.</p></li><li class="listitem "><p>Create a secret manifest file <code class="literal">oidc-gangway-cert.yaml</code> and update the secret data <code class="literal">ca.crt</code>, <code class="literal">tls.crt</code>, and <code class="literal">tls.key</code> with base64; encoded with trusted CA certificate, signed <code class="literal">oidc-gangway</code> server certificate and key respectively.</p><div class="verbatim-wrap highlight yaml"><pre class="screen">apiVersion: v1
kind: Secret
metadata:
  name: oidc-gangway-cert
  namespace: kube-system
  labels:
    caasp.suse.com/skuba-addon: "true"
type: kubernetes.io/tls
data:
  ca.crt: cat &lt;TRUSTED_CA_CERT_PATH&gt; | base64 | awk '\{print\}' ORS='' &amp;&amp; echo
  tls.crt: cat &lt;SIGNED_OIDC_GANGWAY_SERVER_CERT_PATH&gt; | base64 | awk '\{print\}' ORS='' &amp;&amp; echo
  tls.key: cat &lt;SIGNED_OIDC_GANGWAY_SERVER_KEY_PATH&gt; | base64 | awk '\{print\}' ORS='' &amp;&amp; echo</pre></div></li><li class="listitem "><p>Apply the secret manifest file and restart <code class="literal">oidc-gangway</code> pods.</p><div class="verbatim-wrap highlight bash"><pre class="screen">kubectl replace -f oidc-gangway-cert.yaml
kubectl rollout restart deployment/oidc-gangway -n kube-system</pre></div></li></ol></div></li><li class="listitem "><p>Replace the OIDC CA for <code class="literal">kube-apiserver</code>:</p><div class="orderedlist "><ol class="orderedlist" type="1"><li class="listitem "><p>Copy custom OIDC CA which was used for <code class="literal">oidc-dex</code> and <code class="literal">oidc-gangway</code> to <code class="literal">/etc/kubernetes/pki/oidc-ca.crt</code> on all SUSE CaaS Platform master nodes</p><div class="verbatim-wrap highlight bash"><pre class="screen">ssh &lt;USERNAME&gt;@&lt;MASTER_NODE_IP_ADDRESS/FQDN&gt;
sudo mv oidc-ca.crt /etc/kubernetes/pki/oidc-ca.crt</pre></div></li><li class="listitem "><p>Update <code class="literal">oidc-ca-file</code> option in <code class="literal">kubeadm</code> configmap</p><div class="verbatim-wrap highlight bash"><pre class="screen">kubectl get configmap -n kube-system kubeadm-config -o yaml &gt; kubeadm-config.yaml
sed -i "s|oidc-ca-file: .*|oidc-ca-file: /etc/kubernetes/pki/oidc-ca.crt|" kubeadm-config.yaml
kubectl apply -f kubeadm-config.yaml</pre></div></li><li class="listitem "><p>Update <code class="literal">oidc-ca-file</code> in static pod manifest for kube-apiserver in <code class="literal">/etc/kubernetes/manifests/kube-apiserver.yaml</code> on all SUSE CaaS Platform master nodes</p><div class="verbatim-wrap highlight bash"><pre class="screen">sed -i "s|oidc-ca-file=.*|oidc-ca-file=/etc/kubernetes/pki/oidc-ca.crt|" /etc/kubernetes/manifests/kube-apiserver.yaml</pre></div></li></ol></div></li></ul></div></li></ul></div></li></ul></div></div><div class="sect2" id="id-automatic-certificate-renewal"><div class="titlepage"><div><div><h3 class="title"><span class="number">6.9.7 </span><span xmlns:dm="urn:x-suse:ns:docmanager" class="name">Automatic Certificate Renewal</span> <a title="Permalink" class="permalink" href="id-security.html#id-automatic-certificate-renewal">#</a></h3></div></div></div><p>SUSE CaaS Platform renews the control plane certificates and kubeconfigs automatically in two ways:</p><div class="orderedlist "><ol class="orderedlist" type="1"><li class="listitem "><p><span class="strong"><strong>During node upgrade</strong></span>:
When the node is upgraded, all the <code class="literal">kubeadm</code> managed certificates and kubeconfigs get rotated.
The time to rotate the kubelet client and server certificate is controlled by <code class="literal">kubelet</code> daemon.</p><div id="id-1.8.10.9.3.1.2" class="admonition note normal"><img class="symbol" alt="Note" title="Note" src="static/images/icon-note.png" /><h6>Note</h6><p>During node upgrade, neither the <code class="literal">kubelet</code> client certificate nor server certificate get rotated.</p></div></li><li class="listitem "><p><span class="strong"><strong>Via the <code class="literal">kucero</code> addon</strong></span>:
If the administrator is not able to upgrade the cluster, the <code class="literal">kucero</code> (KUbernetes control plane CErtificate ROtation) addon rotates all the <code class="literal">kubeadm</code> managed certificates and kubeconfigs and signs <code class="literal">kubelet</code> server CSR.
<code class="literal">kucero</code> is a <code class="literal">kubeadm</code> checker/renewer in the form of a DaemonSet. Its job is to periodically check and renew control plane <code class="literal">kubeadm</code> managed certificates/kubeconfigs, and check the <code class="literal">kubelet</code> client and server enables auto rotation, and also a signer to sign <code class="literal">kubelet</code> server CSR.</p></li></ol></div><div id="id-1.8.10.9.4" class="admonition note normal"><img class="symbol" alt="Note" title="Note" src="static/images/icon-note.png" /><h6>Note: Time to rotate the kubelet client and server certificate</h6><p>The <code class="literal">kubelet</code> client and server certificate renews automatically at approximately 70%-90% of the total lifetime of the certificate, the <code class="literal">kubelet</code> daemon would use new client and server certificates without downtime.</p></div><div id="id-1.8.10.9.5" class="admonition note normal"><img class="symbol" alt="Note" title="Note" src="static/images/icon-note.png" /><h6>Note: Kubelet client and server certificate signing flow</h6><p>The configuration which controls the <code class="literal">kubelet</code> daemon to send out the CSR within the Kubernetes cluster is controlled by the configuration <code class="literal">/var/lib/kubelet/config.yaml</code>.
The key <code class="literal">rotateCertificates</code> controls the kubelet client certificate; the key <code class="literal">serverTLSBootstrap</code> controls the kubelet server certificate.</p><p>When the client or server certificate is going to expire, the <code class="literal">kubelet</code> daemon sends the <code class="literal">kubelet</code> client or server CSR within the Kubernetes cluster.
The <code class="literal">kube-controller-manager</code> signs the kubelet client CSR with the Kubernetes CA cert/key pair, <code class="literal">kucero</code> addon signs the <code class="literal">kubelet</code> server CSR with the <code class="literal">kubelet</code> CA cert/key pair.
Then, the <code class="literal">kubelet</code> daemon saves the signed certificate under the folder <code class="literal">/var/lib/kubelet/pki</code> and updates the client or server certificate symlink points to the latest signed certificate.</p><p>The path of <code class="literal">kubelet</code> client certificate is <code class="literal">/var/lib/kubelet/pki/kubelet-client-current.pem</code>.
The path of <code class="literal">kubelet</code> server certificate is <code class="literal">/var/lib/kubelet/pki/kubelet-server-current.pem</code>.</p></div><div class="sect3" id="id-control-plane-nodes-certificate-rotation"><div class="titlepage"><div><div><h4 class="title"><span class="number">6.9.7.1 </span><span xmlns:dm="urn:x-suse:ns:docmanager" class="name">Control Plane Nodes Certificate Rotation</span> <a title="Permalink" class="permalink" href="id-security.html#id-control-plane-nodes-certificate-rotation">#</a></h4></div></div></div><p>Control Plane Node Certificates are rotated in two ways:</p><div class="orderedlist "><ol class="orderedlist" type="1"><li class="listitem "><p><span class="strong"><strong>During node upgrade</strong></span>:
when doing a control plane update, <code class="literal">skuba node upgrade apply</code> runs <code class="literal">kubeadm upgrade</code> commands behind the scenes. <code class="literal">kubeadm upgrade apply</code> and
<code class="literal">kubeadm upgrade node</code> renews and uses new <code class="literal">kubeadm</code> managed certificates on the node, including those stored in kubeconfig files, regardless of the remaining time for which the certificate was still valid.</p></li><li class="listitem "><p><span class="strong"><strong>Via the <code class="literal">kucero</code> addon:</strong></span></p><div class="orderedlist "><ol class="orderedlist" type="a"><li class="listitem "><p><code class="literal">kubeadm</code> managed certificates/kubeconfigs:
a <code class="literal">kubeadm</code> checker/renewer to periodical checks (default interval is 1 hour) the kubeadm managed certificates/kubeconfigs, and rotates the certificates/kubeconfigs if the residual time is less than the total time (default 720 hours).
Administrators can change the default time to renew the certificates/kubeconfigs by adding <code class="literal">--renew-before=&lt;duration&gt;`</code> (duration format is XhYmZs) to the kucero daemonset <span class="emphasis"><em>or</em></span> change the default polling period for checking the certificates/kubeconfigs by adding <code class="literal">--polling-period=&lt;duration&gt;</code> (duration format is <code class="literal">XhYmZs</code>).</p></li><li class="listitem "><p><code class="literal">kubelet</code> client and server certificates:
A <code class="literal">kubelet</code> configuration checker/updater periodically checks (default interval is 1 hour) if the kubelet configuration enables the client and server auto rotation.
If not, kucero will help enable the client and server auto-rotation by configuring <code class="literal">rotateCertificates: true</code> and <code class="literal">serverTLSBootstrap: true</code> in <code class="literal">/var/lib/kubelet/config.yaml</code>.
After that, the <code class="literal">kubelet</code> daemon will send out the CSR within the Kubernetes cluster if the client or server is going to expire, the corresponding CSR signer and approver will sign and approve the CSR, then the <code class="literal">kubelet</code> daemon saves the signed certificate under the folder <code class="literal">/var/lib/kubelet/pki</code> and updates the symlink points to the latest signed certificate.</p></li></ol></div></li></ol></div></div><div class="sect3" id="id-worker-node-certificate-rotation"><div class="titlepage"><div><div><h4 class="title"><span class="number">6.9.7.2 </span><span xmlns:dm="urn:x-suse:ns:docmanager" class="name">Worker Node Certificate Rotation</span> <a title="Permalink" class="permalink" href="id-security.html#id-worker-node-certificate-rotation">#</a></h4></div></div></div><p>Worker Node Certificates are rotated in one way:</p><div class="orderedlist "><ol class="orderedlist" type="1"><li class="listitem "><p><span class="strong"><strong>Via the kucero addon:</strong></span></p><div class="orderedlist "><ol class="orderedlist" type="a"><li class="listitem "><p><code class="literal">kubelet</code> client and server certificates:
A <code class="literal">kubelet</code> configuration checker/updater periodically checks (default interval is 1 hour) if the kubelet configuration enables the client and server auto rotation.
If not, kucero will help enable the client and server auto-rotation by configuring <code class="literal">rotateCertificates: true</code> and <code class="literal">serverTLSBootstrap: true</code> in <code class="literal">/var/lib/kubelet/config.yaml</code>.
After that, the <code class="literal">kubelet</code> daemon will send out the CSR within the Kubernetes cluster if the client or server is going to expire, the corresponding CSR signer and approver will sign and approve the CSR, then the <code class="literal">kubelet</code> daemon saves the signed certificate under the folder <code class="literal">/var/lib/kubelet/pki</code> and updates the symlink points to the latest signed certificate.</p></li></ol></div></li></ol></div></div><div class="sect3" id="addon-certificate-rotation"><div class="titlepage"><div><div><h4 class="title"><span class="number">6.9.7.3 </span><span xmlns:dm="urn:x-suse:ns:docmanager" class="name">Addon Certificate Rotation</span> <a title="Permalink" class="permalink" href="id-security.html#addon-certificate-rotation">#</a></h4></div></div></div><p>The addon certificates can be automatically rotated by leveraging the functions of the open-source solutions <code class="literal">cert-manager</code> and <code class="literal">reloader</code>. <code class="literal">cert-manager</code> is for automatically rotating certificates stored in Secrets, and <code class="literal">reloader</code> is for watching and reconciling the updated Secrets to execute a rolling upgrade of the affected Deployments or DaemonSet.</p><div class="orderedlist "><ol class="orderedlist" type="1"><li class="listitem "><p>Install reloader via helm chart:</p><div class="verbatim-wrap highlight bash"><pre class="screen">helm install &lt;RELEASE_NAME&gt; \
    --namespace cert-manager \
    --create-namespace \
    suse/reloader</pre></div></li><li class="listitem "><p>Install cert-manager via helm chart:</p><div class="verbatim-wrap highlight bash"><pre class="screen">helm install &lt;RELEASE_NAME&gt; \
    --namespace cert-manager \
    --create-namespace \
    --set global.leaderElection.namespace=cert-manager \
    --set installCRDs=true \
    suse/cert-manager</pre></div><div class="itemizedlist "><ul class="itemizedlist"><li class="listitem "><p>Cert-Manager CA Issuer Resource</p><p>The cert-manager CA issuer is a Kubernetes resource that represents a certificate authority (CA), which can generate signed certificates by honoring certificate signing requests (CSR). Each cert-manager certificate resource requires one referenced issuer in the ready state to be able to honor CSR requests.</p><div id="id-1.8.10.9.8.3.2.3.1.3" class="admonition note normal"><img class="symbol" alt="Note" title="Note" src="static/images/icon-note.png" /><h6>Note</h6><p>An <code class="literal">Issuer</code> is a namespaced resource, and it can not issue certificates to the certificate resources in other namespaces.</p><p>If you want to create a single Issuer that can be consumed in multiple namespaces, you should consider creating a <code class="literal">ClusterIssuer</code> resource. This is almost identical to the Issuer resource, however, it is cluster-wide so it can be used to issue certificates in all namespaces.</p></div></li><li class="listitem "><p>Cert-Manager Certificate Resource</p><p>The cert-manager has a custom resource, Certificate, which can be used to define a requested x509 certificate which will be renewed and kept up to date by an Issuer or ClusterIssuer resource.</p></li></ul></div></li></ol></div><div class="sect4" id="id-client-certificate-rotation"><div class="titlepage"><div><div><h5 class="title"><span class="number">6.9.7.3.1 </span><span xmlns:dm="urn:x-suse:ns:docmanager" class="name">Client Certificate Rotation</span> <a title="Permalink" class="permalink" href="id-security.html#id-client-certificate-rotation">#</a></h5></div></div></div><div id="id-1.8.10.9.8.4.2" class="admonition warning normal"><img class="symbol" alt="Warning" title="Warning" src="static/images/icon-warning.png" /><h6>Warning</h6><p>If you are running a cluster using cilium version before 1.6, the cilium data is stored in the ETCD cluster, not the custom resources (CR). `skuba` generates a client certificate to read/write the cilium date to the ETCD cluster and the client certificate will expire after 1 year. Please follow the below steps to use cert-manager to automatically renew the cilium client certificate.</p></div><div class="orderedlist "><ol class="orderedlist" type="1"><li class="listitem "><p>Check the SUSE CaaS Platform cilium version before 1.6</p><div class="verbatim-wrap highlight bash"><pre class="screen">CILIUM_OPERATOR=`kubectl get pod -l name=cilium-operator --namespace kube-system -o jsonpath='{.items[0].metadata.name}'`
kubectl exec -it ${CILIUM_OPERATOR} --namespace kube-system -- cilium-operator --version</pre></div></li><li class="listitem "><p>To let <code class="literal">reloader</code> do an automatic rolling upgrade of the cilium addon DaemonSet, we need to label the addons:</p><div class="verbatim-wrap highlight bash"><pre class="screen">kubectl annotate --overwrite daemonset/cilium -n kube-system secret.reloader.stakater.com/reload=cilium-secret</pre></div></li><li class="listitem "><p>Upload the ETCD CA cert/key pair to Secret in the <code class="literal">kube-system</code> namespace</p><div class="verbatim-wrap highlight bash"><pre class="screen">kubectl create secret tls etcd-ca --cert=pki/etcd/ca.crt --key=pki/etcd/ca.key -n kube-system</pre></div></li><li class="listitem "><p>Create a Cert-Manager CA Issuer Resource</p><p>Create a CA issuer called <code class="literal">etcd-ca</code> that will sign incoming certificate requests based on the CA certificate and private key stored in the secret <code class="literal">etcd-ca</code> used to trust newly signed certificates.</p><div class="verbatim-wrap highlight bash"><pre class="screen">cat &lt;&lt; EOF &gt; issuer-etcd-ca.yaml
apiVersion: cert-manager.io/v1alpha3
kind: Issuer
metadata:
  name: etcd-ca
  namespace: kube-system
spec:
  ca:
    secretName: etcd-ca
EOF

kubectl create -f issuer-etcd-ca.yaml</pre></div></li><li class="listitem "><p>Create a Cert-Manager Certificate Resource</p><p>Create a certificate resource <code class="literal">cilium-etcd-client</code> that will watch and auto-renews the secret <code class="literal">cilium-secret</code> if the certificate residual time is less than the <code class="literal">renewBefore</code> value.</p><div class="verbatim-wrap highlight bash"><pre class="screen">cat &lt;&lt; EOF &gt; cilium-etcd-client-certificate.yaml
apiVersion: cert-manager.io/v1alpha3
kind: Certificate
metadata:
  name: cilium-etcd-client-cert
  namespace: kube-system
spec:
  subject:
    organizations:
    - system:masters
  commonName: cilium-etcd-client
  duration: 8760h # 1 year
  renewBefore: 720h # 1 month
  secretName: cilium-secret
  issuerRef:
    name: etcd-ca
    kind: Issuer
    group: cert-manager.io
  isCA: false
  usages:
    - digital signature
    - key encipherment
    - client auth
  keySize: 2048
  keyAlgorithm: rsa
  keyEncoding: pkcs1
EOF

kubectl create -f cilium-etcd-client-certificate.yaml</pre></div></li></ol></div></div><div class="sect4" id="id-server-certificates-rotation"><div class="titlepage"><div><div><h5 class="title"><span class="number">6.9.7.3.2 </span><span xmlns:dm="urn:x-suse:ns:docmanager" class="name">Server Certificates Rotation</span> <a title="Permalink" class="permalink" href="id-security.html#id-server-certificates-rotation">#</a></h5></div></div></div><div class="itemizedlist "><ul class="itemizedlist"><li class="listitem "><p>Prerequisites</p><div class="orderedlist "><ol class="orderedlist" type="1"><li class="listitem "><p>To let <code class="literal">reloader</code> do an automatic rolling upgrade of the addon Deployments or DaemonSet, we need to label the addons:</p><div class="verbatim-wrap highlight bash"><pre class="screen">kubectl annotate --overwrite deployment/oidc-dex -n kube-system secret.reloader.stakater.com/reload=oidc-dex-cert

kubectl annotate --overwrite deployment/oidc-gangway -n kube-system secret.reloader.stakater.com/reload=oidc-gangway-cert

kubectl annotate --overwrite deployment/metrics-server -n kube-system secret.reloader.stakater.com/reload=metrics-server-cert</pre></div></li><li class="listitem "><p>Upload the Kubernetes CA cert/key pair to Secret in the <code class="literal">kube-system</code> namespace:</p><div class="verbatim-wrap highlight bash"><pre class="screen">kubectl create secret tls kubernetes-ca --cert=pki/ca.crt --key=pki/ca.key -n kube-system</pre></div><div id="id-1.8.10.9.8.5.2.1.2.2.3" class="admonition note normal"><img class="symbol" alt="Note" title="Note" src="static/images/icon-note.png" /><h6>Note</h6><p>If you want to use a custom trusted CA certificate/key to sign the certificate, upload to the secret resource.</p><div class="verbatim-wrap highlight bash"><pre class="screen">kubectl create secret tls custom-trusted-ca --cert=&lt;CUSTOM_TRUSTED_CA_CERT&gt; --key=&lt;CUSTOM_TRUSTED_CA_KEY&gt; -n kube-system</pre></div></div></li></ol></div></li><li class="listitem "><p>Create a Cert-Manager CA Issuer Resource</p><p>Create a CA issuer called <code class="literal">kubernetes-ca</code> that will sign incoming certificate requests based on the CA certificate and private key stored in the secret <code class="literal">kubernetes-ca</code> used to trust newly signed certificates.</p><div class="verbatim-wrap highlight bash"><pre class="screen">cat &lt;&lt; EOF &gt; issuer-kubernetes-ca.yaml
apiVersion: cert-manager.io/v1alpha3
kind: Issuer
metadata:
  name: kubernetes-ca <span id="CO12-1"></span><span class="callout">1</span>
  namespace: kube-system
spec:
  ca:
    secretName: kubernetes-ca <span id="CO12-2"></span><span class="callout">2</span>
EOF

kubectl create -f issuer-kubernetes-ca.yaml</pre></div><div class="calloutlist "><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO12-1"><span class="callout">1</span></a> </p></td><td valign="top" align="left"><p>The issuer name.</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO12-2"><span class="callout">2</span></a> </p></td><td valign="top" align="left"><p>The secret reference name.</p></td></tr></table></div><div id="id-1.8.10.9.8.5.2.2.5" class="admonition note normal"><img class="symbol" alt="Note" title="Note" src="static/images/icon-note.png" /><h6>Note</h6><p>If you want to use custom trusted CA certificate/key to sign the certificate, create a custom trusted CA issuer.</p><div class="verbatim-wrap highlight bash"><pre class="screen">cat &lt;&lt; EOF &gt; custom-trusted-kubernetes-ca-issuer.yaml
apiVersion: cert-manager.io/v1alpha3
kind: Issuer <span id="CO13-1"></span><span class="callout">1</span>
metadata:
  name: custom-trusted-kubernetes-ca
  namespace: kube-system
spec:
  ca:
    secretName: custom-trusted-kubernetes-ca
EOF

kubectl create -f custom-trusted-kubernetes-ca-issuer.yaml</pre></div><div class="calloutlist "><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO13-1"><span class="callout">1</span></a> </p></td><td valign="top" align="left"><p>Issuer or ClusterIssuer.</p></td></tr></table></div></div></li><li class="listitem "><p>Create a Cert-Manager Certificate Resource</p><p>Create a certificate resource that will watch and auto-renews the secret if the certificate residual time is less than the <code class="literal">renewBefore</code> value.</p><div class="itemizedlist "><ul class="itemizedlist"><li class="listitem "><p>oidc-dex certificate</p><div class="verbatim-wrap highlight bash"><pre class="screen">cat &lt;&lt; EOF &gt; oidc-dex-certificate.yaml
apiVersion: cert-manager.io/v1alpha3
kind: Certificate
metadata:
  name: oidc-dex-cert
  namespace: kube-system
spec:
  subject:
    organizations:
    - system:masters
  commonName: oidc-dex
  duration: 8760h # 1 year <span id="CO14-1"></span><span class="callout">1</span>
  renewBefore: 720h # 1 month <span id="CO14-2"></span><span class="callout">2</span>
  # At least one of a DNS Name or IP address is required.
  dnsNames:
  - $(cat admin.conf | grep server | awk '{print $2}' | sed 's/https:\/\///g' | sed 's/:6443//g') <span id="CO14-3"></span><span class="callout">3</span>
  ipAddresses:
  - $(cat admin.conf | grep server | awk '{print $2}' | sed 's/https:\/\///g' | sed 's/:6443//g') <span id="CO14-4"></span><span class="callout">4</span>
  secretName: oidc-dex-cert
  issuerRef:
    name: kubernetes-ca <span id="CO14-5"></span><span class="callout">5</span>
    kind: Issuer <span id="CO14-6"></span><span class="callout">6</span>
    group: cert-manager.io
  isCA: false
  usages:
    - digital signature
    - key encipherment
    - server auth
  keySize: 2048
  keyAlgorithm: rsa
  keyEncoding: pkcs1
EOF

kubectl create -f oidc-dex-certificate.yaml</pre></div><div class="calloutlist "><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO14-1"><span class="callout">1</span></a> </p></td><td valign="top" align="left"><p>Default length of certificate validity, in the format (XhYmZs).</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO14-2"><span class="callout">2</span></a> </p></td><td valign="top" align="left"><p>Certificate renewal time before validity expires, in the format (XhYmZs).</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO14-3"><span class="callout">3</span></a> </p></td><td valign="top" align="left"><p>DNSNames is a list of subject alt names to be used on the Certificate.</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO14-4"><span class="callout">4</span></a> </p></td><td valign="top" align="left"><p>IPAddresses is a list of IP addresses to be used on the Certificate.</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO14-5"><span class="callout">5</span></a> </p></td><td valign="top" align="left"><p>The cert-manager issuer name.</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO14-6"><span class="callout">6</span></a> </p></td><td valign="top" align="left"><p>Issuer or ClusterIssuer.</p></td></tr></table></div><p>This certificate will tell cert-manager to attempt to use the Issuer named kubernetes-ca to obtain a certificate key pair for the domain list in dnsNames and ipAddresses. If successful, the resulting key and certificate will be stored in a secret named oidc-dex-cert with keys of tls.key and tls.crt respectively.</p><p>The dnsNames and ipAddresses fields specify a list of Subject Alternative Names to be associated with the certificate.</p><p>The referenced Issuer must exist in the same namespace as the Certificate. A Certificate can alternatively reference a ClusterIssuer which is cluster-wide so it can be referenced from any namespace.</p><div id="id-1.8.10.9.8.5.2.3.3.1.7" class="admonition note normal"><img class="symbol" alt="Note" title="Note" src="static/images/icon-note.png" /><h6>Note</h6><p>If you want to use a custom trusted CA Issuer/ClusterIssuer, change the value of <code class="literal">name</code> under <code class="literal">issuerRef</code> to <code class="literal">custom-trusted-ca</code> and the value of  <code class="literal">kind</code> under <code class="literal">issuerRef</code> to <code class="literal">Issuer/ClusterIssuer</code>.</p></div></li><li class="listitem "><p>oidc-gangway certificate</p><div class="verbatim-wrap highlight bash"><pre class="screen">cat &lt;&lt; EOF &gt; oidc-gangway-certificate.yaml
apiVersion: cert-manager.io/v1alpha3
kind: Certificate
metadata:
  name: oidc-gangway-cert
  namespace: kube-system
spec:
  subject:
    organizations:
    - system:masters
  commonName: oidc-gangway
  duration: 8760h # 1 year <span id="CO15-1"></span><span class="callout">1</span>
  renewBefore: 720h # 1 month <span id="CO15-2"></span><span class="callout">2</span>
  # At least one of a DNS Name or IP address is required.
  dnsNames:
  - $(cat admin.conf | grep server | awk '{print $2}' | sed 's/https:\/\///g' | sed 's/:6443//g') <span id="CO15-3"></span><span class="callout">3</span>
  ipAddresses:
  - $(cat admin.conf | grep server | awk '{print $2}' | sed 's/https:\/\///g' | sed 's/:6443//g') <span id="CO15-4"></span><span class="callout">4</span>
  secretName: oidc-gangway-cert
  issuerRef:
    name: kubernetes-ca <span id="CO15-5"></span><span class="callout">5</span>
    kind: Issuer <span id="CO15-6"></span><span class="callout">6</span>
    group: cert-manager.io
  isCA: false
  usages:
    - digital signature
    - key encipherment
    - server auth
  keySize: 2048
  keyAlgorithm: rsa
  keyEncoding: pkcs1
EOF

kubectl create -f oidc-gangway-certificate.yaml</pre></div><div class="calloutlist "><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO15-1"><span class="callout">1</span></a> </p></td><td valign="top" align="left"><p>Default length of certificate validity, in the format (XhYmZs).</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO15-2"><span class="callout">2</span></a> </p></td><td valign="top" align="left"><p>Certificate renewal time before validity expires, in the format (XhYmZs).</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO15-3"><span class="callout">3</span></a> </p></td><td valign="top" align="left"><p>DNSNames is a list of subject alt names to be used on the Certificate.</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO15-4"><span class="callout">4</span></a> </p></td><td valign="top" align="left"><p>IPAddresses is a list of IP addresses to be used on the Certificate.</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO15-5"><span class="callout">5</span></a> </p></td><td valign="top" align="left"><p>The cert-manager issuer name.</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO15-6"><span class="callout">6</span></a> </p></td><td valign="top" align="left"><p>Issuer or ClusterIssuer.</p></td></tr></table></div><div id="id-1.8.10.9.8.5.2.3.3.2.4" class="admonition note normal"><img class="symbol" alt="Note" title="Note" src="static/images/icon-note.png" /><h6>Note</h6><p>If you want to use a custom trusted CA Issuer/ClusterIssuer, change the value of <code class="literal">name</code> under <code class="literal">issuerRef</code> to <code class="literal">custom-trusted-ca</code> and the value of  <code class="literal">kind</code> under <code class="literal">issuerRef</code> to <code class="literal">Issuer/ClusterIssuer</code>.</p></div></li><li class="listitem "><p>metrics-server certificate</p><div class="verbatim-wrap highlight bash"><pre class="screen">cat &lt;&lt; EOF &gt; metrics-server-certificate.yaml
apiVersion: cert-manager.io/v1alpha3
kind: Certificate
metadata:
  name: metrics-server-cert
  namespace: kube-system
spec:
  subject:
    organizations:
    - system:masters
  commonName: metrics-server.kube-system.svc
  duration: 8760h # 1 year <span id="CO16-1"></span><span class="callout">1</span>
  renewBefore: 720h # 1 month <span id="CO16-2"></span><span class="callout">2</span>
  # At least one of a DNS Name or IP address is required.
  dnsNames:
  - $(cat admin.conf | grep server | awk '{print $2}' | sed 's/https:\/\///g' | sed 's/:6443//g') <span id="CO16-3"></span><span class="callout">3</span>
  ipAddresses:
  - $(cat admin.conf | grep server | awk '{print $2}' | sed 's/https:\/\///g' | sed 's/:6443//g') <span id="CO16-4"></span><span class="callout">4</span>
  secretName: metrics-server-cert
  issuerRef:
    name: kubernetes-ca <span id="CO16-5"></span><span class="callout">5</span>
    kind: Issuer <span id="CO16-6"></span><span class="callout">6</span>
    group: cert-manager.io
  isCA: false
  usages:
    - digital signature
    - key encipherment
    - server auth
  keySize: 2048
  keyAlgorithm: rsa
  keyEncoding: pkcs1
EOF

kubectl create -f metrics-server-certificate.yaml</pre></div><div class="calloutlist "><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO16-1"><span class="callout">1</span></a> </p></td><td valign="top" align="left"><p>Default length of certificate validity, in the format (XhYmZs).</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO16-2"><span class="callout">2</span></a> </p></td><td valign="top" align="left"><p>Certificate renewal time before validity expires, in the format (XhYmZs).</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO16-3"><span class="callout">3</span></a> </p></td><td valign="top" align="left"><p>DNSNames is a list of subject alt names to be used on the Certificate.</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO16-4"><span class="callout">4</span></a> </p></td><td valign="top" align="left"><p>IPAddresses is a list of IP addresses to be used on the Certificate.</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO16-5"><span class="callout">5</span></a> </p></td><td valign="top" align="left"><p>The cert-manager issuer name.</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO16-6"><span class="callout">6</span></a> </p></td><td valign="top" align="left"><p>Issuer or ClusterIssuer.</p></td></tr></table></div></li></ul></div></li></ul></div><div id="id-1.8.10.9.8.5.3" class="admonition warning normal"><img class="symbol" alt="Warning" title="Warning" src="static/images/icon-warning.png" /><h6>Warning: Cert-Manager Known Issue</h6><p>Once the cert-manager has issued a certificate to the secret, if you change the certificate inside the secret manually, or you manually change the current certificate <code class="literal">duration</code> to a value lower than the value <code class="literal">renewBefore</code>, the certificate won’t be renewed immediately but will be scheduled to renew near the certificate expiry date.</p><p>This is because the cert-manager is not designed to pick up changes you make to the certificate in the secret.</p></div></div></div></div><div class="sect2" id="id-manual-certificate-renewal"><div class="titlepage"><div><div><h3 class="title"><span class="number">6.9.8 </span><span xmlns:dm="urn:x-suse:ns:docmanager" class="name">Manual Certificate Renewal</span> <a title="Permalink" class="permalink" href="id-security.html#id-manual-certificate-renewal">#</a></h3></div></div></div><div id="id-1.8.10.10.2" class="admonition important normal"><img class="symbol" alt="Important" title="Important" src="static/images/icon-important.png" /><h6>Important</h6><p>If you are running multiple control plane nodes, you need to run the followings
commands sequentially on all control plane nodes.</p></div><div class="sect3" id="id-renewing-control-plane-certificates"><div class="titlepage"><div><div><h4 class="title"><span class="number">6.9.8.1 </span><span xmlns:dm="urn:x-suse:ns:docmanager" class="name">Renewing Control Plane Certificates</span> <a title="Permalink" class="permalink" href="id-security.html#id-renewing-control-plane-certificates">#</a></h4></div></div></div><div class="itemizedlist "><ul class="itemizedlist"><li class="listitem "><p>Replace kubeadm-managed certificates:</p><div class="orderedlist "><ol class="orderedlist" type="1"><li class="listitem "><p>To SSH into the control plane node, renew all <code class="literal">kubeadm</code> certificates and reboot,
run the following:</p><div class="verbatim-wrap highlight bash"><pre class="screen">ssh &lt;USERNAME&gt;@&lt;MASTER_NODE_IP_ADDRESS/FQDN&gt;
sudo cp -r /etc/kubernetes/pki /etc/kubernetes/pki.bak
sudo kubeadm alpha certs renew all
sudo systemctl restart kubelet</pre></div></li><li class="listitem "><p>Copy the renewed <code class="literal">admin.conf</code> from one of the control plane nodes to your local environment:</p><div class="verbatim-wrap highlight bash"><pre class="screen">ssh &lt;USERNAME&gt;@&lt;MASTER_NODE_IP_ADDRESS/FQDN&gt;
sudo cat /etc/kubernetes/admin.conf</pre></div></li></ol></div></li><li class="listitem "><p>Replace the <code class="literal">kubelet</code> server certificate:</p><div id="id-1.8.10.10.3.2.2.2" class="admonition important normal"><img class="symbol" alt="Important" title="Important" src="static/images/icon-important.png" /><h6>Important</h6><p>You need to generate <code class="literal">kubelet</code> server certificate for all the nodes on one of control plane nodes.
The <code class="literal">kubelet</code> CA certificate key only exists on the control plane nodes.
Therefore, after generating re-signed <code class="literal">kubelet</code> server certificate/key for worker nodes, you have to copy each <code class="literal">kubelet</code> server certificate/key from the control plane node to the corresponding worker node.</p></div><div class="orderedlist "><ol class="orderedlist" type="1"><li class="listitem "><p>Backup the original <code class="literal">kubelet</code> certificates and keys on it’s node.</p><div class="verbatim-wrap highlight bash"><pre class="screen">sudo cp -r /var/lib/kubelet/pki /var/lib/kubelet/pki.bak</pre></div></li><li class="listitem "><p>Get the O/OU/CN, run the command on it’s node:</p><div class="verbatim-wrap highlight bash"><pre class="screen">openssl x509 -noout -subject -in /var/lib/kubelet/pki.bak/kubelet.crt</pre></div></li><li class="listitem "><p>Get the original SAN IP address(es) and DNS(s), run the command on it’s node:</p><div class="verbatim-wrap highlight bash"><pre class="screen">openssl x509 -noout -text -in /var/lib/kubelet/pki.bak/kubelet.crt | grep -oP '(?&lt;=IP Address:)[^,]+'
openssl x509 -noout -text -in /var/lib/kubelet/pki.bak/kubelet.crt | grep -oP '(?&lt;=DNS:)[^,]+'</pre></div></li><li class="listitem "><p>At one of the control plane node, sign the corresponding node <code class="literal">kubelet</code> server certificate with the CA certificate/key <code class="literal">/var/lib/kubelt/pki/kubelet-ca.crt</code> and <code class="literal">/var/lib/kubelet/pki/kubelet-ca.key</code>, please refer to <a class="xref" href="id-security.html#trusted-server-certificate" title="6.9.9.1.1. Trusted Server Certificate">Section 6.9.9.1.1, “Trusted Server Certificate”</a> on how to sign the trusted server certificate.  The <code class="literal">server.conf</code> for O/OU/CN <span class="emphasis"><em>recommends</em></span> be the same as original one, for IP.1 is the original SAN IP address if present, DNS.1 is the original SAN DNS if present.</p></li><li class="listitem "><p>Copy the signed certificate/key from one ofthe control plane node to the corresponding node.</p></li><li class="listitem "><p>Finally, update the <code class="literal">kubelet</code> server certificate and key file <code class="literal">/var/lib/kubelet/kubelet.crt</code> and <code class="literal">/var/lib/kubelet/kubelet.key</code> respectively, and restart <code class="literal">kubelet</code> service on it’s node.</p><div class="verbatim-wrap highlight bash"><pre class="screen">sudo cp &lt;CUSTOM_KUBELET_SERVER_CERT_PATH&gt; /var/lib/kubelet/pki/kubelet.crt
sudo cp &lt;CUSTOM_KUBELET_SERVER_KEY_PATH&gt; /var/lib/kubelet/pki/kubelet.key
chmod 644 /var/lib/kubelet/pki/kubelet.crt
chmod 600 /var/lib/kubelet/pki/kubelet.key

sudo systemctl restart kubelet</pre></div></li></ol></div></li></ul></div></div><div class="sect3" id="id-renewing-addon-certificates"><div class="titlepage"><div><div><h4 class="title"><span class="number">6.9.8.2 </span><span xmlns:dm="urn:x-suse:ns:docmanager" class="name">Renewing Addon Certificates:</span> <a title="Permalink" class="permalink" href="id-security.html#id-renewing-addon-certificates">#</a></h4></div></div></div><p>In the admin node, regenerate the certificates:</p><div class="itemizedlist "><ul class="itemizedlist"><li class="listitem "><p>Replace the <code class="literal">oidc-dex</code> server certificate:</p><div class="orderedlist "><ol class="orderedlist" type="1"><li class="listitem "><p>Backup the original <code class="literal">oidc-dex</code> server certificate and key from secret resource.</p><div class="verbatim-wrap highlight bash"><pre class="screen">mkdir -p &lt;CLUSTER_NAME&gt;/pki.bak
kubectl get secret oidc-dex-cert -n kube-system -o "jsonpath={.data['tls\.crt']}" | base64 --decode | tee &lt;CLUSTER_NAME&gt;/pki.bak/oidc-dex.crt &gt; /dev/null
kubectl get secret oidc-dex-cert -n kube-system -o "jsonpath={.data['tls\.key']}" | base64 --decode | tee &lt;CLUSTER_NAME&gt;/pki.bak/oidc-dex.key &gt; /dev/null</pre></div></li><li class="listitem "><p>Get the original SAN IP address(es) and DNS(s), run:</p><div class="verbatim-wrap highlight bash"><pre class="screen">openssl x509 -noout -text -in &lt;CLUSTER_NAME&gt;/pki.bak/oidc-dex.crt | grep -oP '(?&lt;=IP Address:)[^,]+'
openssl x509 -noout -text -in &lt;CLUSTER_NAME&gt;/pki.bak/oidc-dex.crt | grep -oP '(?&lt;=DNS:)[^,]+'</pre></div></li><li class="listitem "><p>Sign the <code class="literal">oidc-dex</code> server certificate with the default kubernetes CA certificate <span class="emphasis"><em>or</em></span> trusted CA certificate.</p><div class="orderedlist "><ol class="orderedlist" type="a"><li class="listitem "><p>Default kubernetes CA certificate</p><p>Please refer to <a class="xref" href="id-security.html#self-signed-server-certificate" title="6.9.9.2.2. Self-signed Server Certificate">Section 6.9.9.2.2, “Self-signed Server Certificate”</a> on how to sign the self signed server certificate. The default kubernetes CA certificate and key are located at <code class="literal">/etc/kubernetes/pki/ca.crt</code> and <code class="literal">/etc/kubernetes/pki/ca.key</code>. The <code class="literal">server.conf</code> for IP.1 is the original SAN IP address if present, DNS.1 is the original SAN DNS if present.</p></li><li class="listitem "><p>Trusted CA certificate</p><p>Please refer to <a class="xref" href="id-security.html#trusted-server-certificate" title="6.9.9.1.1. Trusted Server Certificate">Section 6.9.9.1.1, “Trusted Server Certificate”</a> on how to sign the trusted server certificate. The <code class="literal">server.conf</code> for IP.1 is the original SAN IP address if present, DNS.1 is the original SAN DNS if present.</p></li></ol></div></li><li class="listitem "><p>Import your certificate into the Kubernetes cluster.
The CA certificate is <code class="literal">&lt;CA_CERT_PATH&gt;</code>, server certificate and key are <code class="literal">&lt;SIGNED_OIDC_DEX_SERVER_CERT_PATH&gt;</code> and <code class="literal">&lt;SIGNED_OIDC_DEX_SERVER_KEY_PATH&gt;</code>.</p></li><li class="listitem "><p>Create a secret manifest file <code class="literal">oidc-dex-cert.yaml</code> and update the secret data <code class="literal">ca.crt</code>, <code class="literal">tls.crt</code>, and <code class="literal">tls.key</code> with base64; encoded with CA certificate, signed <code class="literal">oidc-dex</code> server certificate and key respectively.</p><div class="verbatim-wrap"><pre class="screen">apiVersion: v1
kind: Secret
metadata:
  name: oidc-dex-cert
  namespace: kube-system
  labels:
    caasp.suse.com/skuba-addon: "true"
type: kubernetes.io/tls
data:
  ca.crt: cat &lt;CA_CERT_PATH&gt; | base64 | awk '\{print\}' ORS='' &amp;&amp; echo
  tls.crt: cat &lt;SIGNED_OIDC_DEX_SERVER_CERT_PATH&gt; | base64 | awk '\{print\}' ORS='' &amp;&amp; echo
  tls.key: cat &lt;SIGNED_OIDC_DEX_SERVER_KEY_PATH&gt; | base64 | awk '\{print\}' ORS='' &amp;&amp; echo</pre></div></li><li class="listitem "><p>Apply the secret manifest file and restart <code class="literal">oidc-dex</code> pods.</p><div class="verbatim-wrap highlight bash"><pre class="screen">kubectl replace -f oidc-dex-cert.yaml
kubectl rollout restart deployment/oidc-dex -n kube-system</pre></div></li></ol></div></li><li class="listitem "><p>Replace the <code class="literal">oidc-gangway</code> server certificate:</p><div class="orderedlist "><ol class="orderedlist" type="1"><li class="listitem "><p>Backup the original <code class="literal">oidc-gangway</code> server certificate and key from secret resource.</p><div class="verbatim-wrap highlight bash"><pre class="screen">mkdir -p &lt;CLUSTER_NAME&gt;/pki.bak
kubectl get secret oidc-gangway-cert -n kube-system -o "jsonpath={.data['tls\.crt']}" | base64 --decode | tee &lt;CLUSTER_NAME&gt;/pki.bak/oidc-gangway.crt &gt; /dev/null
kubectl get secret oidc-gangway-cert -n kube-system -o "jsonpath={.data['tls\.key']}" | base64 --decode | tee &lt;CLUSTER_NAME&gt;/pki.bak/oidc-gangway.key &gt; /dev/null</pre></div></li><li class="listitem "><p>Get the original SAN IP address(es) and DNS(s), run:</p><div class="verbatim-wrap highlight bash"><pre class="screen">openssl x509 -noout -text -in &lt;CLUSTER_NAME&gt;/pki.bak/oidc-gangway.crt | grep -oP '(?&lt;=IP Address:)[^,]+'
openssl x509 -noout -text -in &lt;CLUSTER_NAME&gt;/pki.bak/oidc-gangway.crt | grep -oP '(?&lt;=DNS:)[^,]+'</pre></div></li><li class="listitem "><p>Sign the <code class="literal">oidc-gangway</code> server certificate with the default kubernetes CA certificate <span class="emphasis"><em>or</em></span> trusted CA certificate.</p><div class="orderedlist "><ol class="orderedlist" type="a"><li class="listitem "><p>Default kubernetes CA certificate</p><p>Please refer to <a class="xref" href="id-security.html#self-signed-server-certificate" title="6.9.9.2.2. Self-signed Server Certificate">Section 6.9.9.2.2, “Self-signed Server Certificate”</a> on how to sign the self signed server certificate. The default kubernetes CA certificate and key are located at <code class="literal">/etc/kubernetes/pki/ca.crt</code> and <code class="literal">/etc/kubernetes/pki/ca.key</code>. The <code class="literal">server.conf</code> for IP.1 is the original SAN IP address if present, DNS.1 is the original SAN DNS if present.</p></li><li class="listitem "><p>Trusted CA certificate</p><p>Please refer to <a class="xref" href="id-security.html#trusted-server-certificate" title="6.9.9.1.1. Trusted Server Certificate">Section 6.9.9.1.1, “Trusted Server Certificate”</a> on how to sign the trusted server certificate. The <code class="literal">server.conf</code> for IP.1 is the original SAN IP address if present, DNS.1 is the original SAN DNS if present.</p></li></ol></div></li><li class="listitem "><p>Import your certificate into the Kubernetes cluster.
The CA certificates is <code class="literal">&lt;CA_CERT_PATH&gt;</code>, server certificate and key are <code class="literal">&lt;SIGNED_OIDC_GANGWAY_SERVER_CERT_PATH&gt;</code> and <code class="literal">&lt;SIGNED_OIDC_GANGWAY_SERVER_KEY_PATH&gt;</code>.</p></li><li class="listitem "><p>Create a secret manifest file <code class="literal">oidc-gangway-cert.yaml</code> and update the secret data <code class="literal">ca.crt</code>, <code class="literal">tls.crt</code>, and <code class="literal">tls.key</code> with base64; encoded with CA certificate, signed <code class="literal">oidc-gangway</code> server certificate and key respectively.</p><div class="verbatim-wrap"><pre class="screen">apiVersion: v1
kind: Secret
metadata:
  name: oidc-gangway-cert
  namespace: kube-system
  labels:
    caasp.suse.com/skuba-addon: "true"
type: kubernetes.io/tls
data:
  ca.crt: cat &lt;CA_CERT_PATH&gt; | base64 | awk '\{print\}' ORS='' &amp;&amp; echo
  tls.crt: cat &lt;SIGNED_OIDC_GANGWAY_SERVER_CERT_PATH&gt; | base64 | awk '\{print\}' ORS='' &amp;&amp; echo
  tls.key: cat &lt;SIGNED_OIDC_GANGWAY_SERVER_KEY_PATH&gt; | base64 | awk '\{print\}' ORS='' &amp;&amp; echo</pre></div></li><li class="listitem "><p>Apply the secret manifest file and restart <code class="literal">oidc-gangway</code> pods.</p><div class="verbatim-wrap highlight bash"><pre class="screen">kubectl replace -f oidc-gangway-cert.yaml
kubectl rollout restart deployment/oidc-gangway -n kube-system</pre></div></li></ol></div></li><li class="listitem "><p>Replace the <code class="literal">metrics-server</code> server certificate:</p><div class="orderedlist "><ol class="orderedlist" type="1"><li class="listitem "><p>Backup the original <code class="literal">metrics-server</code> server certificate and key from secret resource.</p><div class="verbatim-wrap highlight bash"><pre class="screen">mkdir -p &lt;CLUSTER_NAME&gt;/pki.bak
kubectl get secret metrics-server-cert -n kube-system -o "jsonpath={.data['tls\.crt']}" | base64 --decode | tee &lt;CLUSTER_NAME&gt;/pki.bak/metrics-server.crt &gt; /dev/null
kubectl get secret metrics-server-cert -n kube-system -o "jsonpath={.data['tls\.key']}" | base64 --decode | tee &lt;CLUSTER_NAME&gt;/pki.bak/metrics-server.key &gt; /dev/null</pre></div></li><li class="listitem "><p>Get the O/OU/CN, run:</p><div class="verbatim-wrap highlight bash"><pre class="screen">openssl x509 -noout -subject -in &lt;CLUSTER_NAME&gt;/pki.bak/metrics-server.crt</pre></div></li><li class="listitem "><p>Get the original SAN IP address(es) and DNS(s), run:</p><div class="verbatim-wrap highlight bash"><pre class="screen">openssl x509 -noout -text -in &lt;CLUSTER_NAME&gt;/pki.bak/metrics-server.crt | grep -oP '(?&lt;=IP Address:)[^,]+'
openssl x509 -noout -text -in &lt;CLUSTER_NAME&gt;/pki.bak/metrics-server.crt | grep -oP '(?&lt;=DNS:)[^,]+'</pre></div></li><li class="listitem "><p>Sign the <code class="literal">metrics-server-cert</code> server certificate with the default Kubernetes CA certificate</p><p>Please refer to <a class="xref" href="id-security.html#self-signed-server-certificate" title="6.9.9.2.2. Self-signed Server Certificate">Section 6.9.9.2.2, “Self-signed Server Certificate”</a> on how to sign the self signed server certificate. The default Kubernetes CA certificate and key are located at <code class="literal">/etc/kubernetes/pki/ca.crt</code> and <code class="literal">/etc/kubernetes/pki/ca.key</code>. The <code class="literal">server.conf</code> for O/OU/CN <span class="emphasis"><em>must be</em></span> the same as original one, <code class="literal">IP.1</code> is the original SAN IP address if present, <code class="literal">DNS.1</code> is the original SAN DNS if present.</p></li><li class="listitem "><p>Import your certificate into the Kubernetes cluster.
The CA certificates is <code class="literal">&lt;CA_CERT_PATH&gt;</code>, server certificate and key are <code class="literal">&lt;SIGNED_METRICS_SERVER_CERT_PATH&gt;</code> and <code class="literal">&lt;SIGNED_METRICS_SERVER_KEY_PATH&gt;</code>.</p></li><li class="listitem "><p>Create a secret manifest file <code class="literal">oidc-metrics-server-cert.yaml</code> and update the secret data <code class="literal">ca.crt</code>, <code class="literal">tls.crt</code>, and <code class="literal">tls.key</code> with base64; encoded with CA certificate, signed <code class="literal">metrics-server</code> server certificate and key respectively.</p><div class="verbatim-wrap"><pre class="screen">apiVersion: v1
kind: Secret
metadata:
  name: metrics-server-cert
  namespace: kube-system
  labels:
    caasp.suse.com/skuba-addon: "true"
type: kubernetes.io/tls
data:
  ca.crt: cat &lt;CA_CERT_PATH&gt; | base64 | awk '\{print\}' ORS='' &amp;&amp; echo
  tls.crt: cat &lt;SIGNED_METRICS_SERVER_CERT_PATH&gt; | base64 | awk '\{print\}' ORS='' &amp;&amp; echo
  tls.key: cat &lt;SIGNED_METRICS_SERVER_KEY_PATH&gt; | base64 | awk '\{print\}' ORS='' &amp;&amp; echo</pre></div></li><li class="listitem "><p>Apply the secret manifest file and restart <code class="literal">metrics-server</code> pods.</p><div class="verbatim-wrap highlight bash"><pre class="screen">kubectl replace -f metrics-server-cert.yaml
kubectl rollout restart deployment/metrics-server -n kube-system</pre></div></li></ol></div></li></ul></div></div></div><div class="sect2" id="id-how-to-generate-certificates"><div class="titlepage"><div><div><h3 class="title"><span class="number">6.9.9 </span><span xmlns:dm="urn:x-suse:ns:docmanager" class="name">How To Generate Certificates</span> <a title="Permalink" class="permalink" href="id-security.html#id-how-to-generate-certificates">#</a></h3></div></div></div><div class="sect3" id="trusted-signed-certificate"><div class="titlepage"><div><div><h4 class="title"><span class="number">6.9.9.1 </span><span xmlns:dm="urn:x-suse:ns:docmanager" class="name">Trusted 3rd-Party Signed Certificate</span> <a title="Permalink" class="permalink" href="id-security.html#trusted-signed-certificate">#</a></h4></div></div></div><div class="sect4" id="trusted-server-certificate"><div class="titlepage"><div><div><h5 class="title"><span class="number">6.9.9.1.1 </span><span xmlns:dm="urn:x-suse:ns:docmanager" class="name">Trusted Server Certificate</span> <a title="Permalink" class="permalink" href="id-security.html#trusted-server-certificate">#</a></h5></div></div></div><div class="orderedlist "><ol class="orderedlist" type="1"><li class="listitem "><p>Generate a private key by following the steps below from a terminal window:</p><div class="verbatim-wrap highlight bash"><pre class="screen">openssl genrsa -aes256 -out server.key 2048</pre></div><p>Type the pass phrase to protect the key and press [Enter]</p><p>Re-enter the pass phrase.</p></li><li class="listitem "><p>Create a file <span class="emphasis"><em>server.conf</em></span> with the appropriate values</p><div class="verbatim-wrap"><pre class="screen">[req]
distinguished_name = req_distinguished_name
req_extensions = v3_req
prompt = no

[req_distinguished_name]
C = CZ <span id="CO17-1"></span><span class="callout">1</span>
ST = CZ <span id="CO17-2"></span><span class="callout">2</span>
L = Prague <span id="CO17-3"></span><span class="callout">3</span>
O = example <span id="CO17-4"></span><span class="callout">4</span>
OU = com <span id="CO17-5"></span><span class="callout">5</span>
CN = server.example.com <span id="CO17-6"></span><span class="callout">6</span>
emailAddress = admin@example.com <span id="CO17-7"></span><span class="callout">7</span>

[v3_req]
basicConstraints = critical,CA:FALSE
keyUsage = critical,digitalSignature,keyEncipherment
extendedKeyUsage = serverAuth
subjectAltName = @alt_names

[alt_names]
IP.1 = &lt;SERVER-IP-ADDRESS&gt; <span id="CO17-8"></span><span class="callout">8</span>
DNS.1 = &lt;SERVER-FQDN&gt; <span id="CO17-9"></span><span class="callout">9</span></pre></div><div class="calloutlist "><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO17-1"><span class="callout">1</span></a> </p></td><td valign="top" align="left"><p>Country Name (2 letter code).</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO17-2"><span class="callout">2</span></a> </p></td><td valign="top" align="left"><p>State or Province Name (full name).</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO17-3"><span class="callout">3</span></a> </p></td><td valign="top" align="left"><p>Locality Name (eg, city).</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO17-4"><span class="callout">4</span></a> </p></td><td valign="top" align="left"><p>Organization Name (eg, company).</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO17-5"><span class="callout">5</span></a> </p></td><td valign="top" align="left"><p>Organizational Unit Name (eg, section).</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO17-6"><span class="callout">6</span></a> </p></td><td valign="top" align="left"><p>Common Name (e.g. server FQDN or YOUR name)</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO17-7"><span class="callout">7</span></a> </p></td><td valign="top" align="left"><p>Email Address</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO17-8"><span class="callout">8</span></a> </p></td><td valign="top" align="left"><p>Server IP address if present. Add more IP.X below if the server has more than one IP address.
Remove IP.1 if the server uses FQDN.</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO17-9"><span class="callout">9</span></a> </p></td><td valign="top" align="left"><p>Server FQDN if present. Add more DNS.X below if the server has more than one domain name.
Remove DNS.1 if the server uses an IP address.</p></td></tr></table></div></li><li class="listitem "><p>Generate a certificate signing request (CSR)</p><div class="verbatim-wrap highlight bash"><pre class="screen">openssl req -new -key server.key -config server.conf -out server.csr</pre></div><p>Enter the pass phrase of the private key created in Step 1.</p><p>Check the certificate signing request (CSR)</p><div class="verbatim-wrap highlight bash"><pre class="screen">openssl req -text -noout -verify -in server.csr</pre></div></li><li class="listitem "><p>Sign the certificate</p><p>Send the certificate signing request (CSR) to the 3rd party for signing.
You should receive the following files in return:</p><div class="orderedlist "><ol class="orderedlist" type="a"><li class="listitem "><p>Server certificate (public key)</p></li><li class="listitem "><p>Intermediate CA and/or bundles that chain to the Trusted Root CA</p></li></ol></div></li></ol></div></div><div class="sect4" id="trusted-client-certificate"><div class="titlepage"><div><div><h5 class="title"><span class="number">6.9.9.1.2 </span><span xmlns:dm="urn:x-suse:ns:docmanager" class="name">Trusted Client Certificate</span> <a title="Permalink" class="permalink" href="id-security.html#trusted-client-certificate">#</a></h5></div></div></div><div class="orderedlist "><ol class="orderedlist" type="1"><li class="listitem "><p>Generate a private key by following the steps below from a terminal window:</p><div class="verbatim-wrap highlight bash"><pre class="screen">openssl genrsa -aes256 -out client.key 2048</pre></div><p>Type the pass phrase to protect the key and press [Enter]</p><p>Re-enter the pass phrase.</p></li><li class="listitem "><p>Create a file <span class="emphasis"><em>client.conf</em></span> with the appropriate values</p><div class="verbatim-wrap"><pre class="screen">[req]
distinguished_name = req_distinguished_name
req_extensions = v3_req
prompt = no

[req_distinguished_name]
C = CZ <span id="CO18-1"></span><span class="callout">1</span>
ST = CZ <span id="CO18-2"></span><span class="callout">2</span>
L = Prague <span id="CO18-3"></span><span class="callout">3</span>
O = example <span id="CO18-4"></span><span class="callout">4</span>
OU = com <span id="CO18-5"></span><span class="callout">5</span>
CN = client.example.com <span id="CO18-6"></span><span class="callout">6</span>
emailAddress = admin@example.com <span id="CO18-7"></span><span class="callout">7</span>

[v3_req]
basicConstraints = critical,CA:FALSE
keyUsage = critical,digitalSignature,keyEncipherment
extendedKeyUsage = clientAuth</pre></div><div class="calloutlist "><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO18-1"><span class="callout">1</span></a> </p></td><td valign="top" align="left"><p>Country Name (2 letter code).</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO18-2"><span class="callout">2</span></a> </p></td><td valign="top" align="left"><p>State or Province Name (full name).</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO18-3"><span class="callout">3</span></a> </p></td><td valign="top" align="left"><p>Locality Name (eg, city).</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO18-4"><span class="callout">4</span></a> </p></td><td valign="top" align="left"><p>Organization Name (eg, company).</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO18-5"><span class="callout">5</span></a> </p></td><td valign="top" align="left"><p>Organizational Unit Name (eg, section).</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO18-6"><span class="callout">6</span></a> </p></td><td valign="top" align="left"><p>Common Name (e.g. client FQDN or YOUR name)</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO18-7"><span class="callout">7</span></a> </p></td><td valign="top" align="left"><p>Email Address</p></td></tr></table></div></li><li class="listitem "><p>Generate a certificate signing request (CSR)</p><div class="verbatim-wrap highlight bash"><pre class="screen">openssl req -new -key client.key -config client.conf -out client.csr</pre></div><p>Enter the pass phrase of the private key created in Step 1.</p><p>Check the certificate signing request (CSR)</p><div class="verbatim-wrap highlight bash"><pre class="screen">openssl req -text -noout -verify -in client.csr</pre></div></li><li class="listitem "><p>Sign the certificate</p><p>Send the certificate signing request (CSR) to the 3rd party for signing.
You should receive the following files in return:</p><div class="orderedlist "><ol class="orderedlist" type="a"><li class="listitem "><p>Client certificate (public key)</p></li><li class="listitem "><p>Intermediate CA and/or bundles that chain to the Trusted Root CA</p></li></ol></div></li></ol></div></div></div><div class="sect3" id="self-signed-certificate"><div class="titlepage"><div><div><h4 class="title"><span class="number">6.9.9.2 </span><span xmlns:dm="urn:x-suse:ns:docmanager" class="name">Self-signed Server Certificate</span> <a title="Permalink" class="permalink" href="id-security.html#self-signed-certificate">#</a></h4></div></div></div><div id="id-1.8.10.11.3.2" class="admonition note normal"><img class="symbol" alt="Note" title="Note" src="static/images/icon-note.png" /><h6>Note</h6><p>In the case that you decide to use self-signed certificates, make sure that the Certificate Authority
used for signing is configured securely as a trusted Certificate Authority on the clients.</p></div><p>In some cases you want to create self-signed certificates for testing.
If you are using proper trusted 3rd-party CA signed certificates, skip the following steps and refer to <a class="xref" href="id-security.html#trusted-server-certificate" title="6.9.9.1.1. Trusted Server Certificate">Section 6.9.9.1.1, “Trusted Server Certificate”</a>.</p><div class="sect4" id="self-signed-ca-certificate"><div class="titlepage"><div><div><h5 class="title"><span class="number">6.9.9.2.1 </span><span xmlns:dm="urn:x-suse:ns:docmanager" class="name">Self-signed CA Certificate</span> <a title="Permalink" class="permalink" href="id-security.html#self-signed-ca-certificate">#</a></h5></div></div></div><div class="orderedlist "><ol class="orderedlist" type="1"><li class="listitem "><p>Create a file <span class="emphasis"><em>ca.conf</em></span> with the appropriate values</p><div class="verbatim-wrap"><pre class="screen">[req]
distinguished_name = req_distinguished_name
x509_extensions = v3_ca
prompt = no

[req_distinguished_name]
C = CZ <span id="CO19-1"></span><span class="callout">1</span>
ST = CZ <span id="CO19-2"></span><span class="callout">2</span>
L = Prague <span id="CO19-3"></span><span class="callout">3</span>
O = example <span id="CO19-4"></span><span class="callout">4</span>
OU = com <span id="CO19-5"></span><span class="callout">5</span>
CN = Root CA <span id="CO19-6"></span><span class="callout">6</span>
emailAddress = admin@example.com <span id="CO19-7"></span><span class="callout">7</span>

[v3_ca]
basicConstraints = critical,CA:TRUE
keyUsage = critical,digitalSignature,keyEncipherment,keyCertSign</pre></div><div class="calloutlist "><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO19-1"><span class="callout">1</span></a> </p></td><td valign="top" align="left"><p>Country Name (2 letter code).</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO19-2"><span class="callout">2</span></a> </p></td><td valign="top" align="left"><p>State or Province Name (full name).</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO19-3"><span class="callout">3</span></a> </p></td><td valign="top" align="left"><p>Locality Name (eg, city).</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO19-4"><span class="callout">4</span></a> </p></td><td valign="top" align="left"><p>Organization Name (eg, company).</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO19-5"><span class="callout">5</span></a> </p></td><td valign="top" align="left"><p>Organizational Unit Name (eg, section).</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO19-6"><span class="callout">6</span></a> </p></td><td valign="top" align="left"><p>Common Name (e.g. server FQDN or YOUR name)</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO19-7"><span class="callout">7</span></a> </p></td><td valign="top" align="left"><p>Email Address</p></td></tr></table></div></li><li class="listitem "><p>Sign the CA certificate</p><div class="verbatim-wrap highlight bash"><pre class="screen">openssl genrsa -out ca.key 2048
openssl req -key ca.key -new -x509 -days 3650 -sha256 -config ca.conf -out ca.crt</pre></div></li></ol></div></div><div class="sect4" id="self-signed-server-certificate"><div class="titlepage"><div><div><h5 class="title"><span class="number">6.9.9.2.2 </span><span xmlns:dm="urn:x-suse:ns:docmanager" class="name">Self-signed Server Certificate</span> <a title="Permalink" class="permalink" href="id-security.html#self-signed-server-certificate">#</a></h5></div></div></div><div class="orderedlist "><ol class="orderedlist" type="1"><li class="listitem "><p>Create a file <span class="emphasis"><em>server.conf</em></span> with the appropriate values</p><div class="verbatim-wrap"><pre class="screen">[req]
distinguished_name = req_distinguished_name
req_extensions = v3_req
prompt = no

[req_distinguished_name]
C = CZ <span id="CO20-1"></span><span class="callout">1</span>
ST = CZ <span id="CO20-2"></span><span class="callout">2</span>
L = Prague <span id="CO20-3"></span><span class="callout">3</span>
O = example <span id="CO20-4"></span><span class="callout">4</span>
OU = com <span id="CO20-5"></span><span class="callout">5</span>
CN = example.com <span id="CO20-6"></span><span class="callout">6</span>
emailAddress = admin@example.com <span id="CO20-7"></span><span class="callout">7</span>

[v3_req]
basicConstraints = critical,CA:FALSE
keyUsage = critical,digitalSignature,keyEncipherment
extendedKeyUsage = serverAuth
subjectAltName = @alt_names

[alt_names]
IP.1 = &lt;SERVER-IP-ADDRESS&gt; <span id="CO20-8"></span><span class="callout">8</span>
DNS.1 = &lt;SERVER-FQDN&gt; <span id="CO20-9"></span><span class="callout">9</span></pre></div><div class="calloutlist "><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO20-1"><span class="callout">1</span></a> </p></td><td valign="top" align="left"><p>Country Name (2 letter code).</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO20-2"><span class="callout">2</span></a> </p></td><td valign="top" align="left"><p>State or Province Name (full name).</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO20-3"><span class="callout">3</span></a> </p></td><td valign="top" align="left"><p>Locality Name (eg, city).</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO20-4"><span class="callout">4</span></a> </p></td><td valign="top" align="left"><p>Organization Name (eg, company).</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO20-5"><span class="callout">5</span></a> </p></td><td valign="top" align="left"><p>Organizational Unit Name (eg, section).</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO20-6"><span class="callout">6</span></a> </p></td><td valign="top" align="left"><p>Common Name (e.g. server FQDN or YOUR name)</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO20-7"><span class="callout">7</span></a> </p></td><td valign="top" align="left"><p>Email Address</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO20-8"><span class="callout">8</span></a> </p></td><td valign="top" align="left"><p>Server IP address if present. Add more IP.X below if the server has more than one IP address.
Remove IP.1 if the server uses FQDN.</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO20-9"><span class="callout">9</span></a> </p></td><td valign="top" align="left"><p>Server FQDN if present. Add more DNS.X below if the server has more than one domain name.
Remove DNS.1 if the server uses an IP address.</p></td></tr></table></div></li><li class="listitem "><p>Generate the certificate</p><div class="verbatim-wrap highlight bash"><pre class="screen">openssl genrsa -out server.key 2048
openssl req -key server.key -new -sha256 -out server.csr -config server.conf
openssl x509 -req -CA ca.crt -CAkey ca.key -CAcreateserial -in server.csr -out server.crt -days 365 -extensions v3_req -extfile server.conf</pre></div><p>Check the signed certificate</p><div class="verbatim-wrap highlight bash"><pre class="screen">openssl x509 -text -noout -in server.crt</pre></div></li></ol></div></div><div class="sect4" id="self-signed-client-certificate"><div class="titlepage"><div><div><h5 class="title"><span class="number">6.9.9.2.3 </span><span xmlns:dm="urn:x-suse:ns:docmanager" class="name">Self-signed Client Certificate</span> <a title="Permalink" class="permalink" href="id-security.html#self-signed-client-certificate">#</a></h5></div></div></div><div class="orderedlist "><ol class="orderedlist" type="1"><li class="listitem "><p>Create a file <span class="emphasis"><em>client.conf</em></span> with the appropriate values</p><div class="verbatim-wrap"><pre class="screen">[req]
distinguished_name = req_distinguished_name
req_extensions = v3_req
prompt = no

[req_distinguished_name]
C = CZ <span id="CO21-1"></span><span class="callout">1</span>
ST = CZ <span id="CO21-2"></span><span class="callout">2</span>
L = Prague <span id="CO21-3"></span><span class="callout">3</span>
O = example <span id="CO21-4"></span><span class="callout">4</span>
OU = com <span id="CO21-5"></span><span class="callout">5</span>
CN = client.example.com <span id="CO21-6"></span><span class="callout">6</span>
emailAddress = admin@example.com <span id="CO21-7"></span><span class="callout">7</span>

[v3_req]
basicConstraints = critical,CA:FALSE
keyUsage = critical,digitalSignature,keyEncipherment
extendedKeyUsage = clientAuth</pre></div><div class="calloutlist "><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO21-1"><span class="callout">1</span></a> </p></td><td valign="top" align="left"><p>Country Name (2 letter code).</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO21-2"><span class="callout">2</span></a> </p></td><td valign="top" align="left"><p>State or Province Name (full name).</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO21-3"><span class="callout">3</span></a> </p></td><td valign="top" align="left"><p>Locality Name (eg, city).</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO21-4"><span class="callout">4</span></a> </p></td><td valign="top" align="left"><p>Organization Name (eg, company).</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO21-5"><span class="callout">5</span></a> </p></td><td valign="top" align="left"><p>Organizational Unit Name (eg, section).</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO21-6"><span class="callout">6</span></a> </p></td><td valign="top" align="left"><p>Common Name (e.g. server FQDN or YOUR name)</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO21-7"><span class="callout">7</span></a> </p></td><td valign="top" align="left"><p>Email Address</p></td></tr></table></div></li><li class="listitem "><p>Generate the certificate</p><div class="verbatim-wrap highlight bash"><pre class="screen">openssl genrsa -out client.key 2048
openssl req -key client.key -new -sha256 -out client.csr -config client.conf
openssl x509 -req -CA ca.crt -CAkey ca.key -CAcreateserial -in client.csr -out client.crt -days 365 -extensions v3_req -extfile client.conf</pre></div><p>Check the signed certificate</p><div class="verbatim-wrap highlight bash"><pre class="screen">openssl x509 -text -noout -in client.crt</pre></div></li></ol></div></div></div></div></div></div></div><div class="page-bottom"><div id="_bottom-navigation"><a class="nav-link" href="id-logging.html"><span class="next-icon">→</span><span class="nav-label"><span class="number">Chapter 7 </span>Logging</span></a><a class="nav-link" href="id-upgrading-suse-caas-platform.html"><span class="prev-icon">←</span><span class="nav-label"><span class="number">Chapter 5 </span>Upgrading SUSE CaaS Platform</span></a></div><div class="_share-print"><div class="online-contents share"><strong>Share this page: </strong><span class="share-buttons"><span class="_share-fb bottom-button">Facebook</span><span class="spacer"> • </span><span class="_share-in bottom-button">LinkedIn</span><span class="spacer"> • </span><span class="_share-tw bottom-button">Twitter</span><span class="spacer"> • </span><span class="_share-mail bottom-button">E-Mail</span></span></div><div class="print"><span class="_print-button bottom-button">Print this page</span></div><div class="clearme"></div></div></div></div><div id="_inward"></div></div><div id="_footer-wrap"><div id="_footer"><p>©
        2021 
        SUSE</p><ul><li><a href="https://jobs.suse.com/" target="_top">Careers</a></li><li><a href="https://www.suse.com/company/legal/" target="_top">Legal</a></li><li><a href="https://www.suse.com/company/about/" target="_top">About</a></li><li><a href="https://www.suse.com/contact/" target="_top">Contact Us</a></li></ul></div></div></body></html>