<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang=""><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>Logging | Administration Guide | SUSE CaaS Platform 4.5.1</title><meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" /><link rel="stylesheet" type="text/css" href="static/css/style.css" /><link rel="stylesheet" type="text/css" href="static/css/highlight.css" /><meta name="generator" content="DAPS 3.0.0 (https://opensuse.github.io/daps) using SUSE XSL Stylesheets 2.0.17 (based on DocBook XSL Stylesheets 1.79.2) - chunked" /><meta name="product-name" content="SUSE CaaS Platform" /><meta name="product-number" content="4.5.1" /><meta name="book-title" content="Administration Guide" /><meta name="chapter-title" content="Chapter 7. Logging" /><meta name="description" content="Logging is ubiquitous throughout SUSE CaaS Platform. Some tools will only print their outputs to the currently running session shell and not create a log file ." /><meta name="tracker-url" content="https://github.com/SUSE/doc-caasp/issues/new" /><meta name="tracker-type" content="gh" /><meta name="tracker-gh-labels" content="AdminGuide" /><link rel="home" href="index.html" title="Administration Guide" /><link rel="up" href="index.html" title="Administration Guide" /><link rel="prev" href="_security.html" title="Chapter 6. Security" /><link rel="next" href="_monitoring.html" title="Chapter 8. Monitoring" />
<script type="text/javascript">

if ( window.location.protocol.toLowerCase() != 'file:' ) {
  document.write('<link rel="stylesheet" type="text/css" href="https://static.opensuse.org/fonts/fonts.css"></link>');
}
else {
  document.write('<link rel="stylesheet" type="text/css" href="static/css/fonts-onlylocal.css"></link>');
}

</script><noscript><link rel="stylesheet" type="text/css" href="https://static.opensuse.org/fonts/fonts.css" /></noscript><script src="static/js/jquery-1.10.2.min.js" type="text/javascript"></script><script src="static/js/script.js" type="text/javascript"></script><script src="static/js/highlight.min.js" type="text/javascript"></script><script>

$(document).ready(function() {
  $('.verbatim-wrap.highlight').each(function(i, block) {
    hljs.highlightBlock(block);
  });
});
hljs.configure({
  useBR: false
});

</script></head><body class="draft offline js-off" onload="$('#betawarn-button-wrap').toggle();if (document.cookie.length > 0) {if (document.cookie.indexOf('betawarn=closed') != -1){$('#betawarn').toggle()}};"><div id="betawarn" style="position:fixed;bottom:0;z-index:9025;background-color:#FDE8E8;padding:1em;margin-left:10%;margin-right:10%;display:block;border-top:.75em solid #E11;width:80%"><p style="color:#333;margin:1em 0;padding:0;">This is a draft document that was built and uploaded automatically. It may document beta software and be incomplete or even incorrect. <strong>Use this document at your own risk.</strong></p> <div id="betawarn-button-wrap" style="display:none;margin:0;padding:0;"><a href="#" onclick="$('#betawarn').toggle();var d=new Date();d.setTime(d.getTime()+(0.5*24*60*60*1000));document.cookie='betawarn=closed; expires='+d.toUTCString()+'; path=/'; return false;" style="color:#333;text-decoration:underline;float:left;margin-top:.5em;padding:1em;display:block;background-color:#FABEBE;">I understand this is a draft</a></div></div><div class="bypass-block"><a href="#_content">Jump to content</a><a href="#_bottom-navigation">Jump to page navigation: previous page [access key p]/next page [access key n]</a></div><div id="_outer-wrap"><div id="_white-bg" style="background-color: #FABEBE;"><div id="_header"><div id="_logo"><img src="static/images/logo.png" alt="Logo" /></div><div class="crumbs"><a class="book-link" href="index.html" title="Administration Guide"><span class="book-icon">Administration Guide</span></a><span> › </span><a class="crumb" href="_logging.html">Logging</a></div><div class="clearme"></div></div></div><div id="_toolbar-wrap"><div id="_toolbar"><div id="_toc-area" class="inactive"><a id="_toc-area-button" class="tool" title="Contents" accesskey="c" href="index.html"><span class="tool-spacer"><span class="toc-icon">Contents</span><span class="clearme"></span></span><span class="tool-label">Contents</span></a><div class="active-contents bubble-corner"></div><div class="active-contents bubble"><div class="bubble-container"><h6>Administration Guide</h6><div id="_bubble-toc"><ol><li class="inactive"><a href="pr01.html"><span class="number"> </span><span class="name"></span></a></li><li class="inactive"><a href="_about_this_guide.html"><span class="number">1 </span><span class="name">About This Guide</span></a></li><li class="inactive"><a href="_cluster_management.html"><span class="number">2 </span><span class="name">Cluster Management</span></a></li><li class="inactive"><a href="_software_management.html"><span class="number">3 </span><span class="name">Software Management</span></a></li><li class="inactive"><a href="_cluster_updates.html"><span class="number">4 </span><span class="name">Cluster Updates</span></a></li><li class="inactive"><a href="_upgrading_suse_caas_platform.html"><span class="number">5 </span><span class="name">Upgrading SUSE CaaS Platform</span></a></li><li class="inactive"><a href="_security.html"><span class="number">6 </span><span class="name">Security</span></a></li><li class="inactive"><a href="_logging.html"><span class="number">7 </span><span class="name">Logging</span></a></li><li class="inactive"><a href="_monitoring.html"><span class="number">8 </span><span class="name">Monitoring</span></a></li><li class="inactive"><a href="_storage.html"><span class="number">9 </span><span class="name">Storage</span></a></li><li class="inactive"><a href="_integration.html"><span class="number">10 </span><span class="name">Integration</span></a></li><li class="inactive"><a href="_gpu_dependent_workloads.html"><span class="number">11 </span><span class="name">GPU-Dependent Workloads</span></a></li><li class="inactive"><a href="_cluster_disaster_recovery.html"><span class="number">12 </span><span class="name">Cluster Disaster Recovery</span></a></li><li class="inactive"><a href="backup-and-restore-with-velero.html"><span class="number">13 </span><span class="name">Backup and Restore with Velero</span></a></li><li class="inactive"><a href="_miscellaneous.html"><span class="number">14 </span><span class="name">Miscellaneous</span></a></li><li class="inactive"><a href="_troubleshooting_3.html"><span class="number">15 </span><span class="name">Troubleshooting</span></a></li><li class="inactive"><a href="_glossary.html"><span class="number">16 </span><span class="name">Glossary</span></a></li><li class="inactive"><a href="_contributors.html"><span class="number">A </span><span class="name">Contributors</span></a></li><li class="inactive"><a href="_gnu_licenses.html"><span class="number">B </span><span class="name">GNU Licenses</span></a></li></ol></div><div class="clearme"></div></div></div></div><div id="_nav-area" class="inactive"><div class="tool"><span class="nav-inner"><span class="tool-label">Navigation</span><a accesskey="p" class="tool-spacer" title="Chapter 6. Security" href="_security.html"><span class="prev-icon">←</span></a><a accesskey="n" class="tool-spacer" title="Chapter 8. Monitoring" href="_monitoring.html"><span class="next-icon">→</span></a></span></div></div></div></div><div id="_fixed-header-wrap" style="background-color: #FABEBE;" class="inactive"><div id="_fixed-header"><div class="crumbs"><a class="book-link" href="index.html" title="Administration Guide"><span class="book-icon">Administration Guide</span></a><span> › </span><a class="crumb" href="_logging.html">Logging</a></div><div class="buttons"><a class="top-button button" href="#">Top</a><div class="button"><a accesskey="p" class="tool-spacer" title="Chapter 6. Security" href="_security.html"><span class="prev-icon">←</span></a><a accesskey="n" class="tool-spacer" title="Chapter 8. Monitoring" href="_monitoring.html"><span class="next-icon">→</span></a></div><div class="clearme"></div></div><div class="clearme"></div></div></div><div id="_content" class="draft "><div class="documentation"><div class="chapter " id="_logging"><div class="titlepage"><div><div class="version-info">Applies to  <span class="productname ">SUSE CaaS Platform</span> <span class="productnumber ">4.5.1</span></div><div><h1 class="title"><span class="number">7 </span><span xmlns:dm="urn:x-suse:ns:docmanager" class="name">Logging</span> <a title="Permalink" class="permalink" href="_logging.html#">#</a></h1></div></div></div><div class="line"><div class="toc"><dl><dt><span class="section"><a href="_logging.html#_introduction_2"><span class="number">7.1 </span><span class="name">Introduction</span></a></span></dt><dt><span class="section"><a href="_logging.html#tee-logging"><span class="number">7.2 </span><span class="name">Logging in skuba</span></a></span></dt><dt><span class="section"><a href="_logging.html#_audit_log"><span class="number">7.3 </span><span class="name">Audit Log</span></a></span></dt><dt><span class="section"><a href="_logging.html#centralized-logging"><span class="number">7.4 </span><span class="name">Centralized Logging</span></a></span></dt></dl></div></div><div class="sect1" id="_introduction_2"><div class="titlepage"><div><div><h2 class="title"><span class="number">7.1 </span><span xmlns:dm="urn:x-suse:ns:docmanager" class="name">Introduction</span> <a title="Permalink" class="permalink" href="_logging.html#_introduction_2">#</a></h2></div></div></div><p>Logging is ubiquitous throughout SUSE CaaS Platform. Some tools will only print their
outputs to the currently running session shell and not create a "log file".</p><p>If you need to retain the output of these files you can <code class="literal">tee</code> them into a separate file (refer to <a class="xref" href="_logging.html#tee-logging" title="7.2. Logging in skuba">Section 7.2, “Logging in skuba”</a>).</p><p>Many other service components will produce log files or other log info streams.
You can collect, store and evaluate these logs via <a class="xref" href="_logging.html#centralized-logging" title="7.4. Centralized Logging">Section 7.4, “Centralized Logging”</a> for
use with the <a class="xref" href="_monitoring.html#monitoring-stack" title="8.1. Monitoring Stack">Section 8.1, “Monitoring Stack”</a>.</p><div id="id-1.9.2.5" class="admonition note normal"><img class="symbol" alt="Note" title="Note" src="static/images/icon-note.png" /><h6>Note</h6><p>If you are looking for troubleshooting logs please refer to <a class="xref" href="_troubleshooting_3.html#troubleshooting-logs" title="15.3. Log collection">Section 15.3, “Log collection”</a>.</p></div></div><div class="sect1" id="tee-logging"><div class="titlepage"><div><div><h2 class="title"><span class="number">7.2 </span><span xmlns:dm="urn:x-suse:ns:docmanager" class="name">Logging in skuba</span> <a title="Permalink" class="permalink" href="_logging.html#tee-logging">#</a></h2></div></div></div><p>One important part of deploying and maintaining a product is to have reliable
logs. Tools like <code class="literal">skuba</code> take the approach of printing the output to the
standard output directly. This is not just common practice, but it also has the
advantage that then the user has more flexibility on how to manage said output.</p><p>Thus, whenever throughout this guide we write a <code class="literal">skuba</code> command, take into
account that the output will be printed into the standard output. If you would
also like to have the logs stored somewhere else for later inspection, you can
use tools like <code class="literal">tee</code>. For example:</p><div class="verbatim-wrap highlight bash"><pre class="screen">skuba node bootstrap --user sles --sudo --target &lt;IP/FQDN&gt; &lt;NODE_NAME&gt; | tee &lt;NODE_NAME&gt;-skuba-node-bootstrap.log</pre></div><p>Otherwise, you might want to use other tools to manage the logs for later
inspection. The point being that this guide will never consider how to manage
these logs because <code class="literal">skuba</code> itself does not. It’s up to you to manage these logs
in any way you find desirable.</p><p>Moreover, <code class="literal">skuba</code> has also various levels of log verbosity. This is managed by
the <code class="literal">-v, --verbosity</code> flag. This flag accepts an integer argument, ranging from
0 to 5, where a higher number means a higher level of verbosity. If you don’t
pass any arguments, then 0 is assumed. We recommend using the default argument,
since it will already log warnings and errors, among other relevant output,
whereas 5 can be a bit overwhelming. Thus, for the above example, we would
recommend something like:</p><div class="verbatim-wrap highlight bash"><pre class="screen">skuba node bootstrap -v --user sles --sudo --target &lt;IP/FQDN&gt; &lt;NODE_NAME&gt; | tee &lt;NODE_NAME&gt;-skuba-node-bootstrap.log</pre></div><p>Now the <code class="literal">&lt;NODE_NAME&gt;-skuba-node-bootstrap.log</code> will have more useful information
than without the <code class="literal">-v</code> flag. We <span class="strong"><strong>strongly</strong></span> recommend using this flag in order to
get as much useful information as possible from a single run.</p></div><div class="sect1" id="_audit_log"><div class="titlepage"><div><div><h2 class="title"><span class="number">7.3 </span><span xmlns:dm="urn:x-suse:ns:docmanager" class="name">Audit Log</span> <a title="Permalink" class="permalink" href="_logging.html#_audit_log">#</a></h2></div></div></div><p>To track actions that have been performed on the cluster, you can enable the Kubernetes audit log during cluster bootstrap or on a running cluster.</p><p>This allows the audit logs to be written on the Kubernetes master nodes at <code class="literal">/var/log/kube-apiserver/audit.log</code> or the given path.</p><p>For more information on the audit log and its contents, see: <a class="link" href="https://kubernetes.io/docs/tasks/debug-application-cluster/audit/" target="_blank">https://kubernetes.io/docs/tasks/debug-application-cluster/audit/</a></p><div class="sect2" id="_limitations"><div class="titlepage"><div><div><h3 class="title"><span class="number">7.3.1 </span><span xmlns:dm="urn:x-suse:ns:docmanager" class="name">Limitations</span> <a title="Permalink" class="permalink" href="_logging.html#_limitations">#</a></h3></div></div></div><p>The Kubernetes audit log only collects and stores actions performed on the level of the cluster. This does not include any resulting actions of application services.</p></div><div class="sect2" id="_enable_auditing_during_cluster_bootstrap"><div class="titlepage"><div><div><h3 class="title"><span class="number">7.3.2 </span><span xmlns:dm="urn:x-suse:ns:docmanager" class="name">Enable Auditing During Cluster Bootstrap</span> <a title="Permalink" class="permalink" href="_logging.html#_enable_auditing_during_cluster_bootstrap">#</a></h3></div></div></div><div class="orderedlist "><ol class="orderedlist" type="1"><li class="listitem "><p>Create audit policy file - <code class="literal">audit.yaml</code>. Here uses a simple policy for demonstration.</p><div class="informalexample"><div class="verbatim-wrap"><pre class="screen">apiVersion: audit.k8s.io/v1beta1
kind: Policy
rules:
  - level: Metadata <span id="CO22-1"></span><span class="callout">1</span></pre></div></div><div class="calloutlist "><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO22-1"><span class="callout">1</span></a> </p></td><td valign="top" align="left"><p>The audit level of the event. This sample will log all requests at the Metadata level.
For detailed information, refer to: <a class="link" href="https://kubernetes.io/docs/tasks/debug-application-cluster/audit/#audit-policy" target="_blank">https://kubernetes.io/docs/tasks/debug-application-cluster/audit/#audit-policy</a></p></td></tr></table></div></li><li class="listitem "><p>Create audit policy file directory on all master nodes.</p><div class="verbatim-wrap"><pre class="screen">sudo mkdir -p /etc/kubernetes/policies</pre></div></li><li class="listitem "><p>Copy audit policy file - <code class="literal">audit.yaml</code> to <code class="literal">/etc/kubernetes/policies/audit.yaml</code> on all master nodes.</p></li><li class="listitem "><p>Edit <code class="literal">kubeadm-init.conf</code> file in skuba init folder to add audit related configurations.</p><div class="verbatim-wrap"><pre class="screen">vi &lt;my_cluster&gt;/kubeadm-init.conf</pre></div><div class="informalexample"><div class="verbatim-wrap"><pre class="screen"> ...
apiServer:
  extraArgs:
    audit-log-path: /var/log/kube-apiserver/audit.log
    audit-policy-file: /etc/kubernetes/policies/audit.yaml <span id="CO23-1"></span><span class="callout">1</span>
    audit-log-maxage: "30" <span id="CO23-2"></span><span class="callout">2</span>
    audit-log-maxsize: "100" <span id="CO23-3"></span><span class="callout">3</span>
    audit-log-maxbackup: "5" <span id="CO23-4"></span><span class="callout">4</span>
    audit-log-format: json <span id="CO23-5"></span><span class="callout">5</span>
  extraVolumes:
  - name: audit-policy
    hostPath: /etc/kubernetes/policies/audit.yaml <span id="CO23-6"></span><span class="callout">6</span>
    mountPath: /etc/kubernetes/policies/audit.yaml <span id="CO23-7"></span><span class="callout">7</span>
    readOnly: true
    pathType: File
  - name: audit-logs
    hostPath: /var/log/kube-apiserver <span id="CO23-8"></span><span class="callout">8</span>
    mountPath: /var/log/kube-apiserver <span id="CO23-9"></span><span class="callout">9</span>
    pathType: DirectoryOrCreate
 ...</pre></div></div><div class="calloutlist "><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO23-1"><span class="callout">1</span></a> </p></td><td valign="top" align="left"><p>Path to the YAML file that defines the audit policy configuration.</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO23-2"><span class="callout">2</span></a> </p></td><td valign="top" align="left"><p>The maximum number of days to retain old audit log files based on the timestamp encoded in their filename. (Default: 15)</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO23-3"><span class="callout">3</span></a> </p></td><td valign="top" align="left"><p>The maximum size in megabytes of the audit log file before it gets rotated. (Default: 10)</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO23-4"><span class="callout">4</span></a> </p></td><td valign="top" align="left"><p>The maximum number of old audit log files to retain. (Default: 20)</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO23-5"><span class="callout">5</span></a> </p></td><td valign="top" align="left"><p>Format of saved audits. Known formats are "legacy", "json". "legacy" indicates 1-line text format for each event. "json" indicates structured json format.</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO23-6"><span class="callout">6</span></a> </p></td><td valign="top" align="left"><p>The audit policy configuration file path from the host node’s filesystem.</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO23-7"><span class="callout">7</span></a> </p></td><td valign="top" align="left"><p>The audit policy configuration file path on the api-server pod.</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO23-8"><span class="callout">8</span></a> </p></td><td valign="top" align="left"><p>The audit log file directory from the host node’s filesystem.</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO23-9"><span class="callout">9</span></a> </p></td><td valign="top" align="left"><p>The audit log file directory on the api-server pod.</p></td></tr></table></div></li><li class="listitem "><p>Proceed with <a class="link" href="https://documentation.suse.com/suse-caasp/4.5/html/caasp-deployment/bootstrap.html" target="_blank">Cluster Bootstrap</a>.</p></li><li class="listitem "><p>If everything is setup correctly, you should be able to see audit logs are written to <code class="literal">/var/log/kube-apiserver/audit.log</code>.</p></li></ol></div></div><div class="sect2" id="_enable_auditing_on_running_cluster"><div class="titlepage"><div><div><h3 class="title"><span class="number">7.3.3 </span><span xmlns:dm="urn:x-suse:ns:docmanager" class="name">Enable Auditing On Running Cluster</span> <a title="Permalink" class="permalink" href="_logging.html#_enable_auditing_on_running_cluster">#</a></h3></div></div></div><div id="id-1.9.4.7.2" class="admonition note normal"><img class="symbol" alt="Note" title="Note" src="static/images/icon-note.png" /><h6>Note</h6><p>The following steps take effect only on the updated master nodes. You need to repeat the following steps on every master node in the cluster.</p></div><div class="orderedlist "><ol class="orderedlist" type="1"><li class="listitem "><p>Create audit policy file - <code class="literal">audit.yaml</code>. Here uses a simple policy for demonstration.</p><div class="informalexample"><div class="verbatim-wrap"><pre class="screen">apiVersion: audit.k8s.io/v1beta1
kind: Policy
rules:
  - level: Metadata <span id="CO24-1"></span><span class="callout">1</span></pre></div></div><div class="calloutlist "><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO24-1"><span class="callout">1</span></a> </p></td><td valign="top" align="left"><p>The audit level of the event. This sample will log all requests at the Metadata level. For detailed information, refer to: <a class="link" href="https://kubernetes.io/docs/tasks/debug-application-cluster/audit/#audit-policy" target="_blank">https://kubernetes.io/docs/tasks/debug-application-cluster/audit/#audit-policy</a></p></td></tr></table></div></li><li class="listitem "><p>Create audit policy file directory on master node.</p><div class="verbatim-wrap"><pre class="screen">sudo mkdir -p /etc/kubernetes/policies</pre></div></li><li class="listitem "><p>Copy audit policy file - <code class="literal">audit.yaml</code> to <code class="literal">/etc/kubernetes/policies/audit.yaml</code> on master node.</p></li><li class="listitem "><p>Edit <code class="literal">/etc/kubernetes/manifests/kube-apiserver.yaml</code>.</p><div class="informalexample"><div class="verbatim-wrap"><pre class="screen"> ...
spec:
  containers:
  - command:
    - kube-apiserver
    - --audit-log-path=/var/log/kube-apiserver/audit.log
    - --audit-policy-file=/etc/kubernetes/policies/audit.yaml <span id="CO25-1"></span><span class="callout">1</span>
    - --audit-log-maxage=30 <span id="CO25-2"></span><span class="callout">2</span>
    - --audit-log-maxsize=100 <span id="CO25-3"></span><span class="callout">3</span>
    - --audit-log-maxbackup=5 <span id="CO25-4"></span><span class="callout">4</span>
    - --audit-log-format=json <span id="CO25-5"></span><span class="callout">5</span>
 ...
    volumeMounts:
    - mountPath: /etc/kubernetes/policies/audit.yaml <span id="CO25-6"></span><span class="callout">6</span>
      name: audit-policy
      readOnly: true
    - mountPath: /var/log/kube-apiserver <span id="CO25-7"></span><span class="callout">7</span>
      name: audit-logs
 ...
  volumes:
  - hostPath:
      path: /etc/kubernetes/policies/audit.yaml <span id="CO25-8"></span><span class="callout">8</span>
      type: File
    name: audit-policy
  - hostPath:
      path: /var/log/kube-apiserver <span id="CO25-9"></span><span class="callout">9</span>
      type: DirectoryOrCreate
    name: audit-logs
 ...</pre></div></div><div class="calloutlist "><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO25-1"><span class="callout">1</span></a> </p></td><td valign="top" align="left"><p>Path to the YAML file that defines the audit policy configuration.</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO25-2"><span class="callout">2</span></a> </p></td><td valign="top" align="left"><p>The maximum number of days to retain old audit log files based on the timestamp encoded in their filename. (Default: 15)</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO25-3"><span class="callout">3</span></a> </p></td><td valign="top" align="left"><p>The maximum size in megabytes of the audit log file before it gets rotated. (Default: 10)</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO25-4"><span class="callout">4</span></a> </p></td><td valign="top" align="left"><p>The maximum number of old audit log files to retain. (Default: 20)</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO25-5"><span class="callout">5</span></a> </p></td><td valign="top" align="left"><p>Format of saved audits. Known formats are "legacy", "json". "legacy" indicates 1-line text format for each event. "json" indicates structured json format.</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO25-6"><span class="callout">6</span></a> </p></td><td valign="top" align="left"><p>The audit policy configuration file path on the api-server pod.</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO25-7"><span class="callout">7</span></a> </p></td><td valign="top" align="left"><p>The audit log file directory on the api-server pod.</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO25-8"><span class="callout">8</span></a> </p></td><td valign="top" align="left"><p>The audit policy configuration file path from the host node’s filesystem.</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO25-9"><span class="callout">9</span></a> </p></td><td valign="top" align="left"><p>The audit log file directory from the host node’s filesystem.</p></td></tr></table></div></li><li class="listitem "><p>Restart kubelet.</p><div class="verbatim-wrap"><pre class="screen">sudo systemctl restart kubelet</pre></div></li><li class="listitem "><p>If everything is set up correctly, you should be able to see audit logs being written to <code class="literal">/var/log/kube-apiserver/audit.log</code>.</p></li></ol></div></div><div class="sect2" id="_disable_auditing"><div class="titlepage"><div><div><h3 class="title"><span class="number">7.3.4 </span><span xmlns:dm="urn:x-suse:ns:docmanager" class="name">Disable Auditing</span> <a title="Permalink" class="permalink" href="_logging.html#_disable_auditing">#</a></h3></div></div></div><div id="id-1.9.4.8.2" class="admonition note normal"><img class="symbol" alt="Note" title="Note" src="static/images/icon-note.png" /><h6>Note</h6><p>The following steps take effect only on the updated master nodes. You need to repeat the following steps on every master node in the cluster.</p></div><div class="orderedlist "><ol class="orderedlist" type="1"><li class="listitem "><p>Remote access to the master node.</p></li></ol></div><div class="verbatim-wrap"><pre class="screen">ssh sles@&lt;master_node&gt;</pre></div><div class="orderedlist "><ol class="orderedlist" type="1"><li class="listitem "><p>Edit <code class="literal">/etc/kubernetes/manifests/kube-apiserver.yaml</code> and remove the following lines.</p><div class="informalexample"><div class="verbatim-wrap"><pre class="screen">...
   - --audit-log-path=/var/log/kube-apiserver/audit.log
   - --audit-policy-file=/etc/kubernetes/policies/audit.yaml
   - --audit-log-maxage=30
   - --audit-log-maxsize=100
   - --audit-log-maxbackup=5
   - --audit-log-format=json
...
   - mountPath: /etc/kubernetes/policies/audit.yaml
     name: audit-policy
     readOnly: true
   - mountPath: /var/log/kube-apiserver
     name: audit-logs
...
 - hostPath:
     path: /etc/kubernetes/policies/audit.yaml
     type: File
   name: audit-policy
 - hostPath:
     path: /var/log/kube-apiserver
     type: DirectoryOrCreate
   name: audit-logs</pre></div></div></li><li class="listitem "><p>Restart kubelet.</p><div class="verbatim-wrap"><pre class="screen">sudo systemctl restart kubelet</pre></div></li></ol></div></div></div><div class="sect1" id="centralized-logging"><div class="titlepage"><div><div><h2 class="title"><span class="number">7.4 </span><span xmlns:dm="urn:x-suse:ns:docmanager" class="name">Centralized Logging</span> <a title="Permalink" class="permalink" href="_logging.html#centralized-logging">#</a></h2></div></div></div><p>Centralized Logging is a means of collecting logs from the SUSE CaaS Platform for centralized management.
It forwards system and Kubernetes cluster logs to a specified external logging service,
for example, Rsyslog server.</p><p>Collecting logs in a central location can be useful for audit or debug purposes or to analyze and visually present data.</p><div class="sect2" id="_prerequisites_3"><div class="titlepage"><div><div><h3 class="title"><span class="number">7.4.1 </span><span xmlns:dm="urn:x-suse:ns:docmanager" class="name">Prerequisites</span> <a title="Permalink" class="permalink" href="_logging.html#_prerequisites_3">#</a></h3></div></div></div><p>In order to successfully use Centralized Logging, you first need to install <code class="literal">Helm</code>, and <code class="literal">Tiller</code> if using Helm 2.
Helm is used to install the log agents and provide custom logging settings.</p><p>Refer to <a class="xref" href="_software_management.html#helm-tiller-install" title="3.1.2.1. Installing Helm">Section 3.1.2.1, “Installing Helm”</a>.</p></div><div class="sect2" id="_types_of_logs"><div class="titlepage"><div><div><h3 class="title"><span class="number">7.4.2 </span><span xmlns:dm="urn:x-suse:ns:docmanager" class="name">Types of Logs</span> <a title="Permalink" class="permalink" href="_logging.html#_types_of_logs">#</a></h3></div></div></div><p>You can log the following groups of services. See <a class="xref" href="_logging.html#_deployment" title="7.4.4. Deployment">Section 7.4.4, “Deployment”</a>
for more information on how to select and customize the logs.</p><div class="variablelist "><dl class="variablelist"><dt id="id-1.9.5.5.3.1"><span class="term ">Kubernetes System Components</span></dt><dd><div class="itemizedlist "><ul class="itemizedlist"><li class="listitem "><p>Kubelet</p></li><li class="listitem "><p>Cri-o</p></li></ul></div></dd><dt id="id-1.9.5.5.3.2"><span class="term ">Kubernetes Control Plane Components</span></dt><dd><div class="itemizedlist "><ul class="itemizedlist"><li class="listitem "><p>API Server</p></li><li class="listitem "><p>Controller Manager</p></li><li class="listitem "><p>Scheduler</p></li><li class="listitem "><p>Cilium</p></li><li class="listitem "><p>Kube-proxy</p></li><li class="listitem "><p>All resources in the kube-system namespaces</p></li></ul></div></dd><dt id="id-1.9.5.5.3.3"><span class="term ">Kubernetes Namespaces Pods</span></dt><dd><div class="itemizedlist "><ul class="itemizedlist"><li class="listitem "><p>All namespaces in cluster except kube-system</p></li></ul></div></dd><dt id="id-1.9.5.5.3.4"><span class="term ">Kubernetes Audit Log</span></dt><dd><div class="itemizedlist "><ul class="itemizedlist"><li class="listitem "><p><a class="link" href="https://documentation.suse.com/suse-caasp/4.5/html/caasp-admin/_logging.html#_audit_log" target="_blank">Audit Log</a></p></li></ul></div></dd><dt id="id-1.9.5.5.3.5"><span class="term ">OS Components</span></dt><dd><div class="itemizedlist "><ul class="itemizedlist"><li class="listitem "><p>Kernel</p></li><li class="listitem "><p>Audit</p></li><li class="listitem "><p>Zypper</p></li><li class="listitem "><p>Network (wicked)</p></li></ul></div></dd></dl></div><p>Centralized Logging is also restricted to the following protocols: UDP, TCP, TCP + TLS, TCP + mTLS.</p></div><div class="sect2" id="_log_formats"><div class="titlepage"><div><div><h3 class="title"><span class="number">7.4.3 </span><span xmlns:dm="urn:x-suse:ns:docmanager" class="name">Log Formats</span> <a title="Permalink" class="permalink" href="_logging.html#_log_formats">#</a></h3></div></div></div><p>The two supported syslog message formats are <span class="strong"><strong>RFC 5424</strong></span> and <span class="strong"><strong>RFC 3164</strong></span>.</p><div id="id-1.9.5.6.3" class="admonition note normal"><img class="symbol" alt="Note" title="Note" src="static/images/icon-note.png" /><h6>Note</h6><p>The Kubernetes cluster metadata is included in the RFC 5424 message.</p></div><p>Example RFC 3164</p><div class="verbatim-wrap"><pre class="screen">2019-05-30T09:11:21.968458+00:00 worker1 k8s.system/crio[12080] level=debug msg="Endpoint successfully created" containerID=caa46f14a68e766b877af01442e58731845bb45d8ce1f856553440a02c958b2f eventUUID=e2405f2a-82ba-11e9-9a06-fa163eebdfd6 subsys=cilium-cni</pre></div><p>Example RFC 5424</p><div class="verbatim-wrap"><pre class="screen">&lt;133&gt;1 2019-05-30T08:28:38.784214+00:00 master0 k8s.pod/kube-system/kube-apiserver-master0/kube-apiserver - - [kube_meta namespace_id="1e030def-81db-11e9-a62b-fa163e1876c9" container_name="kube-apiserver" creation_timestamp="2019-05-29T06:29:31Z" host="master0" namespace_name="kube-system" master_url="https://kubernetes.default.svc.cluster.local:443" pod_id="4aaf10f9-81db-11e9-a62b-fa163e1876c9" pod_name="kube-apiserver-master0"] 2019-05-30T08:28:38.783780355+00:00 stderr F I0530 08:28:38.783710       1 log.go:172] http: TLS handshake error from 172.28.0.19:45888: tls: client offered only unsupported versions: [300]</pre></div></div><div class="sect2" id="_deployment"><div class="titlepage"><div><div><h3 class="title"><span class="number">7.4.4 </span><span xmlns:dm="urn:x-suse:ns:docmanager" class="name">Deployment</span> <a title="Permalink" class="permalink" href="_logging.html#_deployment">#</a></h3></div></div></div><p>After you have successfully installed it,
use Helm CLI to install log agents on each node,
and provide customized settings via specific command options.</p><p>The only three mandatory parameters for a successful deployment of Centralized Logging
are:</p><div class="itemizedlist "><ul class="itemizedlist"><li class="listitem "><p><code class="literal"><span class="strong"><strong>server.host</strong></span></code>, default value = rsyslog-server.default.svc.cluster.local</p></li><li class="listitem "><p><code class="literal"><span class="strong"><strong>server.port</strong></span></code>, default value = 514</p></li><li class="listitem "><p><code class="literal"><span class="strong"><strong>server.protocol</strong></span></code>, default value = TCP</p></li></ul></div><p>See <a class="xref" href="_logging.html#log-optional_settings" title="7.4.6. Optional settings">Section 7.4.6, “Optional settings”</a> for the optional parameters and their default values.</p><div class="itemizedlist "><ul class="itemizedlist"><li class="listitem "><p>Running the following will create the minimal working setup:</p></li></ul></div><div class="verbatim-wrap highlight bash"><pre class="screen">helm repo add suse https://kubernetes-charts.suse.com
helm install suse/log-agent-rsyslog --name &lt;RELEASE_NAME&gt; --namespace kube-system --set server.host=${SERVER_HOST} --set server.port=${SERVER_PORT}</pre></div><p>Or if you have selected the Helm 3 alternative also see <a class="xref" href="_software_management.html#helm-tiller-install" title="3.1.2.1. Installing Helm">Section 3.1.2.1, “Installing Helm”</a>:</p><div class="verbatim-wrap highlight bash"><pre class="screen">helm repo add suse https://kubernetes-charts.suse.com
helm install &lt;RELEASE_NAME&gt; suse/log-agent-rsyslog --namespace kube-system --set server.host=${SERVER_HOST} --set server.port=${SERVER_PORT}</pre></div><div id="id-1.9.5.7.10" class="admonition note normal"><img class="symbol" alt="Note" title="Note" src="static/images/icon-note.png" /><h6>Note</h6><p>If not specified otherwise, Helm will install log agents with TCP as the default value for <code class="literal">server.protocol</code>.</p></div><div id="id-1.9.5.7.11" class="admonition warning normal"><img class="symbol" alt="Warning" title="Warning" src="static/images/icon-warning.png" /><h6>Warning</h6><p>Running Rsyslog in the host machine as well as in the Kubernetes cluster with <code class="literal">imjournal</code> and <code class="literal">imfile</code> input modules enabled may causes issues. Rsyslog can crash.
To avoid that, it is possible to disable the <code class="literal">imjournal</code> module in the helm chart installation adding the following command line argument:</p><div class="verbatim-wrap highlight bash"><pre class="screen">--set logs.osSystem.enabled=false</pre></div></div><p>After this step, all of the log agents will initialize then start to forward logs from each node to the configured remote Rsyslog server.</p><div class="itemizedlist "><ul class="itemizedlist"><li class="listitem "><p>To check the installation progress, use the <code class="literal">helm status</code> command:</p></li></ul></div><div class="verbatim-wrap"><pre class="screen">helm status &lt;RELEASE_NAME&gt;</pre></div><div class="itemizedlist "><ul class="itemizedlist"><li class="listitem "><p>To uninstall log agents, use the <code class="literal">helm delete</code> command:</p></li></ul></div><div class="verbatim-wrap"><pre class="screen">helm delete --purge &lt;RELEASE_NAME&gt;</pre></div><p>Or if you have selected the Helm 3 alternative also see <a class="xref" href="_software_management.html#helm-tiller-install" title="3.1.2.1. Installing Helm">Section 3.1.2.1, “Installing Helm”</a>:</p><div class="verbatim-wrap"><pre class="screen">helm uninstall &lt;RELEASE_NAME&gt;</pre></div></div><div class="sect2" id="_queuing"><div class="titlepage"><div><div><h3 class="title"><span class="number">7.4.5 </span><span xmlns:dm="urn:x-suse:ns:docmanager" class="name">Queuing</span> <a title="Permalink" class="permalink" href="_logging.html#_queuing">#</a></h3></div></div></div><p>Centralized Logging supports a configurable buffered queue.
This can be used to improve log processing throughput and eliminate possible data loss,
for instance after log agents shutdown, restart or in case of an unresponsive remote server.
The queue files are located under <code class="literal">/var/log/containers/{RELEASE_NAME}-log-agent-rsyslog</code> on every node in the cluster.
Queue files remain even after the log agents are deleted.</p><p>The buffered queue can be enabled/disabled with the following parameter:</p><p><code class="literal"><span class="strong"><strong>queue.enabled</strong></span></code>, default value = false</p><p>Setting <code class="literal">queue.enabled</code> to <code class="literal">false</code> means that data will be stored in-memory only.
Setting the parameter to <code class="literal">true</code> will set the data store to a mixture of in-memory and in-disk.
Data will then be stored in memory until the queue is filled up, after which storing is switched to disk.
Enabling the queue also automatically saves the queue to disk at service shutdown.</p><p>Additional parameters to define queue size and its disk usage are:</p><p><code class="literal"><span class="strong"><strong>queue.size</strong></span></code>, default value = 50000</p><p>This option sets the number of messages allowed for the in-memory queue.
This setting affects the Kubernetes cluster logs (<code class="literal">kubernetes-control-plane</code> and <code class="literal">kubernetes-USER_NAME-space</code>).</p><p><code class="literal"><span class="strong"><strong>queue.maxDiskSpace</strong></span></code>, default value = 2147483648</p><p>This option sets the maximum size allowed for disk storage (in bytes).
The storage is divided so that 20 percent of it is for journal logs and 80 percent for the remaining logs.</p></div><div class="sect2" id="log-optional_settings"><div class="titlepage"><div><div><h3 class="title"><span class="number">7.4.6 </span><span xmlns:dm="urn:x-suse:ns:docmanager" class="name">Optional settings</span> <a title="Permalink" class="permalink" href="_logging.html#log-optional_settings">#</a></h3></div></div></div><div id="id-1.9.5.9.2" class="admonition note normal"><img class="symbol" alt="Note" title="Note" src="static/images/icon-note.png" /><h6>Note</h6><p>Options with empty default values are set as not specified.</p></div><div class="informaltable"><table class="informaltable" border="1"><colgroup><col class="col_1" /><col class="col_2" /><col class="col_3" /></colgroup><thead><tr><th align="left" valign="top">Parameter</th><th align="left" valign="top">Function</th><th align="left" valign="top">Default value</th></tr></thead><tbody><tr><td align="left" valign="top"><p>image.repository</p></td><td align="left" valign="top"><p>specifies image repository to pull from</p></td><td align="left" valign="top"><p>registry.suse.com/caasp/v4.5/rsyslog</p></td></tr><tr><td align="left" valign="top"><p>image.tag</p></td><td align="left" valign="top"><p>specifies image tag to pull</p></td><td align="left" valign="top"><p>8.39.0</p></td></tr><tr><td align="left" valign="top"><p>kubernetesPodAnnotationsEnabled</p></td><td align="left" valign="top"><p>enables kubernetes meta annotations in pod logs</p></td><td align="left" valign="top"><p>false</p></td></tr><tr><td align="left" valign="top"><p>kubernetesPodLabelsEnabled</p></td><td align="left" valign="top"><p>enables kubernetes meta labels in pod logs</p></td><td align="left" valign="top"><p>false</p></td></tr><tr><td align="left" valign="top"><p>logs.kubernetesAudit.enabled</p></td><td align="left" valign="top"><p>enables Kubernetes audit logs</p></td><td align="left" valign="top"><p>true</p></td></tr><tr><td align="left" valign="top"><p>logs.kubernetesAudit.logDir</p></td><td align="left" valign="top"><p>Kubernetes audit log directory</p></td><td align="left" valign="top"><p>/var/log/kube-apiserver</p></td></tr><tr><td align="left" valign="top"><p>logs.kubernetesAudit.logFile</p></td><td align="left" valign="top"><p>Kubernetes audit log filename</p></td><td align="left" valign="top"><p>audit.log</p></td></tr><tr><td align="left" valign="top"><p>logs.kubernetesControlPlane.enabled</p></td><td align="left" valign="top"><p>enables Kubernetes control plane logs</p></td><td align="left" valign="top"><p>true</p></td></tr><tr><td align="left" valign="top"><p>logs.kubernetesSystem.enabled</p></td><td align="left" valign="top"><p>enables Kubernetes system logs (kubelet, crio)</p></td><td align="left" valign="top"><p>true</p></td></tr><tr><td align="left" valign="top"><p>logs.kubernetesUserNamespaces.enabled</p></td><td align="left" valign="top"><p>enables Kubernetes user namespaces logs</p></td><td align="left" valign="top"><p>false</p></td></tr><tr><td align="left" valign="top"><p>logs.kubernetesUserNamespaces.exclude</p></td><td align="left" valign="top"><p>excludes Kubernetes logs for specific namespaces</p></td><td align="left" valign="top"><p>- ""</p></td></tr><tr><td align="left" valign="top"><p>logs.osSystem.enabled</p></td><td align="left" valign="top"><p>enables OS logs (auditd, kernel, wicked, zypper)</p></td><td align="left" valign="top"><p>true</p></td></tr><tr><td align="left" valign="top"><p>persistStateInterval</p></td><td align="left" valign="top"><p>sets interval (number-of-messages) for data state persistency</p></td><td align="left" valign="top"><p>100</p></td></tr><tr><td align="left" valign="top"><p>queue.enabled</p></td><td align="left" valign="top"><p>enables Rsyslog queue</p></td><td align="left" valign="top"><p>false</p></td></tr><tr><td align="left" valign="top"><p>queue.maxDiskSpace</p></td><td align="left" valign="top"><p>sets maximum Rsyslog queue disk space in bytes</p></td><td align="left" valign="top"><p>2147483648</p></td></tr><tr><td align="left" valign="top"><p>queue.size</p></td><td align="left" valign="top"><p>sets Rsyslog queue size in bytes</p></td><td align="left" valign="top"><p>50000</p></td></tr><tr><td align="left" valign="top"><p>resources.limits.cpu</p></td><td align="left" valign="top"><p>sets CPU limits</p></td><td align="left" valign="top"> </td></tr><tr><td align="left" valign="top"><p>resources.limits.memory</p></td><td align="left" valign="top"><p>sets memory limits</p></td><td align="left" valign="top"><p>512 Mi</p></td></tr><tr><td align="left" valign="top"><p>resources.requests.cpu</p></td><td align="left" valign="top"><p>sets CPU for requests</p></td><td align="left" valign="top"><p>100m</p></td></tr><tr><td align="left" valign="top"><p>resources.requests.memory</p></td><td align="left" valign="top"><p>sets memory for requests</p></td><td align="left" valign="top"><p>512 Mi</p></td></tr><tr><td align="left" valign="top"><p>resumeInterval</p></td><td align="left" valign="top"><p>specifies time (seconds) after failure before retry is attempted</p></td><td align="left" valign="top"><p>30</p></td></tr><tr><td align="left" valign="top"><p>resumeRetryCount</p></td><td align="left" valign="top"><p>sets number of retries after first failure before the log is discarded. -1 is unlimited</p></td><td align="left" valign="top"><p>-1</p></td></tr><tr><td align="left" valign="top"><p>server.tls.clientCert</p></td><td align="left" valign="top"><p>sets TLS client certificate</p></td><td align="left" valign="top"> </td></tr><tr><td align="left" valign="top"><p>server.tls.clientKey</p></td><td align="left" valign="top"><p>sets TLS client key</p></td><td align="left" valign="top"> </td></tr><tr><td align="left" valign="top"><p>server.tls.enabled</p></td><td align="left" valign="top"><p>enables TLS</p></td><td align="left" valign="top"><p>false</p></td></tr><tr><td align="left" valign="top"><p>server.tls.permittedPeer</p></td><td align="left" valign="top"><p>sets a list of TLS/fingerprints or TLS/names with permission to access the server</p></td><td align="left" valign="top"> </td></tr><tr><td align="left" valign="top"><p>server.tls.rootCa</p></td><td align="left" valign="top"><p>specifies TLS root certificate authority</p></td><td align="left" valign="top"> </td></tr></tbody></table></div></div></div></div></div><div class="page-bottom"><div id="_bottom-navigation"><a class="nav-link" href="_monitoring.html"><span class="next-icon">→</span><span class="nav-label"><span class="number">Chapter 8 </span>Monitoring</span></a><a class="nav-link" href="_security.html"><span class="prev-icon">←</span><span class="nav-label"><span class="number">Chapter 6 </span>Security</span></a></div><div class="_share-print"><div class="online-contents share"><strong>Share this page: </strong><span class="share-buttons"><span class="_share-fb bottom-button">Facebook</span><span class="spacer"> • </span><span class="_share-in bottom-button">LinkedIn</span><span class="spacer"> • </span><span class="_share-tw bottom-button">Twitter</span><span class="spacer"> • </span><span class="_share-mail bottom-button">E-Mail</span></span></div><div class="print"><span class="_print-button bottom-button">Print this page</span></div><div class="clearme"></div></div></div></div><div id="_inward"></div></div><div id="_footer-wrap"><div id="_footer"><p>©
        2020 
        SUSE</p><ul><li><a href="https://jobs.suse.com/" target="_top">Careers</a></li><li><a href="https://www.suse.com/company/legal/" target="_top">Legal</a></li><li><a href="https://www.suse.com/company/about/" target="_top">About</a></li><li><a href="https://www.suse.com/contact/" target="_top">Contact Us</a></li></ul></div></div></body></html>