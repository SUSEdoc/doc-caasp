<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang=""><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>Deployment Scenarios | Architecture Description | SUSE CaaS Platform 4.5.2</title><meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" /><link rel="stylesheet" type="text/css" href="static/css/style.css" /><link rel="stylesheet" type="text/css" href="static/css/highlight.css" /><meta name="generator" content="DAPS 3.2.0 (https://opensuse.github.io/daps) using SUSE XSL Stylesheets 2.81.0 (based on DocBook XSL Stylesheets 1.79.2) - chunked" /><meta name="product-name" content="SUSE CaaS Platform" /><meta name="product-number" content="4.5.2" /><meta name="book-title" content="Architecture Description" /><meta name="chapter-title" content="Chapter 4. Deployment Scenarios" /><meta name="description" content="In Kubernetes there are two different machine types:" /><meta name="tracker-url" content="https://github.com/SUSE/doc-caasp/issues/new" /><meta name="tracker-type" content="gh" /><meta name="tracker-gh-labels" content="ArchitectureGuide" /><link rel="home" href="index.html" title="Architecture Description" /><link rel="up" href="index.html" title="Architecture Description" /><link rel="prev" href="id-the-suse-caas-platform-stack.html" title="Chapter 3. The SUSE CaaS Platform stack" /><link rel="next" href="id-glossary.html" title="Chapter 5. Glossary" />
<script type="text/javascript">

if ( window.location.protocol.toLowerCase() != 'file:' ) {
  document.write('<link rel="stylesheet" type="text/css" href="https://static.opensuse.org/fonts/fonts.css"></link>');
}
else {
  document.write('<link rel="stylesheet" type="text/css" href="static/css/fonts-onlylocal.css"></link>');
}

</script><noscript><link rel="stylesheet" type="text/css" href="https://static.opensuse.org/fonts/fonts.css" /></noscript><script src="static/js/jquery-1.10.2.min.js" type="text/javascript"></script><script src="static/js/script.js" type="text/javascript"></script><script src="static/js/highlight.min.js" type="text/javascript"></script><script>

$(document).ready(function() {
  $('.verbatim-wrap.highlight').each(function(i, block) {
    hljs.highlightBlock(block);
  });
});
hljs.configure({
  useBR: false
});

</script></head><body class="draft offline js-off" onload="$('#betawarn-button-wrap').toggle();if (document.cookie.length > 0) {if (document.cookie.indexOf('betawarn=closed') != -1){$('#betawarn').toggle()}};"><div id="betawarn" style="position:fixed;bottom:0;z-index:9025;background-color:#FDE8E8;padding:1em;margin-left:10%;margin-right:10%;display:block;border-top:.75em solid #E11;width:80%"><p style="color:#333;margin:1em 0;padding:0;">This is a draft document that was built and uploaded automatically. It may document beta software and be incomplete or even incorrect. <strong>Use this document at your own risk.</strong></p> <div id="betawarn-button-wrap" style="display:none;margin:0;padding:0;"><a href="#" onclick="$('#betawarn').toggle();var d=new Date();d.setTime(d.getTime()+(0.5*24*60*60*1000));document.cookie='betawarn=closed; expires='+d.toUTCString()+'; path=/'; return false;" style="color:#333;text-decoration:underline;float:left;margin-top:.5em;padding:1em;display:block;background-color:#FABEBE;">I understand this is a draft</a></div></div><div class="bypass-block"><a href="#_content">Jump to content</a><a href="#_bottom-navigation">Jump to page navigation: previous page [access key p]/next page [access key n]</a></div><div id="_outer-wrap"><div id="_white-bg" style="background-color: #E11;"><div id="_header"><div id="_logo"><img src="static/images/logo.png" alt="Logo" /></div><div class="crumbs"><a class="book-link" href="index.html" title="Architecture Description"><span class="book-icon">Architecture Description</span></a><span> › </span><a class="crumb" href="id-deployment-scenarios.html">Deployment Scenarios</a></div><div class="clearme"></div></div></div><div id="_toolbar-wrap"><div id="_toolbar"><div id="_toc-area" class="inactive"><a id="_toc-area-button" class="tool" title="Contents" accesskey="c" href="index.html"><span class="tool-spacer"><span class="toc-icon">Contents</span><span class="clearme"></span></span><span class="tool-label">Contents</span></a><div class="active-contents bubble-corner"></div><div class="active-contents bubble"><div class="bubble-container"><h6>Architecture Description</h6><div id="_bubble-toc"><ol><li class="inactive"><a href="pr01.html"><span class="number"> </span><span class="name"></span></a></li><li class="inactive"><a href="id-product-description.html"><span class="number">1 </span><span class="name">Product Description</span></a></li><li class="inactive"><a href="id-supported-platforms.html"><span class="number">2 </span><span class="name">Supported Platforms</span></a></li><li class="inactive"><a href="id-the-suse-caas-platform-stack.html"><span class="number">3 </span><span class="name">The SUSE CaaS Platform stack</span></a></li><li class="inactive"><a href="id-deployment-scenarios.html"><span class="number">4 </span><span class="name">Deployment Scenarios</span></a></li><li class="inactive"><a href="id-glossary.html"><span class="number">5 </span><span class="name">Glossary</span></a></li><li class="inactive"><a href="id-contributors.html"><span class="number">A </span><span class="name">Contributors</span></a></li><li class="inactive"><a href="id-gnu-licenses.html"><span class="number">B </span><span class="name">GNU Licenses</span></a></li></ol></div><div class="clearme"></div></div></div></div><div id="_nav-area" class="inactive"><div class="tool"><span class="nav-inner"><span class="tool-label">Navigation</span><a accesskey="p" class="tool-spacer" title="Chapter 3. The SUSE CaaS Platform stack" href="id-the-suse-caas-platform-stack.html"><span class="prev-icon">←</span></a><a accesskey="n" class="tool-spacer" title="Chapter 5. Glossary" href="id-glossary.html"><span class="next-icon">→</span></a></span></div></div></div></div><div id="_fixed-header-wrap" style="background-color: #E11;" class="inactive"><div id="_fixed-header"><div class="crumbs"><a class="book-link" href="index.html" title="Architecture Description"><span class="book-icon">Architecture Description</span></a><span> › </span><a class="crumb" href="id-deployment-scenarios.html">Deployment Scenarios</a></div><div class="buttons"><a class="top-button button" href="#">Top</a><div class="button"><a accesskey="p" class="tool-spacer" title="Chapter 3. The SUSE CaaS Platform stack" href="id-the-suse-caas-platform-stack.html"><span class="prev-icon">←</span></a><a accesskey="n" class="tool-spacer" title="Chapter 5. Glossary" href="id-glossary.html"><span class="next-icon">→</span></a></div><div class="clearme"></div></div><div class="clearme"></div></div></div><div id="_content" class="draft "><div class="documentation"><div class="chapter " id="id-deployment-scenarios"><div class="titlepage"><div><div class="version-info">Applies to  <span class="productname ">SUSE CaaS Platform</span> <span class="productnumber ">4.5.2</span></div><div><h1 class="title"><span class="number">4 </span><span xmlns:dm="urn:x-suse:ns:docmanager" class="name">Deployment Scenarios</span> <a title="Permalink" class="permalink" href="id-deployment-scenarios.html#">#</a></h1></div></div></div><div class="line"><div class="toc"><dl><dt><span class="section"><a href="id-deployment-scenarios.html#id-kubernetes-components"><span class="number">4.1 </span><span class="name">Kubernetes components</span></a></span></dt><dt><span class="section"><a href="id-deployment-scenarios.html#id-high-availability-considerations"><span class="number">4.2 </span><span class="name">High Availability Considerations</span></a></span></dt><dt><span class="section"><a href="id-deployment-scenarios.html#id-testing-poc"><span class="number">4.3 </span><span class="name">Testing / POC</span></a></span></dt><dt><span class="section"><a href="id-deployment-scenarios.html#id-default-deployment"><span class="number">4.4 </span><span class="name">Default Deployment</span></a></span></dt><dt><span class="section"><a href="id-deployment-scenarios.html#id-air-gapped-deployment"><span class="number">4.5 </span><span class="name">Air Gapped Deployment</span></a></span></dt><dt><span class="section"><a href="id-deployment-scenarios.html#id-control-plane-nodes-certificates"><span class="number">4.6 </span><span class="name">Control plane nodes certificates</span></a></span></dt><dt><span class="section"><a href="id-deployment-scenarios.html#id-worker-nodes-certificates"><span class="number">4.7 </span><span class="name">Worker nodes certificates</span></a></span></dt><dt><span class="section"><a href="id-deployment-scenarios.html#id-cluster-management"><span class="number">4.8 </span><span class="name">Cluster Management</span></a></span></dt></dl></div></div><div class="sect1" id="id-kubernetes-components"><div class="titlepage"><div><div><h2 class="title"><span class="number">4.1 </span><span xmlns:dm="urn:x-suse:ns:docmanager" class="name">Kubernetes components</span> <a title="Permalink" class="permalink" href="id-deployment-scenarios.html#id-kubernetes-components">#</a></h2></div></div></div><p>In Kubernetes there are two different machine types:</p><div class="itemizedlist "><ul class="itemizedlist"><li class="listitem "><p>Control plane (called "Masters")</p></li><li class="listitem "><p>Workers</p></li></ul></div><p>Control plane machines are responsible for running the main Kubernetes
components, this includes:</p><div class="itemizedlist "><ul class="itemizedlist"><li class="listitem "><p>etcd</p><div class="itemizedlist "><ul class="itemizedlist"><li class="listitem "><p>etcd is a distributed key value store. It’s where all data from the
cluster is persisted.</p></li></ul></div></li><li class="listitem "><p>API server</p><div class="itemizedlist "><ul class="itemizedlist"><li class="listitem "><p>The API server is responsible for serving all the API endpoints
that are used by the different Kubernetes components and clients.</p></li></ul></div></li><li class="listitem "><p>Main controllers</p><div class="itemizedlist "><ul class="itemizedlist"><li class="listitem "><p>The main controllers are responsible for most of the core
functionality from Kubernetes. When you create a Deployment, a
controller will be responsible for creating the ReplicaSet, and in
the same way, Pods will be created out of the ReplicaSet by a
controller as well.</p></li></ul></div></li><li class="listitem "><p>Scheduler</p><div class="itemizedlist "><ul class="itemizedlist"><li class="listitem "><p>The scheduler is the component that assigns pods to the different
nodes based on a number of restrictions and is aware of individual
and collective resource requirements.</p></li></ul></div></li></ul></div><p>Both the control plane and worker nodes run an agent called kubelet
and a container runtime (cri-o). The kubelet is responsible for
talking to the container runtime, managing the Pod lifecycle that were
assigned to this machine. The container runtime, is the component that
will create the containers themselves.</p></div><div class="sect1" id="id-high-availability-considerations"><div class="titlepage"><div><div><h2 class="title"><span class="number">4.2 </span><span xmlns:dm="urn:x-suse:ns:docmanager" class="name">High Availability Considerations</span> <a title="Permalink" class="permalink" href="id-deployment-scenarios.html#id-high-availability-considerations">#</a></h2></div></div></div><p>The default deployment aims for a "High Availability" (HA) Kubernetes service.
In order to achieve HA it’s required to run several control planes.</p><p>Not any number greater than 1 is optimal for HA, and this can impact
the fault tolerance. The reason for this is the etcd distributed key
value store:</p><div class="informaltable"><table class="informaltable" border="1" width="40%"><colgroup><col class="col_1" /><col class="col_2" /></colgroup><thead><tr><th align="center" valign="top">Cluster size</th><th align="center" valign="top">Failure Tolerance</th></tr></thead><tbody><tr><td align="center" valign="top"><p>1</p></td><td align="center" valign="top"><p>0</p></td></tr><tr><td align="center" valign="top"><p>2</p></td><td align="center" valign="top"><p>0</p></td></tr><tr><td align="center" valign="top"><p>3</p></td><td align="center" valign="top"><p>1</p></td></tr><tr><td align="center" valign="top"><p>4</p></td><td align="center" valign="top"><p>1</p></td></tr><tr><td align="center" valign="top"><p>5</p></td><td align="center" valign="top"><p>2</p></td></tr><tr><td align="center" valign="top"><p>6</p></td><td align="center" valign="top"><p>2</p></td></tr><tr><td align="center" valign="top"><p>7</p></td><td align="center" valign="top"><p>3</p></td></tr><tr><td align="center" valign="top"><p>8</p></td><td align="center" valign="top"><p>3</p></td></tr><tr><td align="center" valign="top"><p>9</p></td><td align="center" valign="top"><p>4</p></td></tr></tbody></table></div><p>Given that etcd runs only on the control plane nodes, having 2
control plane nodes provides a HA solution that is fault tolerant for the
Kubernetes components but <span class="strong"><strong>not</strong></span> for the etcd cluster. If one of those two
control planes nodes goes down, the cluster storage will be unavailable, and
the cluster won’t be able to accept new changes (already running
workloads won’t suffer any changes, but the cluster won’t be able to
react to new changes from that point on).</p><p>In order to provide a fault tolerant HA environment you must
have an odd number of control planes.</p><p>A minimum of <code class="literal">3</code> master nodes is required in order to tolerate a complete loss
of one control plane node.</p><p>Control planes are only part of the whole picture. Most components will
talk to the API Server, and the API Server must be exposed on all master nodes
to communicate to the clients and the rest of the cluster components.</p><div class="sect2" id="id-load-balancer"><div class="titlepage"><div><div><h3 class="title"><span class="number">4.2.1 </span><span xmlns:dm="urn:x-suse:ns:docmanager" class="name">Load Balancer</span> <a title="Permalink" class="permalink" href="id-deployment-scenarios.html#id-load-balancer">#</a></h3></div></div></div><p>The most reasonable way to achieve fault tolerant exposure of the API servers is
a load balancer. The load balancer will point to all the control plane nodes.
The clients and Kubernetes components will talk to the load balancer: which will
perform health checks against all the control planes and maintain an active pool
of backends.</p><p>If only one load balancer is deployed this creates a single point of failure.
For a complete HA solution, more than one load balancer is required.</p><div id="id-1.6.3.9.4" class="admonition important normal"><img class="symbol" alt="Important" title="Important" src="static/images/icon-important.png" /><h6>Important</h6><p>If your environment only contains one load balancer it cannot be considered
highly available or fault tolerant, since the load balancer becomes
the single point of failure.</p></div></div></div><div class="sect1" id="id-testing-poc"><div class="titlepage"><div><div><h2 class="title"><span class="number">4.3 </span><span xmlns:dm="urn:x-suse:ns:docmanager" class="name">Testing / POC</span> <a title="Permalink" class="permalink" href="id-deployment-scenarios.html#id-testing-poc">#</a></h2></div></div></div><p>The smallest possible deployment comes without a load balancer and the minimum
amount of nodes to be considered a cluster. This deployment type is in no way
suitable for production use and has no fault tolerance whatsoever.</p><div class="itemizedlist "><ul class="itemizedlist"><li class="listitem "><p>One master machine</p></li><li class="listitem "><p>One worker machine</p></li></ul></div><p>Despite not recommended, it’s also possible to create a POC or testing
environment with a single master machine.</p></div><div class="sect1" id="id-default-deployment"><div class="titlepage"><div><div><h2 class="title"><span class="number">4.4 </span><span xmlns:dm="urn:x-suse:ns:docmanager" class="name">Default Deployment</span> <a title="Permalink" class="permalink" href="id-deployment-scenarios.html#id-default-deployment">#</a></h2></div></div></div><p>The default minimal HA scenario requires 5 nodes:</p><div class="itemizedlist "><ul class="itemizedlist"><li class="listitem "><p>2 Load Balancers</p></li><li class="listitem "><p>3 Masters</p></li></ul></div><p>plus, the number of workers necessary to host your workloads.</p><div class="itemizedlist "><ul class="itemizedlist"><li class="listitem "><p>Requires:</p><div class="itemizedlist "><ul class="itemizedlist"><li class="listitem "><p>Persistent IP addresses on all nodes.</p></li><li class="listitem "><p>NTP server provided on the host network.</p></li><li class="listitem "><p>DNS entry that resolves to the load balancer VIP.</p></li><li class="listitem "><p>LDAP server or OIDC provider (Active Directory, GitLab, GitHub, etc.)</p></li></ul></div></li><li class="listitem "><p>(Optional) "Infrastructure node"</p><div class="itemizedlist "><ul class="itemizedlist"><li class="listitem "><p>LDAP server if LDAP integration is desired and your organization
does not have an LDAP server.</p></li><li class="listitem "><p>Local RMT server to synchronize RPMs.</p></li><li class="listitem "><p>Local mirror of the SUSE container registry (registry.suse.com)</p></li><li class="listitem "><p>Local mirror of the SUSE helm chart repository.</p></li></ul></div></li></ul></div></div><div class="sect1" id="id-air-gapped-deployment"><div class="titlepage"><div><div><h2 class="title"><span class="number">4.5 </span><span xmlns:dm="urn:x-suse:ns:docmanager" class="name">Air Gapped Deployment</span> <a title="Permalink" class="permalink" href="id-deployment-scenarios.html#id-air-gapped-deployment">#</a></h2></div></div></div><p>In air gapped environments, the "Infrastructure node" is mandatory, as
it’s needed to have a local RMT server mirroring the SUSE CaaS Platform
repositories, a mirror of the SUSE container registry and a mirror of
the SUSE helm chart repository.</p></div><div class="sect1" id="id-control-plane-nodes-certificates"><div class="titlepage"><div><div><h2 class="title"><span class="number">4.6 </span><span xmlns:dm="urn:x-suse:ns:docmanager" class="name">Control plane nodes certificates</span> <a title="Permalink" class="permalink" href="id-deployment-scenarios.html#id-control-plane-nodes-certificates">#</a></h2></div></div></div><p>Certificates are stored under <code class="literal">/etc/kubernetes/pki</code> on the control plane nodes.</p><div class="sect2" id="id-ca-certificates"><div class="titlepage"><div><div><h3 class="title"><span class="number">4.6.1 </span><span xmlns:dm="urn:x-suse:ns:docmanager" class="name">CA certificates</span> <a title="Permalink" class="permalink" href="id-deployment-scenarios.html#id-ca-certificates">#</a></h3></div></div></div><div class="informaltable"><table class="informaltable" border="1"><colgroup><col class="col_1" /><col class="col_2" /><col class="col_3" /><col class="col_4" /></colgroup><thead><tr><th align="left" valign="top">Path</th><th align="left" valign="top">Valid for</th><th align="left" valign="top">Common Name</th><th align="left" valign="top">Description</th></tr></thead><tbody><tr><td align="left" valign="top"><p>ca.crt</p></td><td align="left" valign="top"><p>1 year</p></td><td align="left" valign="top"><p>kubernetes</p></td><td align="left" valign="top"><p>Kubernetes global CA</p></td></tr><tr><td align="left" valign="top"><p>etcd/ca.crt</p></td><td align="left" valign="top"><p>1 year</p></td><td align="left" valign="top"><p>etcd-ca</p></td><td align="left" valign="top"><p>etcd global CA</p></td></tr></tbody></table></div></div><div class="sect2" id="id-ca-certificate-keys"><div class="titlepage"><div><div><h3 class="title"><span class="number">4.6.2 </span><span xmlns:dm="urn:x-suse:ns:docmanager" class="name">CA certificate keys</span> <a title="Permalink" class="permalink" href="id-deployment-scenarios.html#id-ca-certificate-keys">#</a></h3></div></div></div><div class="informaltable"><table class="informaltable" border="1"><colgroup><col class="col_1" /><col class="col_2" /><col class="col_3" /></colgroup><thead><tr><th align="left" valign="top">Path</th><th align="left" valign="top">Key type</th><th align="left" valign="top">Key length (bits)</th></tr></thead><tbody><tr><td align="left" valign="top"><p>ca.key</p></td><td align="left" valign="top"><p>RSA</p></td><td align="left" valign="top"><p>2048</p></td></tr><tr><td align="left" valign="top"><p>etcd/ca.key</p></td><td align="left" valign="top"><p>RSA</p></td><td align="left" valign="top"><p>2048</p></td></tr></tbody></table></div></div><div class="sect2" id="id-certificates"><div class="titlepage"><div><div><h3 class="title"><span class="number">4.6.3 </span><span xmlns:dm="urn:x-suse:ns:docmanager" class="name">Certificates</span> <a title="Permalink" class="permalink" href="id-deployment-scenarios.html#id-certificates">#</a></h3></div></div></div><div class="informaltable"><table class="informaltable" border="1"><colgroup><col class="col_1" /><col class="col_2" /><col class="col_3" /><col class="col_4" /><col class="col_5" /><col class="col_6" /><col class="col_7" /></colgroup><thead><tr><th align="left" valign="top">Path</th><th align="left" valign="top">Valid for</th><th align="left" valign="top">CN</th><th align="left" valign="top">Parent CA</th><th align="left" valign="top">O (Subject)</th><th align="left" valign="top">Kind</th><th align="left" valign="top">Extra SANs</th></tr></thead><tbody><tr><td align="left" valign="top"><p>apiserver-kubelet-client.crt</p></td><td align="left" valign="top"><p>1 year</p></td><td align="left" valign="top"><p>kube-apiserver-kubelet-client</p></td><td align="left" valign="top"><p>kubernetes</p></td><td align="left" valign="top"><p>system:masters</p></td><td align="left" valign="top"><p>client</p></td><td align="left" valign="top"><p>-</p></td></tr><tr><td align="left" valign="top"><p>etcd/healthcheck-client.crt</p></td><td align="left" valign="top"><p>1 year</p></td><td align="left" valign="top"><p>kube-etcd-healthcheck-client</p></td><td align="left" valign="top"><p>etcd-ca</p></td><td align="left" valign="top"><p>system:masters</p></td><td align="left" valign="top"><p>client</p></td><td align="left" valign="top"><p>-</p></td></tr><tr><td align="left" valign="top"><p>etcd/server.crt</p></td><td align="left" valign="top"><p>1 year</p></td><td align="left" valign="top"><p>master</p></td><td align="left" valign="top"><p>etcd-ca</p></td><td align="left" valign="top"><p>-</p></td><td align="left" valign="top"><p>server</p></td><td align="left" valign="top"><p>Hostname, IP address, localhost, 127.0.0.1, 0:0:0:0:0:0:0:1</p></td></tr><tr><td align="left" valign="top"><p>etcd/peer.crt</p></td><td align="left" valign="top"><p>1 year</p></td><td align="left" valign="top"><p>master</p></td><td align="left" valign="top"><p>etcd-ca</p></td><td align="left" valign="top"><p>-</p></td><td align="left" valign="top"><p>server, client</p></td><td align="left" valign="top"><p>Hostname, IP address, localhost, 127.0.0.1, 0:0:0:0:0:0:0:1</p></td></tr><tr><td align="left" valign="top"><p>apiserver.crt</p></td><td align="left" valign="top"><p>1 year</p></td><td align="left" valign="top"><p>kube-apiserver</p></td><td align="left" valign="top"><p>kubernetes</p></td><td align="left" valign="top"><p>-</p></td><td align="left" valign="top"><p>server</p></td><td align="left" valign="top"><p>Hostname, IP address, Control Plane Address, kubernetes, kubernetes.default, kubernetes.default.svc, kubernetes.default.svc.cluster.local</p></td></tr><tr><td align="left" valign="top"><p>apiserver-etcd-client.crt</p></td><td align="left" valign="top"><p>1 year</p></td><td align="left" valign="top"><p>kube-apiserver-etcd-client</p></td><td align="left" valign="top"><p>etcd-ca</p></td><td align="left" valign="top"><p>system:masters</p></td><td align="left" valign="top"><p>client</p></td><td align="left" valign="top"><p>-</p></td></tr></tbody></table></div></div><div class="sect2" id="id-certificate-keys"><div class="titlepage"><div><div><h3 class="title"><span class="number">4.6.4 </span><span xmlns:dm="urn:x-suse:ns:docmanager" class="name">Certificate keys</span> <a title="Permalink" class="permalink" href="id-deployment-scenarios.html#id-certificate-keys">#</a></h3></div></div></div><div class="informaltable"><table class="informaltable" border="1"><colgroup><col class="col_1" /><col class="col_2" /><col class="col_3" /></colgroup><thead><tr><th align="left" valign="top">Path</th><th align="center" valign="top">Key type</th><th align="center" valign="top">Key length (bits)</th></tr></thead><tbody><tr><td align="left" valign="top"><p>apiserver.key</p></td><td align="center" valign="top"><p>RSA</p></td><td align="center" valign="top"><p>2048</p></td></tr><tr><td align="left" valign="top"><p>apiserver-kubelet-client.key</p></td><td align="center" valign="top"><p>RSA</p></td><td align="center" valign="top"><p>2048</p></td></tr><tr><td align="left" valign="top"><p>apiserver-etcd-client.key</p></td><td align="center" valign="top"><p>RSA</p></td><td align="center" valign="top"><p>2048</p></td></tr><tr><td align="left" valign="top"><p>etcd/server.key</p></td><td align="center" valign="top"><p>RSA</p></td><td align="center" valign="top"><p>2048</p></td></tr><tr><td align="left" valign="top"><p>etcd/healthcheck-client.key</p></td><td align="center" valign="top"><p>RSA</p></td><td align="center" valign="top"><p>2048</p></td></tr><tr><td align="left" valign="top"><p>etcd/peer.key</p></td><td align="center" valign="top"><p>RSA</p></td><td align="center" valign="top"><p>2048</p></td></tr></tbody></table></div><p>Please refer to the <a class="link" href="https://documentation.suse.com/suse-caasp/4.5/html/caasp-admin/_security.html#_certificates" target="_blank">SUSE CaaS Platform Administration Guide</a> for more information on the rotation of certificates.</p></div></div><div class="sect1" id="id-worker-nodes-certificates"><div class="titlepage"><div><div><h2 class="title"><span class="number">4.7 </span><span xmlns:dm="urn:x-suse:ns:docmanager" class="name">Worker nodes certificates</span> <a title="Permalink" class="permalink" href="id-deployment-scenarios.html#id-worker-nodes-certificates">#</a></h2></div></div></div><p>The CA certificate for the cluster is stored under /etc/kubernetes/pki
on the worker nodes.</p><p>When a new worker machine joins the cluster, the kubelet performs a
TLS bootstrap. It requests a certificate to the cluster using a
bootstrap token, this request is automatically approved by the
cluster, and a certificate is created. The new worker downloads this
certificate and writes it to disk, so the kubelet uses this
client certificate from now on to contact the apiserver.</p><div class="sect2" id="id-ca-certificates-2"><div class="titlepage"><div><div><h3 class="title"><span class="number">4.7.1 </span><span xmlns:dm="urn:x-suse:ns:docmanager" class="name">CA certificates</span> <a title="Permalink" class="permalink" href="id-deployment-scenarios.html#id-ca-certificates-2">#</a></h3></div></div></div><p>The CA certificate is downloaded from the cluster (present in the
cluster-info secret inside the kube-public namespace). Since this
information is public, there’s no restriction to download the CA
certificate.</p><p>This certificate is saved under /etc/kubernetes/pki/ca.crt.</p><div class="informaltable"><table class="informaltable" border="1"><colgroup><col class="col_1" /><col class="col_2" /><col class="col_3" /><col class="col_4" /></colgroup><thead><tr><th align="left" valign="top">Path</th><th align="left" valign="top">Valid for</th><th align="left" valign="top">Common Name</th><th align="left" valign="top">Description</th></tr></thead><tbody><tr><td align="left" valign="top"><p>/var/lib/kubelet/pki/kubelet.crt</p></td><td align="left" valign="top"><p>1 year</p></td><td align="left" valign="top"><p>worker-ca@random-id</p></td><td align="left" valign="top"><p>Kubelet CA</p></td></tr></tbody></table></div></div><div class="sect2" id="id-ca-certificate-keys-2"><div class="titlepage"><div><div><h3 class="title"><span class="number">4.7.2 </span><span xmlns:dm="urn:x-suse:ns:docmanager" class="name">CA certificate keys</span> <a title="Permalink" class="permalink" href="id-deployment-scenarios.html#id-ca-certificate-keys-2">#</a></h3></div></div></div><div class="informaltable"><table class="informaltable" border="1"><colgroup><col class="col_1" /><col class="col_2" /><col class="col_3" /></colgroup><thead><tr><th align="left" valign="top">Path</th><th align="center" valign="top">Key type</th><th align="center" valign="top">Key length (bits)</th></tr></thead><tbody><tr><td align="left" valign="top"><p>kubelet.key</p></td><td align="center" valign="top"><p>RSA</p></td><td align="center" valign="top"><p>2048</p></td></tr></tbody></table></div></div><div class="sect2" id="id-certificates-2"><div class="titlepage"><div><div><h3 class="title"><span class="number">4.7.3 </span><span xmlns:dm="urn:x-suse:ns:docmanager" class="name">Certificates</span> <a title="Permalink" class="permalink" href="id-deployment-scenarios.html#id-certificates-2">#</a></h3></div></div></div><p>Certificates are stored under <code class="literal">/var/lib/kubelet/pki</code> on the worker nodes.</p><div class="informaltable"><table class="informaltable" border="1"><colgroup><col class="col_1" /><col class="col_2" /><col class="col_3" /><col class="col_4" /><col class="col_5" /><col class="col_6" /><col class="col_7" /><col class="col_8" /></colgroup><thead><tr><th align="left" valign="top">Path</th><th align="left" valign="top">Valid for</th><th align="left" valign="top">CN</th><th align="left" valign="top">Parent CA</th><th align="left" valign="top">O (Subject)</th><th align="left" valign="top">Kind</th><th align="left" valign="top">Extra SANs</th><th align="left" valign="top">Notes</th></tr></thead><tbody><tr><td align="left" valign="top"><p>kubelet-client-current.pem</p></td><td align="left" valign="top"><p>1 year</p></td><td align="left" valign="top"><p>system:node:worker</p></td><td align="left" valign="top"><p>kubernetes</p></td><td align="left" valign="top"><p>system:nodes</p></td><td align="left" valign="top"><p>client</p></td><td align="left" valign="top"><p>-</p></td><td align="left" valign="top"><p>Symlink to kubelet-client-timestamp.pem</p></td></tr><tr><td align="left" valign="top"><p>kubelet.crt</p></td><td align="left" valign="top"><p>1 year</p></td><td align="left" valign="top"><p>worker@random-id</p></td><td align="left" valign="top"><p>worker-ca@random-id</p></td><td align="left" valign="top"><p>-</p></td><td align="left" valign="top"><p>server</p></td><td align="left" valign="top"><p>Hostname</p></td><td align="left" valign="top"><p>-</p></td></tr></tbody></table></div></div><div class="sect2" id="id-certificate-keys-2"><div class="titlepage"><div><div><h3 class="title"><span class="number">4.7.4 </span><span xmlns:dm="urn:x-suse:ns:docmanager" class="name">Certificate keys</span> <a title="Permalink" class="permalink" href="id-deployment-scenarios.html#id-certificate-keys-2">#</a></h3></div></div></div><div class="informaltable"><table class="informaltable" border="1"><colgroup><col class="col_1" /><col class="col_2" /><col class="col_3" /></colgroup><thead><tr><th align="left" valign="top">Path</th><th align="center" valign="top">Key type</th><th align="center" valign="top">Key length (bits)</th></tr></thead><tbody><tr><td align="left" valign="top"><p>kubelet.key</p></td><td align="center" valign="top"><p>RSA</p></td><td align="center" valign="top"><p>2048</p></td></tr></tbody></table></div><p>Please refer to the <a class="link" href="https://documentation.suse.com/suse-caasp/4.5/html/caasp-admin/_security.html#_certificates" target="_blank">SUSE CaaS Platform Administration Guide</a> for more information on the rotation of certificates.</p></div></div><div class="sect1" id="id-cluster-management"><div class="titlepage"><div><div><h2 class="title"><span class="number">4.8 </span><span xmlns:dm="urn:x-suse:ns:docmanager" class="name">Cluster Management</span> <a title="Permalink" class="permalink" href="id-deployment-scenarios.html#id-cluster-management">#</a></h2></div></div></div><p>Cluster lifecycle is managed using <code class="literal">skuba</code>. It enables you to
manage nodes in your cluster:</p><div class="itemizedlist "><ul class="itemizedlist"><li class="listitem "><p>Bootstrap a new cluster</p></li><li class="listitem "><p>Join new machines to the cluster</p><div class="itemizedlist "><ul class="itemizedlist"><li class="listitem "><p>Master nodes</p></li><li class="listitem "><p>Worker nodes</p></li></ul></div></li><li class="listitem "><p>Remove nodes from the cluster</p><div class="itemizedlist "><ul class="itemizedlist"><li class="listitem "><p>Master nodes</p></li><li class="listitem "><p>Worker nodes</p></li></ul></div></li></ul></div><div class="sect2" id="id-creating-a-cluster-definition"><div class="titlepage"><div><div><h3 class="title"><span class="number">4.8.1 </span><span xmlns:dm="urn:x-suse:ns:docmanager" class="name">Creating a cluster definition</span> <a title="Permalink" class="permalink" href="id-deployment-scenarios.html#id-creating-a-cluster-definition">#</a></h3></div></div></div><p>Creating a cluster definition is the first step to initialize your
cluster. You can execute this task as follows:</p><div class="verbatim-wrap"><pre class="screen">~/clusters$ skuba cluster init --control-plane 10.86.3.149 &lt;CLUSTER_NAME&gt;
[init] configuration files written to /home/my-user/clusters/&lt;CLUSTER_NAME&gt;</pre></div><p>This operation happens strictly offline and will generate a folder
structure like the following:</p><div class="verbatim-wrap"><pre class="screen">~/clusters &gt; tree &lt;CLUSTER_NAME&gt;/
&lt;CLUSTER_NAME&gt;/
├── addons
│   ├── cilium
│   │   ├── base
│   │   │   └── cilium.yaml
│   │   └── patches
│   ├── cri
│   │   └── default_flags
│   ├── dex
│   │   ├── base
│   │   │   └── dex.yaml
│   │   └── patches
│   ├── gangway
│   │   ├── base
│   │   │   └── gangway.yaml
│   │   └── patches
│   ├── kured
│   │   ├── base
│   │   │   └── kured.yaml
│   │   └── patches
│   └── psp
│       ├── base
│       │   └── psp.yaml
│       └── patches
├── kubeadm-init.conf
└── kubeadm-join.conf.d
    ├── master.conf.template
    └── worker.conf.template

18 directories, 9 files</pre></div><p>At this point, you can inspect all generated files, and if desired you
can experiment by providing your custom settings using with declarative
management of Kubernetes objects using <a class="link" href="https://kustomize.io/" target="_blank">Kustomize</a>.</p><p>To provide custom settings of the form of strategic merge patch or a JSON 6902 patch go to addons patches directory for example <code class="literal">addons/dex/pathes</code> and create custom settings file for example <code class="literal">addons/dex/pathes/custom.yaml</code></p><p>Read <a class="link" href="https://github.com/kubernetes-sigs/kustomize/blob/master/docs/glossary.md#patchstrategicmerge" target="_blank">https://github.com/kubernetes-sigs/kustomize/blob/master/docs/glossary.md#patchstrategicmerge</a> and <a class="link" href="https://github.com/kubernetes-sigs/kustomize/blob/master/docs/glossary.md#patchjson6902" target="_blank">https://github.com/kubernetes-sigs/kustomize/blob/master/docs/glossary.md#patchjson6902</a> to get more information.</p><div class="verbatim-wrap"><pre class="screen">apiVersion: apps/v1
kind: Deployment
metadata:
  name: oidc-dex
  namespace: kube-system
spec:
  replicas: 1
  revisionHistoryLimit: 5</pre></div></div><div class="sect2" id="id-bootstrapping-the-first-node-of-the-cluster"><div class="titlepage"><div><div><h3 class="title"><span class="number">4.8.2 </span><span xmlns:dm="urn:x-suse:ns:docmanager" class="name">Bootstrapping the first node of the cluster</span> <a title="Permalink" class="permalink" href="id-deployment-scenarios.html#id-bootstrapping-the-first-node-of-the-cluster">#</a></h3></div></div></div><p>From within your cluster definition folder, you can bootstrap your
first master machine:</p><div class="verbatim-wrap"><pre class="screen">~/clusters/&lt;CLUSTER_NAME&gt;$ skuba node bootstrap --user sles --sudo --target &lt;IP_ADDRESS/FQDN&gt; &lt;NODENAME&gt;</pre></div><p>This operation will read the <code class="literal">kubeadm-init.conf</code> file inside your
cluster definition, will forcefully set certain settings to the ones
required by SUSE CaaS Platform and will bootstrap the node remotely.</p><p>Prior to bootstrap it’s possible for you to tweak the configuration
that will be used to create the cluster. You can:</p><div class="itemizedlist "><ul class="itemizedlist"><li class="listitem "><p>Tweak the default Pod Security Policies or create extra ones. If you
place extra Pod Security Policies in the <code class="literal">addons/psp/base</code> folder, those
will be created as well when the bootstrap is completed. You can
also modify the default ones and/or remove them.</p></li><li class="listitem "><p>Inspect the <code class="literal">kubeadm-init.conf</code> and set extra configuration settings
supported by <code class="literal">kubeadm</code>. The latest supported version is v1beta1.</p></li></ul></div><p>After this operation has completed several modifications will have
happened on your cluster definition folder:</p><div class="itemizedlist "><ul class="itemizedlist"><li class="listitem "><p>The <code class="literal">kubeadm-init.conf</code> file will contain the final complete
contents used to bootstrap the node, so you can inspect what
exact configuration was used to bootstrap the node.</p></li><li class="listitem "><p>An <code class="literal">admin.conf</code> file will be created on your cluster definition file,
this is a <code class="literal">kubeconfig</code> file that has complete access to the cluster
and uses client certificates for authenticating against the cluster.</p></li></ul></div></div><div class="sect2" id="id-adding-master-nodes-to-the-cluster"><div class="titlepage"><div><div><h3 class="title"><span class="number">4.8.3 </span><span xmlns:dm="urn:x-suse:ns:docmanager" class="name">Adding master nodes to the cluster</span> <a title="Permalink" class="permalink" href="id-deployment-scenarios.html#id-adding-master-nodes-to-the-cluster">#</a></h3></div></div></div><p>Adding new master nodes to the cluster can be achieved by executing
the following <code class="literal">skuba</code> command:</p><div class="verbatim-wrap"><pre class="screen">~/clusters/&lt;CLUSTER_NAME&gt;$ skuba node join --role master --user sles --sudo --target &lt;IP_ADDRESS/FQDN&gt; &lt;NODENAME&gt;</pre></div><p>This operation will try to read the <code class="literal">kubeadm-join.conf.d/&lt;IP_ADDRESS/FQDN&gt;.conf</code>
file if it exists. This allows you to set specific settings for this
new node prior to joining it (a similar procedure to how
<code class="literal">kubeadm-init.conf</code> file behaves when bootstrapping). If this file
does not exist, <code class="literal">skuba</code> will read the <code class="literal">kubeadm-join.conf.d/master.conf.template</code>
instead and will create this file automatically when <code class="literal">skuba node
join</code> is called.</p><p>This operation will increase the <code class="literal">etcd</code> member count by one, so it’s
recommended to always keep an odd number of master nodes because as
described in previous sections an even number of nodes does not
improve fault tolerance.</p></div><div class="sect2" id="id-adding-worker-nodes-to-the-cluster"><div class="titlepage"><div><div><h3 class="title"><span class="number">4.8.4 </span><span xmlns:dm="urn:x-suse:ns:docmanager" class="name">Adding worker nodes to the cluster</span> <a title="Permalink" class="permalink" href="id-deployment-scenarios.html#id-adding-worker-nodes-to-the-cluster">#</a></h3></div></div></div><p>Adding new worker nodes to the cluster can be achieved by executing
the following <code class="literal">skuba</code> command:</p><div class="verbatim-wrap"><pre class="screen">~/clusters/&lt;CLUSTER_NAME&gt;$ skuba node join --role worker --user sles --sudo --target &lt;IP_ADDRESS/FQDN&gt; &lt;NODENAME&gt;</pre></div><p>This operation will try to read the <code class="literal">kubeadm-join.conf.d/&lt;IP_ADDRESS/FQDN&gt;.conf</code>
file if it exists. This allows you to set specific settings for this
new node prior to joining it (a similar procedure to how
<code class="literal">kubeadm-init.conf</code> file behaves when bootstrapping). If this file
does not exist, <code class="literal">skuba</code> will read the <code class="literal">kubeadm-join.conf.d/worker.conf.template</code>
instead and will create this file automatically when <code class="literal">skuba node
join</code> is called.</p></div><div class="sect2" id="id-removing-nodes-from-the-cluster"><div class="titlepage"><div><div><h3 class="title"><span class="number">4.8.5 </span><span xmlns:dm="urn:x-suse:ns:docmanager" class="name">Removing nodes from the cluster</span> <a title="Permalink" class="permalink" href="id-deployment-scenarios.html#id-removing-nodes-from-the-cluster">#</a></h3></div></div></div><p>Removing nodes from the cluster requires you to execute <code class="literal">skuba</code>
from a folder containing an <code class="literal">admin.conf</code> file, because this operation
is performed exclusively using Kubernetes, and no access to the node
being removed or other nodes for that matter is required.</p><p>For removing a node, the following command has to be executed:</p><div class="verbatim-wrap"><pre class="screen">~/clusters/&lt;CLUSTER_NAME&gt;$ skuba node remove &lt;NODENAME&gt;</pre></div><p>If the node to be removed is a master, specific actions will be
automatically executed, like removing the etcd member from the cluster.
Note that this node cannot be added back to the cluster or any other
skuba-initiated kubernetes cluster without reinstalling first.</p></div></div></div></div><div class="page-bottom"><div id="_bottom-navigation"><a class="nav-link" href="id-glossary.html"><span class="next-icon">→</span><span class="nav-label"><span class="number">Chapter 5 </span>Glossary</span></a><a class="nav-link" href="id-the-suse-caas-platform-stack.html"><span class="prev-icon">←</span><span class="nav-label"><span class="number">Chapter 3 </span>The SUSE CaaS Platform stack</span></a></div><div class="_share-print"><div class="online-contents share"><strong>Share this page: </strong><span class="share-buttons"><span class="_share-fb bottom-button">Facebook</span><span class="spacer"> • </span><span class="_share-in bottom-button">LinkedIn</span><span class="spacer"> • </span><span class="_share-tw bottom-button">Twitter</span><span class="spacer"> • </span><span class="_share-mail bottom-button">E-Mail</span></span></div><div class="print"><span class="_print-button bottom-button">Print this page</span></div><div class="clearme"></div></div></div></div><div id="_inward"></div></div><div id="_footer-wrap"><div id="_footer"><p>©
        2021 
        SUSE</p><ul><li><a href="https://jobs.suse.com/" target="_top">Careers</a></li><li><a href="https://www.suse.com/company/legal/" target="_top">Legal</a></li><li><a href="https://www.suse.com/company/about/" target="_top">About</a></li><li><a href="https://www.suse.com/contact/" target="_top">Contact Us</a></li></ul></div></div></body></html>